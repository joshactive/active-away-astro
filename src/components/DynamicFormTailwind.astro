---
interface Props {
  formData: any;
  formSlug?: string;
  heading?: string;
  subtitle?: string;
  privacyNote?: string;
  formId?: string;
  showOtherOptions?: boolean;
  hideOtherOptions?: boolean;
}

const {
  formData,
  formSlug,
  heading,
  subtitle,
  privacyNote,
  formId,
  showOtherOptions,
  hideOtherOptions
} = Astro.props;

if (!formData) {
  console.warn('DynamicFormTailwind: formData is required');
}

const resolvedFormSlug = formSlug || formData?.slug || 'form';
const sanitizedFormIdBase = (formId || `dynamic-form-${resolvedFormSlug}`)
  .replace(/[^a-zA-Z0-9-_]/g, '-');

const successMessageId = `${sanitizedFormIdBase}-success`;
const errorMessageId = `${sanitizedFormIdBase}-error`;
const errorTextId = `${sanitizedFormIdBase}-error-text`;
const submitTextId = `${sanitizedFormIdBase}-submit-text`;

const computedHeading = heading !== undefined ? heading : (formData?.formHeading || formData?.title || 'Get in touch');
const computedSubtitle = subtitle !== undefined ? subtitle : (formData?.formSubtitle || formData?.excerpt || '');
const computedPrivacyNote = privacyNote || '';

const computedShowOtherOptions = typeof showOtherOptions === 'boolean'
  ? (showOtherOptions && !hideOtherOptions)
  : (!!formData?.showOtherOptions && !hideOtherOptions);

const formFields = formData?.formFields || [];
const formLayoutClass = formData?.formLayout === 'two-column'
  ? 'grid grid-cols-1 md:grid-cols-2 gap-6'
  : 'space-y-6';

const sanitizeRichText = (input = '') => {
  if (!input) return '';
  return input
    .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '')
    .replace(/on\w+="[^"]*"/gi, '')
    .replace(/javascript:/gi, '')
    .trim();
};
---

<div class="space-y-12" data-dynamic-form-id={sanitizedFormIdBase}>
  <div class="bg-white border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-lg">
    {computedHeading && (
      <h2 class="text-2xl sm:text-3xl font-playfair font-semibold text-gray-900 mb-4">
        {computedHeading}
      </h2>
    )}
    {computedSubtitle && (
      <p class="text-base font-inter text-gray-700 mb-8 leading-relaxed" set:html={sanitizeRichText(computedSubtitle)}></p>
    )}
    
    <form id={sanitizedFormIdBase} class={formLayoutClass} novalidate>
      {formFields.map((field, index) => {
        const shouldSpanFullWidth = (() => {
          if (formData?.formLayout !== 'two-column') return false;
          if (['section', 'textarea', 'checkbox'].includes(field.type)) {
            return true;
          }
          let fieldsAfterThis = 0;
          for (let i = index + 1; i < formFields.length; i++) {
            const f = formFields[i];
            if (['section', 'textarea', 'checkbox'].includes(f.type)) {
              break;
            }
            fieldsAfterThis++;
          }
          if (fieldsAfterThis === 0) {
            let fieldsBeforeThis = 0;
            for (let i = index - 1; i >= 0; i--) {
              const f = formFields[i];
              if (['section', 'textarea', 'checkbox'].includes(f.type)) {
                break;
              }
              fieldsBeforeThis++;
            }
            if (fieldsBeforeThis % 2 === 0) {
              return true;
            }
          }
          return false;
        })();
        
        return (
          <>
            {field.type === 'hidden' ? (
              <input
                type="hidden"
                id={field.name}
                name={field.name}
                value={field.value || ''}
                data-query-param={field.queryParam || ''}
              />
            ) : field.type === 'section' ? (
              <div 
                class={formData?.formLayout === 'two-column' ? 'md:col-span-2 pt-6 pb-2' : 'pt-6 pb-2'}
                data-conditional={field.conditional ? 'true' : 'false'}
                data-condition-field={field.conditionalField || ''}
                data-condition-operator={field.conditionalOperator || ''}
                data-condition-value={field.conditionalValue || ''}
                style={field.conditional ? 'display: none;' : ''}
              >
                <h3 class="text-xl sm:text-2xl font-playfair font-semibold text-gray-900 mb-2">
                  {field.label}
                </h3>
                {field.description && (
                  <p class="text-base font-inter text-gray-600 leading-relaxed">
                    {field.description}
                  </p>
                )}
                <div class="mt-4 border-t border-gray-200"></div>
              </div>
            ) : (
              <div 
                class={shouldSpanFullWidth ? 'md:col-span-2' : ''}
                data-conditional={field.conditional ? 'true' : 'false'}
                data-condition-field={field.conditionalField || ''}
                data-condition-operator={field.conditionalOperator || ''}
                data-condition-value={field.conditionalValue || ''}
                style={field.conditional ? 'display: none;' : ''}
              >
                {field.type === 'namefield' ? (
                  <div class="name-field-display">
                    {field.label && (
                      <label class="block text-sm font-inter font-semibold text-gray-900 mb-2">
                        {field.label}
                      </label>
                    )}
                    <div class="mb-2">
                      <div class="text-2xl font-playfair font-semibold text-gray-900 inline-block border-b-2 border-[#ad986c] pb-1">
                        {field.value || field.placeholder || ''}
                      </div>
                    </div>
                    <input
                      type="hidden"
                      id={field.name}
                      name={field.name}
                      value={field.value || ''}
                      data-query-param={field.queryParam || ''}
                    />
                  </div>
                ) : field.type === 'repeater' ? (
                  <div class="repeater-container" data-repeater-name={field.name}>
                    <div class="mb-4">
                      <label class="block text-sm font-inter font-semibold text-gray-900 mb-2">
                        {field.label}
                        {field.required && <span class="text-red-500 ml-1">*</span>}
                      </label>
                      {field.description && (
                        <p class="text-sm font-inter text-gray-600 mb-3 leading-relaxed">
                          {field.description}
                        </p>
                      )}
                    </div>
                    <div class="repeater-items space-y-4" data-min-items={field.minItems || 0} data-max-items={field.maxItems || 999}>
                      <div class="repeater-item border-2 border-gray-200 rounded-lg p-6 relative">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {field.fields && field.fields.map((subfield) => (
                            <div class={subfield.type === 'textarea' ? 'md:col-span-2' : ''}>
                              <label class="block text-sm font-inter font-semibold text-gray-900 mb-2">
                                {subfield.label}
                                {subfield.required && <span class="text-red-500 ml-1">*</span>}
                              </label>
                              {subfield.description && (
                                <p class="text-sm font-inter text-gray-600 mb-2">
                                  {subfield.description}
                                </p>
                              )}
                              {subfield.type === 'textarea' ? (
                                <textarea
                                  name={`${field.name}[0][${subfield.name}]`}
                                  required={subfield.required}
                                  placeholder={subfield.placeholder || ''}
                                  rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all resize-vertical"
                                ></textarea>
                              ) : subfield.type === 'select' ? (
                                <select
                                  name={`${field.name}[0][${subfield.name}]`}
                                  required={subfield.required}
                                  data-dynamic-options={subfield.dynamicOptions || ''}
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                                >
                                  <option value="">{subfield.placeholder || 'Select an option...'}</option>
                                  {subfield.options && subfield.options.map((option) => (
                                    <option value={option}>{option}</option>
                                  ))}
                                </select>
                              ) : (
                                <input
                                  type={subfield.type || 'text'}
                                  name={`${field.name}[0][${subfield.name}]`}
                                  required={subfield.required}
                                  placeholder={subfield.placeholder || ''}
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                                />
                              )}
                            </div>
                          ))}
                        </div>
                        <button
                          type="button"
                          class="remove-item absolute top-4 right-4 text-red-600 hover:text-red-800 font-inter font-semibold text-sm hidden"
                        >
                          âœ• Remove
                        </button>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="add-item mt-4 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-900 rounded-lg font-inter font-semibold transition-colors"
                    >
                      {field.addButtonText || '+ Add Item'}
                    </button>
                  </div>
                ) : field.type === 'checkbox' ? (
                  <div class="space-y-3">
                    {field.options && field.options.map((option) => (
                      <div class="flex items-start gap-3">
                        <input
                          type="checkbox"
                          id={field.options.length === 1 ? field.name : `${field.name}_${option.replace(/\s+/g, '_')}`}
                          name={field.name}
                          value={option}
                          required={field.required && field.options.length === 1}
                          class="mt-1 w-5 h-5 text-[#ad986c] border-gray-300 rounded focus:ring-2 focus:ring-gold transition-all cursor-pointer"
                        />
                        <label 
                          for={field.options.length === 1 ? field.name : `${field.name}_${option.replace(/\s+/g, '_')}`}
                          class="flex-1 text-sm font-inter text-gray-900 leading-relaxed cursor-pointer select-none"
                        >
                          {option}
                          {field.required && field.options.length === 1 && <span class="text-red-500 ml-1">*</span>}
                        </label>
                      </div>
                    ))}
                    {field.description && (
                      <p class="text-sm font-inter text-gray-600 mt-2 ml-8">
                        {field.description}
                      </p>
                    )}
                  </div>
                ) : (
                  <>
                    <label 
                      for={field.name}
                      class="block text-sm font-inter font-semibold text-gray-900 mb-2"
                    >
                      {field.label}
                      {field.required && <span class="text-red-500 ml-1">*</span>}
                    </label>
                    
                    {field.description && (
                      <p class="text-sm font-inter text-gray-600 mb-3 leading-relaxed">
                        {field.description}
                      </p>
                    )}
                    
                    {field.type === 'textarea' ? (
                      <textarea
                        id={field.name}
                        name={field.name}
                        required={field.required}
                        placeholder={field.placeholder || ''}
                        minlength={field.minLength}
                        maxlength={field.maxLength}
                        rows="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all resize-vertical"
                      ></textarea>
                    ) : field.type === 'select' ? (
                      <select
                        id={field.name}
                        name={field.name}
                        required={field.required}
                        data-dynamic-options={field.dynamicOptions || ''}
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                      >
                        <option value="">{field.placeholder || 'Select an option...'}</option>
                        {field.options && field.options.map((option) => (
                          <option value={option}>{option}</option>
                        ))}
                      </select>
                    ) : field.type === 'tel' ? (
                      <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative w-full sm:w-52">
                          <input
                            type="text"
                            id={`${field.name}_country`}
                            name={`${field.name}_country`}
                            list={`${field.name}_countries`}
                            value="+44"
                            placeholder="ðŸ‡¬ðŸ‡§ +44"
                            class="w-full sm:min-w-[12rem] px-3 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                          />
                          <datalist id={`${field.name}_countries`}>
                            <option value="+93">ðŸ‡¦ðŸ‡« Afghanistan +93</option>
                            <option value="+355">ðŸ‡¦ðŸ‡± Albania +355</option>
                            <option value="+213">ðŸ‡©ðŸ‡¿ Algeria +213</option>
                            <option value="+376">ðŸ‡¦ðŸ‡© Andorra +376</option>
                            <option value="+244">ðŸ‡¦ðŸ‡´ Angola +244</option>
                            <option value="+54">ðŸ‡¦ðŸ‡· Argentina +54</option>
                            <option value="+374">ðŸ‡¦ðŸ‡² Armenia +374</option>
                            <option value="+61">ðŸ‡¦ðŸ‡º Australia +61</option>
                            <option value="+43">ðŸ‡¦ðŸ‡¹ Austria +43</option>
                            <option value="+994">ðŸ‡¦ðŸ‡¿ Azerbaijan +994</option>
                            <option value="+973">ðŸ‡§ðŸ‡­ Bahrain +973</option>
                            <option value="+880">ðŸ‡§ðŸ‡© Bangladesh +880</option>
                            <option value="+375">ðŸ‡§ðŸ‡¾ Belarus +375</option>
                            <option value="+32">ðŸ‡§ðŸ‡ª Belgium +32</option>
                            <option value="+501">ðŸ‡§ðŸ‡¿ Belize +501</option>
                            <option value="+229">ðŸ‡§ðŸ‡¯ Benin +229</option>
                            <option value="+975">ðŸ‡§ðŸ‡¹ Bhutan +975</option>
                            <option value="+591">ðŸ‡§ðŸ‡´ Bolivia +591</option>
                            <option value="+387">ðŸ‡§ðŸ‡¦ Bosnia +387</option>
                            <option value="+55">ðŸ‡§ðŸ‡· Brazil +55</option>
                            <option value="+673">ðŸ‡§ðŸ‡³ Brunei +673</option>
                            <option value="+359">ðŸ‡§ðŸ‡¬ Bulgaria +359</option>
                            <option value="+855">ðŸ‡°ðŸ‡­ Cambodia +855</option>
                            <option value="+237">ðŸ‡¨ðŸ‡² Cameroon +237</option>
                            <option value="+1">ðŸ‡¨ðŸ‡¦ Canada +1</option>
                            <option value="+56">ðŸ‡¨ðŸ‡± Chile +56</option>
                            <option value="+86">ðŸ‡¨ðŸ‡³ China +86</option>
                            <option value="+57">ðŸ‡¨ðŸ‡´ Colombia +57</option>
                            <option value="+506">ðŸ‡¨ðŸ‡· Costa Rica +506</option>
                            <option value="+385">ðŸ‡­ðŸ‡· Croatia +385</option>
                            <option value="+53">ðŸ‡¨ðŸ‡º Cuba +53</option>
                            <option value="+357">ðŸ‡¨ðŸ‡¾ Cyprus +357</option>
                            <option value="+420">ðŸ‡¨ðŸ‡¿ Czech Republic +420</option>
                            <option value="+45">ðŸ‡©ðŸ‡° Denmark +45</option>
                            <option value="+593">ðŸ‡ªðŸ‡¨ Ecuador +593</option>
                            <option value="+20">ðŸ‡ªðŸ‡¬ Egypt +20</option>
                            <option value="+372">ðŸ‡ªðŸ‡ª Estonia +372</option>
                            <option value="+251">ðŸ‡ªðŸ‡¹ Ethiopia +251</option>
                            <option value="+358">ðŸ‡«ðŸ‡® Finland +358</option>
                            <option value="+33">ðŸ‡«ðŸ‡· France +33</option>
                            <option value="+995">ðŸ‡¬ðŸ‡ª Georgia +995</option>
                            <option value="+49">ðŸ‡©ðŸ‡ª Germany +49</option>
                            <option value="+233">ðŸ‡¬ðŸ‡­ Ghana +233</option>
                            <option value="+30">ðŸ‡¬ðŸ‡· Greece +30</option>
                            <option value="+852">ðŸ‡­ðŸ‡° Hong Kong +852</option>
                            <option value="+36">ðŸ‡­ðŸ‡º Hungary +36</option>
                            <option value="+354">ðŸ‡®ðŸ‡¸ Iceland +354</option>
                            <option value="+91">ðŸ‡®ðŸ‡³ India +91</option>
                            <option value="+62">ðŸ‡®ðŸ‡© Indonesia +62</option>
                            <option value="+98">ðŸ‡®ðŸ‡· Iran +98</option>
                            <option value="+964">ðŸ‡®ðŸ‡¶ Iraq +964</option>
                            <option value="+353">ðŸ‡®ðŸ‡ª Ireland +353</option>
                            <option value="+972">ðŸ‡®ðŸ‡± Israel +972</option>
                            <option value="+39">ðŸ‡®ðŸ‡¹ Italy +39</option>
                            <option value="+81">ðŸ‡¯ðŸ‡µ Japan +81</option>
                            <option value="+962">ðŸ‡¯ðŸ‡´ Jordan +962</option>
                            <option value="+7">ðŸ‡°ðŸ‡¿ Kazakhstan +7</option>
                            <option value="+254">ðŸ‡°ðŸ‡ª Kenya +254</option>
                            <option value="+965">ðŸ‡°ðŸ‡¼ Kuwait +965</option>
                            <option value="+371">ðŸ‡±ðŸ‡» Latvia +371</option>
                            <option value="+961">ðŸ‡±ðŸ‡§ Lebanon +961</option>
                            <option value="+423">ðŸ‡±ðŸ‡® Liechtenstein +423</option>
                            <option value="+370">ðŸ‡±ðŸ‡¹ Lithuania +370</option>
                            <option value="+352">ðŸ‡±ðŸ‡º Luxembourg +352</option>
                            <option value="+853">ðŸ‡²ðŸ‡´ Macau +853</option>
                            <option value="+60">ðŸ‡²ðŸ‡¾ Malaysia +60</option>
                            <option value="+960">ðŸ‡²ðŸ‡» Maldives +960</option>
                            <option value="+356">ðŸ‡²ðŸ‡¹ Malta +356</option>
                            <option value="+52">ðŸ‡²ðŸ‡½ Mexico +52</option>
                            <option value="+377">ðŸ‡²ðŸ‡¨ Monaco +377</option>
                            <option value="+212">ðŸ‡²ðŸ‡¦ Morocco +212</option>
                            <option value="+95">ðŸ‡²ðŸ‡² Myanmar +95</option>
                            <option value="+264">ðŸ‡³ðŸ‡¦ Namibia +264</option>
                            <option value="+977">ðŸ‡³ðŸ‡µ Nepal +977</option>
                            <option value="+31">ðŸ‡³ðŸ‡± Netherlands +31</option>
                            <option value="+64">ðŸ‡³ðŸ‡¿ New Zealand +64</option>
                            <option value="+47">ðŸ‡³ðŸ‡´ Norway +47</option>
                            <option value="+968">ðŸ‡´ðŸ‡² Oman +968</option>
                            <option value="+92">ðŸ‡µðŸ‡° Pakistan +92</option>
                            <option value="+507">ðŸ‡µðŸ‡¦ Panama +507</option>
                            <option value="+51">ðŸ‡µðŸ‡ª Peru +51</option>
                            <option value="+63">ðŸ‡µðŸ‡­ Philippines +63</option>
                            <option value="+48">ðŸ‡µðŸ‡± Poland +48</option>
                            <option value="+351">ðŸ‡µðŸ‡¹ Portugal +351</option>
                            <option value="+974">ðŸ‡¶ðŸ‡¦ Qatar +974</option>
                            <option value="+40">ðŸ‡·ðŸ‡´ Romania +40</option>
                            <option value="+7">ðŸ‡·ðŸ‡º Russia +7</option>
                            <option value="+966">ðŸ‡¸ðŸ‡¦ Saudi Arabia +966</option>
                            <option value="+381">ðŸ‡·ðŸ‡¸ Serbia +381</option>
                            <option value="+65">ðŸ‡¸ðŸ‡¬ Singapore +65</option>
                            <option value="+421">ðŸ‡¸ðŸ‡° Slovakia +421</option>
                            <option value="+386">ðŸ‡¸ðŸ‡® Slovenia +386</option>
                            <option value="+27">ðŸ‡¿ðŸ‡¦ South Africa +27</option>
                            <option value="+82">ðŸ‡°ðŸ‡· South Korea +82</option>
                            <option value="+34">ðŸ‡ªðŸ‡¸ Spain +34</option>
                            <option value="+94">ðŸ‡±ðŸ‡° Sri Lanka +94</option>
                            <option value="+46">ðŸ‡¸ðŸ‡ª Sweden +46</option>
                            <option value="+41">ðŸ‡¨ðŸ‡­ Switzerland +41</option>
                            <option value="+886">ðŸ‡¹ðŸ‡¼ Taiwan +886</option>
                            <option value="+66">ðŸ‡¹ðŸ‡­ Thailand +66</option>
                            <option value="+90">ðŸ‡¹ðŸ‡· Turkey +90</option>
                            <option value="+971">ðŸ‡¦ðŸ‡ª UAE +971</option>
                            <option value="+44">ðŸ‡¬ðŸ‡§ UK +44</option>
                            <option value="+1">ðŸ‡ºðŸ‡¸ USA +1</option>
                            <option value="+598">ðŸ‡ºðŸ‡¾ Uruguay +598</option>
                            <option value="+58">ðŸ‡»ðŸ‡ª Venezuela +58</option>
                            <option value="+84">ðŸ‡»ðŸ‡³ Vietnam +84</option>
                          </datalist>
                        </div>
                        <input
                          type="tel"
                          id={field.name}
                          name={field.name}
                          required={field.required}
                          placeholder={field.placeholder || ''}
                          pattern={field.pattern}
                          class="w-full sm:flex-1 px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                        />
                      </div>
                    ) : field.type === 'time' ? (
                      <input
                        type="time"
                        id={field.name}
                        name={field.name}
                        required={field.required}
                        data-query-param={field.queryParam || ''}
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                      />
                    ) : field.type === 'file' ? (
                      <div>
                        <input
                          type="file"
                          id={field.name}
                          name={field.name}
                          required={field.required}
                          accept={field.accept || '*'}
                          multiple={field.multiple || false}
                          data-upload-to-r2="true"
                          class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#ad986c] file:text-white hover:file:bg-[#8a7454] cursor-pointer"
                        />
                        <div class="mt-2 text-sm font-inter text-gray-600">
                          {field.description || 'Files will be uploaded securely'}
                        </div>
                        <div id={`${field.name}_status`} class="mt-2 text-sm font-inter"></div>
                        <input type="hidden" id={`${field.name}_url`} name={`${field.name}_url`} />
                      </div>
                    ) : (
                      <input
                        type={field.type || 'text'}
                        id={field.name}
                        name={field.name}
                        required={field.required}
                        placeholder={field.placeholder || ''}
                        pattern={field.pattern}
                        minlength={field.minLength}
                        maxlength={field.maxLength}
                        min={field.min}
                        max={field.max}
                        data-query-param={field.queryParam || ''}
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                      />
                    )}
                  </>
                )}
              </div>
            )}
          </>
        );
      })}
      
      <div class={formData?.formLayout === 'two-column' ? 'md:col-span-2' : ''}>
        {import.meta.env.PUBLIC_TURNSTILE_SITE_KEY && (
          <div class="cf-turnstile" data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY} data-theme="light"></div>
        )}
      </div>
      
      <div 
        class={formData?.formLayout === 'two-column' ? 'md:col-span-2' : ''}
        data-conditional={formData?.submitButtonConditional ? 'true' : 'false'}
        data-condition-field={formData?.submitButtonConditionalField || ''}
        data-condition-operator={formData?.submitButtonConditionalOperator || ''}
        data-condition-value={formData?.submitButtonConditionalValue || ''}
        style={formData?.submitButtonConditional ? 'display: none;' : ''}
      >
        <button
          type="submit"
          class="w-full bg-[#ad986c] text-white px-8 py-4 rounded-lg font-inter font-semibold hover:bg-[#8a7454] transition-colors focus:ring-4 focus:ring-gold/30 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id={submitTextId}>Submit Form</span>
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>
    </form>
    
    {computedPrivacyNote && (
      <p class="mt-6 text-sm text-gray-500" set:html={sanitizeRichText(computedPrivacyNote)}></p>
    )}
    
    <div id={successMessageId} class="hidden mt-8 p-6 bg-green-50 border-2 border-green-500 rounded-xl">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h3 class="text-lg font-inter font-semibold text-green-900 mb-1">Thank you!</h3>
          <p class="text-base font-inter text-green-800">Your form has been submitted successfully.</p>
        </div>
      </div>
    </div>
    
    <div id={errorMessageId} class="hidden mt-8 p-6 bg-red-50 border-2 border-red-500 rounded-xl">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h3 class="text-lg font-inter font-semibold text-red-900 mb-1">Error</h3>
          <p class="text-base font-inter text-red-800" id={errorTextId}>Something went wrong. Please try again.</p>
        </div>
      </div>
    </div>
  </div>
  
  {computedShowOtherOptions && (
    <div class="w-full bg-gray-50 py-12 sm:py-16 lg:py-20 border-t border-gray-200 rounded-2xl">
      <div class="container mx-auto px-4 sm:px-10">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-playfair font-semibold text-gray-900 mb-8 sm:mb-12 text-center">
          Other Options
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
          <a 
            href="tel:+442079657277"
            class="group bg-white border-2 border-gray-200 rounded-2xl p-8 shadow-sm hover:shadow-xl hover:border-[#ad986c] transition-all duration-300 hover:-translate-y-1 text-center"
          >
            <svg class="w-8 h-8 mx-auto mb-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <h3 class="text-lg font-playfair font-semibold text-gray-900 mb-2 group-hover:text-[#ad986c] transition-colors">
              Phone
            </h3>
            <p class="text-base font-inter text-gray-700 group-hover:text-[#ad986c] transition-colors">
              +44 020 7965 7277
            </p>
          </a>
          
          <a 
            href={`mailto:hello@activeaway.com?subject=${encodeURIComponent(formData?.title || 'Active Away Form')}`}
            class="group bg-white border-2 border-gray-200 rounded-2xl p-8 shadow-sm hover:shadow-xl hover:border-[#ad986c] transition-all duration-300 hover:-translate-y-1 text-center"
          >
            <svg class="w-8 h-8 mx-auto mb-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <h3 class="text-lg font-playfair font-semibold text-gray-900 mb-2 group-hover:text-[#ad986c] transition-colors">
              Email
            </h3>
            <p class="text-base font-inter text-gray-700 group-hover:text-[#ad986c] transition-colors">
              hello@activeaway.com
            </p>
          </a>
        </div>
      </div>
    </div>
  )}
</div>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }
</style>

<script define:vars={{
  formId: sanitizedFormIdBase,
  formSlug: resolvedFormSlug,
  successMessageId,
  errorMessageId,
  errorTextId,
  submitTextId,
  webhookUrl: formData?.webhookUrl || null
}}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById(formId);
    if (!form) {
      console.warn(`DynamicFormTailwind: form ${formId} not found`);
      return;
    }
    
    const successMessage = document.getElementById(successMessageId);
    const errorMessage = document.getElementById(errorMessageId);
    const errorText = document.getElementById(errorTextId);
    const submitButtonText = document.getElementById(submitTextId);
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      successMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');
      
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButtonText?.textContent || 'Submit Form';
      
      try {
        let turnstileToken = null;
        try {
          if (typeof window.turnstile !== 'undefined' && window.turnstile) {
            turnstileToken = window.turnstile.getResponse();
          }
        } catch (err) {
          console.warn('Turnstile not available:', err);
        }
        
        if (submitButton) {
          submitButton.disabled = true;
        }
        if (submitButtonText) {
          submitButtonText.textContent = 'Submitting...';
        }
        
        // Handle file uploads first
        const fileInputs = form.querySelectorAll('input[type="file"][data-upload-to-r2="true"]');
        const fileUploads = {};
        
        if (fileInputs.length > 0) {
          if (submitButtonText) {
            submitButtonText.textContent = 'Uploading files...';
          }
          
          for (const fileInput of fileInputs) {
            const files = fileInput.files;
            if (files && files.length > 0) {
              const fieldName = fileInput.name;
              const statusDiv = document.getElementById(`${fieldName}_status`);
              const urlInput = document.getElementById(`${fieldName}_url`);
              
              try {
                const uploadedUrls = [];
                
                for (let i = 0; i < files.length; i++) {
                  const file = files[i];
                  
                  if (statusDiv) {
                    statusDiv.textContent = `Uploading ${file.name}...`;
                    statusDiv.className = 'mt-2 text-sm font-inter text-blue-600';
                  }
                  
                  const uploadFormData = new FormData();
                  uploadFormData.append('file', file);
                  
                  const uploadResponse = await fetch('/api/upload-file.json', {
                    method: 'POST',
                    body: uploadFormData
                  });
                  
                  if (!uploadResponse.ok) {
                    throw new Error(`Failed to upload ${file.name}`);
                  }
                  
                  const uploadResult = await uploadResponse.json();
                  uploadedUrls.push({
                    url: uploadResult.url,
                    fileName: uploadResult.fileName,
                    fileSize: uploadResult.fileSize,
                    fileType: uploadResult.fileType
                  });
                }
                
                fileUploads[fieldName] = uploadedUrls.length === 1 ? uploadedUrls[0] : uploadedUrls;
                
                if (statusDiv) {
                  statusDiv.textContent = 'âœ“ Upload complete';
                  statusDiv.className = 'mt-2 text-sm font-inter text-green-600';
                }
                
                if (urlInput) {
                  urlInput.value = JSON.stringify(uploadedUrls);
                }
                
              } catch (uploadError) {
                console.error('File upload error:', uploadError);
                if (statusDiv) {
                  statusDiv.textContent = `âœ— Upload failed: ${uploadError.message}`;
                  statusDiv.className = 'mt-2 text-sm font-inter text-red-600';
                }
                throw uploadError;
              }
            }
          }
          
          if (submitButtonText) {
            submitButtonText.textContent = 'Submitting form...';
          }
        }
        
        const formDataObj = new FormData(form);
        const data = {};
        
        for (const [key, value] of formDataObj.entries()) {
          const repeaterMatch = key.match(/^(.+?)\[(\d+)\]\[(.+?)\]$/);
          
          if (repeaterMatch) {
            const [, repeaterName, index, subfieldName] = repeaterMatch;
            const idx = parseInt(index);
            
            if (!data[repeaterName]) {
              data[repeaterName] = [];
            }
            
            if (!data[repeaterName][idx]) {
              data[repeaterName][idx] = {};
            }
            
            data[repeaterName][idx][subfieldName] = value;
          } else {
            if (data[key]) {
              if (Array.isArray(data[key])) {
                data[key].push(value);
              } else {
                data[key] = [data[key], value];
              }
            } else {
              const allValues = formDataObj.getAll(key);
              if (allValues.length > 1) {
                data[key] = allValues;
              } else {
                data[key] = value;
              }
            }
          }
        }
        
        Object.keys(data).forEach(key => {
          if (key.endsWith('_country')) {
            const phoneFieldName = key.replace('_country', '');
            if (data[phoneFieldName]) {
              const cleanCountryCode = String(data[key]).replace(/[\+\s]/g, '');
              data[phoneFieldName] = `${cleanCountryCode}${data[phoneFieldName]}`;
              delete data[key];
            }
          }
        });
        
        // Merge file uploads into data
        if (Object.keys(fileUploads).length > 0) {
          Object.assign(data, fileUploads);
        }
        
        const response = await fetch('/api/submit-form.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            formSlug: formSlug,
            data: data,
            turnstileToken: turnstileToken,
            webhookUrl: webhookUrl
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          successMessage?.classList.remove('hidden');
          form.reset();
          
          try {
            if (typeof window.turnstile !== 'undefined' && window.turnstile) {
              window.turnstile.reset();
            }
          } catch (err) {
            console.warn('Could not reset Turnstile:', err);
          }
          
          successMessage?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          throw new Error(result.error || 'Form submission failed');
        }
        
      } catch (error) {
        console.error('Form submission error:', error);
        if (errorText) {
          errorText.textContent = error.message || 'Something went wrong. Please try again.';
        }
        errorMessage?.classList.remove('hidden');
        
        try {
          if (typeof window.turnstile !== 'undefined' && window.turnstile) {
            window.turnstile.reset();
          }
        } catch (err) {
          console.warn('Could not reset Turnstile:', err);
        }
        
        errorMessage?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
        }
        if (submitButtonText) {
          submitButtonText.textContent = originalButtonText;
        }
      }
    });
    
    const urlParams = new URLSearchParams(window.location.search);
    const fieldsWithQueryParams = form.querySelectorAll('[data-query-param]');
    
    fieldsWithQueryParams.forEach((field) => {
      const queryParam = field.getAttribute('data-query-param');
      if (queryParam && urlParams.has(queryParam)) {
        const value = urlParams.get(queryParam);
        if (value) {
          field.value = value;
          const parentDiv = field.closest('.name-field-display');
          if (parentDiv) {
            const textDiv = parentDiv.querySelector('.text-2xl');
            if (textDiv) {
              textDiv.textContent = value;
            }
          }
        }
      }
    });
    
    const dynamicSelects = form.querySelectorAll('select[data-dynamic-options]');
    
    dynamicSelects.forEach(async (select) => {
      const dynamicType = select.getAttribute('data-dynamic-options');
      
      async function populateSelect(endpoint) {
        try {
          const response = await fetch(endpoint);
          const result = await response.json();
          
          if (result.success && Array.isArray(result.items || result.resorts || result.venues || result.clinics)) {
            const placeholder = select.querySelector('option[value=""]');
            const existingOptions = Array.from(select.children);
            select.innerHTML = '';
            
            if (placeholder) {
              select.appendChild(placeholder);
            }
            
            const values = result.items || result.resorts || result.venues || result.clinics;
            values.forEach(item => {
              const option = document.createElement('option');
              option.value = item;
              option.textContent = item;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Failed to load dynamic options:', error);
        }
      }
      
      if (dynamicType === 'resorts') {
        await populateSelect('/api/get-resorts.json');
      } else if (dynamicType === 'venues') {
        await populateSelect('/api/get-venues.json');
      } else if (dynamicType === 'clinics') {
        await populateSelect('/api/get-clinics.json');
      }
    });
    
    function checkCondition(field, operator, value) {
      if (!field) return false;
      const fieldValue = field.value || '';
      
      switch(operator) {
        case 'contains':
        case 'contain':
          return fieldValue.includes(value);
        case 'not_contain':
          return !fieldValue.includes(value);
        case 'equals':
        case 'equal':
          return fieldValue === value;
        case 'not_equals':
          return fieldValue !== value;
        case 'not_empty':
          return fieldValue.trim() !== '';
        case 'empty':
          return fieldValue.trim() === '';
        case 'greater':
          return fieldValue.length > parseInt(value, 10);
        case 'less':
          return fieldValue.length < parseInt(value, 10);
        default:
          return false;
      }
    }
    
    function updateConditionals() {
      const conditionalElements = form.querySelectorAll('[data-conditional="true"]');
      
      conditionalElements.forEach((element) => {
        const conditionFieldName = element.getAttribute('data-condition-field');
        const conditionOperator = element.getAttribute('data-condition-operator');
        const conditionValue = element.getAttribute('data-condition-value');
        
        if (!conditionFieldName) return;
        
        const conditionField = form.querySelector(`[name="${conditionFieldName}"]`);
        const conditionMet = checkCondition(conditionField, conditionOperator, conditionValue);
        
        element.style.display = conditionMet ? '' : 'none';
        
        if (!conditionMet) {
          element.querySelectorAll('input, select, textarea').forEach(field => {
            field.setAttribute('data-was-required', field.required);
            field.required = false;
          });
        } else {
          element.querySelectorAll('input[data-was-required="true"], select[data-was-required="true"], textarea[data-was-required="true"]').forEach(field => {
            field.required = true;
          });
        }
      });
    }
    
    form.addEventListener('input', updateConditionals);
    form.addEventListener('change', updateConditionals);
    updateConditionals();
    
    const repeaterContainers = form.querySelectorAll('.repeater-container');
    
    repeaterContainers.forEach((container) => {
      const itemsContainer = container.querySelector('.repeater-items');
      const addButton = container.querySelector('.add-item');
      const minItems = parseInt(itemsContainer.getAttribute('data-min-items') || '0', 10);
      const maxItems = parseInt(itemsContainer.getAttribute('data-max-items') || '999', 10);
      
      function updateItems() {
        const items = itemsContainer.querySelectorAll('.repeater-item');
        
        items.forEach((item, index) => {
          item.querySelectorAll('input, select, textarea').forEach((field) => {
            const name = field.getAttribute('name');
            if (name) {
              const newName = name.replace(/\[\d+\]/, `[${index}]`);
              field.setAttribute('name', newName);
            }
          });
          
          const removeButton = item.querySelector('.remove-item');
          if (items.length > minItems) {
            removeButton.classList.remove('hidden');
          } else {
            removeButton.classList.add('hidden');
          }
        });
        
        if (items.length >= maxItems) {
          addButton.classList.add('hidden');
        } else {
          addButton.classList.remove('hidden');
        }
      }
      
      addButton?.addEventListener('click', () => {
        const items = itemsContainer.querySelectorAll('.repeater-item');
        if (items.length >= maxItems) return;
        
        const template = items[0].cloneNode(true);
        
        template.querySelectorAll('input, select, textarea').forEach((field) => {
          if (field.type === 'checkbox' || field.type === 'radio') {
            field.checked = false;
          } else {
            field.value = '';
          }
        });
        
        template.querySelectorAll('select[data-dynamic-options]').forEach((clonedSelect, idx) => {
          const originalSelect = items[0].querySelectorAll('select[data-dynamic-options]')[idx];
          if (originalSelect) {
            clonedSelect.innerHTML = originalSelect.innerHTML;
          }
        });
        
        itemsContainer.appendChild(template);
        
        const removeButton = template.querySelector('.remove-item');
        removeButton.addEventListener('click', () => {
          template.remove();
          updateItems();
        });
        
        updateItems();
        template.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
      
      itemsContainer.querySelectorAll('.repeater-item').forEach((item) => {
        const removeButton = item.querySelector('.remove-item');
        removeButton.addEventListener('click', () => {
          item.remove();
          updateItems();
        });
      });
      
      updateItems();
    });
  });
</script>


