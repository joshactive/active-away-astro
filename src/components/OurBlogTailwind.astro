---
// Blog data - Fetched from Strapi - Tailwind CSS Version
import { getBlogs } from '../utils/strapi.js';
import { getImageByName, getResponsiveImageByName, getStrapiImageAttrs } from '../utils/cloudflareImages.js';

// Fetch blogs from Strapi
let blogs = await getBlogs(8); // Get 8 most recent posts

// Fallback to hardcoded data if Strapi fails or returns no data
const BLOG_IMAGE_SIZES = '(max-width: 640px) calc(100vw - 5rem), (max-width: 1024px) calc(100vw - 8rem), 704px';
const BLOG_IMAGE_QUALITY = 60;

const buildBlogImage = (imageName, alt) => {
  const attrs = getResponsiveImageByName(imageName, {
    displayWidth: 704,
    displayHeight: 256,
    fit: 'cover',
    alt,
    sizes: BLOG_IMAGE_SIZES,
    quality: BLOG_IMAGE_QUALITY
  });

  if (attrs) {
    return attrs;
  }

  const fallbackSrc = getImageByName(imageName, { width: 704, height: 256, fit: 'cover', format: 'auto', quality: BLOG_IMAGE_QUALITY });
  return {
    src: fallbackSrc,
    url: fallbackSrc,
    width: 704,
    height: 256,
    alt,
    loading: 'lazy',
    sizes: BLOG_IMAGE_SIZES
  };
};

if (!blogs || blogs.length === 0) {
  console.warn('⚠️  Using fallback blog data');
  
  blogs = [
    {
      id: 1,
      image: buildBlogImage('blog-2', 'Newcastle Under-Lyme School Tennis Team Enjoy a Wimbledon Escape!'),
      author: "Josh Thompson",
      date: "July 4, 2025",
      title: "Newcastle Under-Lyme School Tennis Team Enjoy a Wimbledon Escape!",
      description: "Newcastle-under-Lyme School enjoy a VIP Wimbledon trip with coaching, luxury hotel stay and more on the first-ever....",
      slug: "wimbledon-escape"
    },
    {
      id: 2,
      image: buildBlogImage('blog-1', 'Active Away Takes On Five Tennis Academies At Ikos Resorts'),
      author: "Josh Thompson",
      date: "February 20, 2025",
      title: "Active Away Takes On Five Tennis Academies At Ikos Resorts",
      description: "Discover the best tennis travel destinations worldwide. Explore stunning courts from scenic locales to iconic arenas for your..",
      slug: "five-tennis-academies"
    },
    {
      id: 3,
      image: buildBlogImage('blog-3', 'Tennis Nutrition: What to Eat for Optimal Performance'),
      author: "Sophie Westlake",
      date: "February 6, 2025",
      title: "Tennis Nutrition: What to Eat for Optimal Performance",
      description: "Discover the best nutrition tips for tennis players to enhance performance, boost energy levels, and speed up recovery...",
      slug: "tennis-nutrition"
    }
  ];
}

const blogData = {
  kicker: "EXPLORE",
  title: "Our Blog",
  viewAllLink: "View All Posts",
  blogs: blogs
};

// Debug: Log the blogs
console.log('📝 Blog Posts:', blogData.blogs.length);
console.log('📝 Blog Data:', blogData.blogs.map(b => b.title));
---

<section class="w-full bg-gray-50 py-12 sm:py-16 lg:py-24">
  <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
    <!-- Header -->
    <div class="mb-6 sm:mb-8 lg:mb-16">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2 sm:gap-3 lg:gap-4">
        <div>
          <div class="text-sm sm:text-base font-inter font-medium text-gray-900 tracking-widest uppercase mb-1 sm:mb-2">
            {blogData.kicker}
          </div>
          <h2 class="text-2xl sm:text-3xl lg:text-4xl font-playfair font-semibold text-gray-900">
            {blogData.title}
          </h2>
        </div>
        <a href="/blog" class="text-base sm:text-lg font-inter text-gray-900 underline hover:text-gray-700 transition-colors">
          {blogData.viewAllLink}
        </a>
      </div>
    </div>

    <!-- Blog Carousel -->
    <div class="relative">
      <!-- Navigation Arrows -->
      <button class="hidden lg:flex absolute left-4 top-1/2 transform -translate-y-1/2 z-10 w-12 h-12 bg-[#ad986c] rounded-full shadow-lg items-center justify-center hover:bg-[#8a7454] transition-all duration-300" onclick="previousBlogCard()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M15 18L9 12L15 6" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="hidden lg:flex absolute right-4 top-1/2 transform -translate-y-1/2 z-10 w-12 h-12 bg-[#ad986c] rounded-full shadow-lg items-center justify-center hover:bg-[#8a7454] transition-all duration-300" onclick="nextBlogCard()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M9 18L15 12L9 6" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Cards Container Wrapper -->
      <div class="relative">
        <!-- Cards Container -->
        <div id="blogsContainer" class="flex flex-row overflow-x-auto lg:overflow-visible snap-x snap-mandatory lg:snap-none justify-start lg:justify-between items-stretch gap-4 sm:gap-6 lg:gap-6 pb-4 lg:pb-0 pl-4 sm:pl-10 lg:pl-0 transition-transform duration-500 ease-out">
          {blogData.blogs.map((blog, index) => {
            const imageAlt = blog.image?.alt || blog.imageAlt || blog.title;
            let imgAttrs;

            if (blog.image?.src) {
              imgAttrs = {
                ...blog.image,
                alt: blog.image.alt || imageAlt,
                sizes: blog.image.sizes || BLOG_IMAGE_SIZES
              };
            } else {
              const imageUrl = typeof blog.image === 'string' ? blog.image : blog.image?.url;
              if (imageUrl) {
                const config = {
                  displayWidth: 704,
                  displayHeight: 256,
                  fit: 'cover',
                  sizes: BLOG_IMAGE_SIZES,
                  alt: imageAlt,
                  quality: BLOG_IMAGE_QUALITY
                };

                const strapiAttrs = getStrapiImageAttrs({ url: imageUrl, alt: imageAlt }, config);
                imgAttrs = strapiAttrs ?? {
                  src: imageUrl,
                  url: imageUrl,
                  alt: imageAlt,
                  width: 704,
                  height: 256,
                  loading: 'lazy',
                  sizes: BLOG_IMAGE_SIZES
                };
              } else {
                imgAttrs = buildBlogImage('blog-1', imageAlt);
              }
            }

            return (
            <a href={`/blog/${blog.slug || blog.id}`} class="blog-card flex-shrink-0 w-[calc(100vw-5rem)] sm:w-[calc(100vw-8rem)] lg:w-[calc((100%-3rem)/3)] snap-start relative" data-index={index} data-total={blogData.blogs.length}>
              {/* Card Image */}
              <div class="relative overflow-hidden rounded-2xl bg-gray-900 z-0">
                <img 
                  src={imgAttrs.src}
                  {...(imgAttrs.srcset && { srcset: imgAttrs.srcset })}
                  sizes={imgAttrs.sizes || BLOG_IMAGE_SIZES}
                  width={imgAttrs.width || 704}
                  height={imgAttrs.height || 256}
                  alt={imgAttrs.alt || imageAlt}
                  loading={imgAttrs.loading || 'lazy'}
                  class="w-full h-48 sm:h-56 lg:h-64 object-cover" 
                />
              </div>
              
              {/* Card Content */}
              <div class="relative -mt-6 sm:-mt-8 lg:-mt-12 z-20 px-3 sm:px-6 pb-3 sm:pb-6">
                <div class="bg-white border border-gray-200 rounded-2xl p-4 sm:p-6 shadow-xl flex flex-col transition-all duration-300 group-hover:-translate-y-1">
                  {/* Tags */}
                  <div class="flex flex-wrap gap-2 mb-3 sm:mb-4">
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs sm:text-sm font-inter rounded-full">{blog.author}</span>
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs sm:text-sm font-inter rounded-full">{blog.date}</span>
                  </div>

                  {/* Title and Description */}
                  <h3 class="text-base sm:text-xl lg:text-2xl font-playfair font-bold text-gray-900 mb-2 sm:mb-4 leading-tight line-clamp-2">
                    {blog.title}
                  </h3>
                  <p class="text-sm sm:text-base font-inter text-gray-800 leading-relaxed mb-4 sm:mb-6 line-clamp-3">
                    {blog.description}
                  </p>

                  {/* Read More Button */}
                  <div class="flex items-center gap-2 text-[#ad986c] hover:text-[#8a7454] font-inter font-medium text-sm sm:text-base transition-colors mt-auto">
                    <span>Read More</span>
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                      <path d="M7 17L17 7M17 7H7M17 7V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                </div>
              </div>
            </a>
            );
          })}

          <!-- View All Posts Card -->
          <a href="/blog" class="blog-card flex-shrink-0 w-[calc(100vw-5rem)] sm:w-[calc(100vw-8rem)] lg:w-[calc((100%-3rem)/3)] snap-start relative group" data-index={blogData.blogs.length}>
            <!-- Single Card -->
            <div class="bg-white border border-gray-200 rounded-2xl p-6 sm:p-8 lg:p-10 shadow-xl flex flex-col items-center justify-center h-full min-h-[320px] sm:min-h-[360px] lg:min-h-[400px] transition-transform duration-300 group-hover:-translate-y-1">
              <h3 class="text-xl sm:text-2xl lg:text-3xl font-playfair font-bold text-gray-900 mb-3 sm:mb-4">
                View All Posts
              </h3>
              <p class="text-gray-700 font-inter text-center mb-6 text-sm sm:text-base">
                Explore all our blog articles and stories
              </p>
              
              <div class="flex items-center gap-3 bg-[#ad986c] hover:bg-[#8a7454] text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-full font-inter font-medium text-sm transition-all duration-300 hover:-translate-y-0.5">
                <span>View All Posts</span>
                <svg class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none">
                  <path d="M7 17L17 7M17 7H7M17 7V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- Pagination Dots -->
      <div id="blogPaginationDots" class="flex justify-center items-center gap-2 mt-8 sm:mt-12">
        {Array.from({ length: Math.ceil((blogData.blogs.length + 1) / 3) }, (_, i) => (
          <button 
            class={`pagination-dot transition-all duration-300 ${i === 0 ? 'w-8 h-2' : 'w-2 h-2 bg-gray-300'} rounded-full`}
            style={i === 0 ? 'background-color: #ad986c;' : ''}
            data-page={i}
            onclick={`goToBlogPage(${i})`}
            aria-label={`Go to page ${i + 1}`}
          ></button>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }
  
  /* Smooth scroll for mobile carousel */
  .overflow-x-auto {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
  }
  
  .overflow-x-auto::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }
  
  /* Smooth transitions */
  .blog-card {
    transition: all 0.3s ease;
    position: relative;
  }
  
  /* White overlay for cards outside main view */
  .blog-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.7);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 5;
    border-radius: 1rem;
  }
  
  /* Show overlay on cards outside main view */
  .blog-card.card-hidden::after {
    opacity: 1;
  }
  
  /* Desktop only: Active/Inactive card states */
  @media (min-width: 1024px) {
    .blog-card.active-desktop {
      transform: scale(1.08);
      z-index: 10;
    }
    
    .blog-card.inactive-desktop {
      opacity: 0.65;
      transform: scale(0.90);
    }
  }
</style>

<script>
  // Carousel functionality
  let currentBlogPage = 0;
  let blogsPerPage = 3; // Default: Show 3 cards at a time on desktop
  let totalBlogCards = 0;
  let totalBlogPages = 0;
  const isBlogDesktop = () => window.innerWidth >= 1024;
  const BLOG_GAP_WIDTH = 24; // lg:gap-6 = 24px
  const blogCardMetrics = {
    width: 0
  };
  let blogResizeObserver;

  function measureBlogCardWidth(card) {
    if (!card) return;
    const { width } = card.getBoundingClientRect();
    if (width && Math.abs(width - blogCardMetrics.width) > 0.5) {
      blogCardMetrics.width = width;
    }
  }

  function setupBlogMeasurement(cards) {
    if (!cards || cards.length === 0) return;
    const firstCard = cards[0];
    measureBlogCardWidth(firstCard);

    if (typeof ResizeObserver !== 'undefined' && !blogResizeObserver) {
      blogResizeObserver = new ResizeObserver((entries) => {
        const entry = entries[0];
        if (!entry) return;
        measureBlogCardWidth(entry.target);
        window.requestAnimationFrame(updateBlogsCarousel);
      });
      blogResizeObserver.observe(firstCard);
    }
  }

  function initBlogsCarousel() {
    const cards = document.querySelectorAll('.blog-card');
    totalBlogCards = cards.length;
    
    // If 5 or fewer cards total (4 blogs + 1 "View All" card), show all at once on desktop
    if (isBlogDesktop() && totalBlogCards <= 5) {
      blogsPerPage = totalBlogCards;
      
      // Update card widths to fit all cards
      cards.forEach(card => {
        if (totalBlogCards === 4) {
          card.classList.remove('lg:w-[calc((100%-3rem)/3)]');
          card.classList.add('lg:w-[calc((100%-4.5rem)/4)]'); // 4 cards with gaps
        } else if (totalBlogCards === 5) {
          card.classList.remove('lg:w-[calc((100%-3rem)/3)]');
          card.classList.add('lg:w-[calc((100%-6rem)/5)]'); // 5 cards with gaps
        }
      });
    } else {
      blogsPerPage = 3;
    }
    
    totalBlogPages = Math.ceil(totalBlogCards / blogsPerPage);

    setupBlogMeasurement(cards);
    
    // Hide navigation if all cards are visible
    if (totalBlogPages <= 1) {
      const prevBtn = document.querySelector('button[onclick="previousBlogCard()"]');
      const nextBtn = document.querySelector('button[onclick="nextBlogCard()"]');
      const dots = document.getElementById('blogPaginationDots');
      
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
      if (dots) dots.style.display = 'none';
    } else {
      // Show navigation if needed
      const prevBtn = document.querySelector('button[onclick="previousBlogCard()"]');
      const nextBtn = document.querySelector('button[onclick="nextBlogCard()"]');
      const dots = document.getElementById('blogPaginationDots');
      
      if (prevBtn) prevBtn.style.display = '';
      if (nextBtn) nextBtn.style.display = '';
      if (dots) dots.style.display = '';
    }
    
    updateBlogsCarousel();
  }

  function updateBlogsCarousel() {
    if (!isBlogDesktop()) {
      // Mobile: no transform, use native scroll
      const container = document.getElementById('blogsContainer');
      if (container) {
        container.style.transform = 'translateX(0)';
      }
      // Remove all overlays on mobile
      const cards = document.querySelectorAll('.blog-card');
      cards.forEach(card => card.classList.remove('card-hidden'));
      return;
    }
    
    // Desktop: show 3 cards at a time with transform
    const container = document.getElementById('blogsContainer');
    const cards = document.querySelectorAll('.blog-card');
    const dots = document.querySelectorAll('#blogPaginationDots .pagination-dot');
    
    if (!container || cards.length === 0) return;
    
    // Calculate the offset based on card index
    const firstCard = cards[0];
    if (!firstCard) return;

    if (!blogCardMetrics.width) {
      measureBlogCardWidth(firstCard);
    }

    const cardWidth = blogCardMetrics.width;
    const gapWidth = BLOG_GAP_WIDTH;
    if (!cardWidth) return;
    
    // Calculate how much to move: (cardWidth + gap) * blogsPerPage * currentBlogPage
    const offsetPx = (cardWidth + gapWidth) * blogsPerPage * currentBlogPage;
    
    container.style.transform = `translateX(-${offsetPx}px)`;
    
    // Update card overlays - show overlay on cards outside current view
    const firstVisibleIndex = currentBlogPage * blogsPerPage;
    const lastVisibleIndex = firstVisibleIndex + blogsPerPage - 1;
    
    cards.forEach((card, index) => {
      if (index < firstVisibleIndex || index > lastVisibleIndex) {
        card.classList.add('card-hidden');
      } else {
        card.classList.remove('card-hidden');
      }
    });
    
    // Update dots
    dots.forEach((dot, index) => {
      if (index === currentBlogPage) {
        dot.classList.remove('w-2', 'bg-gray-300');
        dot.classList.add('w-8');
        dot.style.backgroundColor = '#ad986c'; // Gold color
      } else {
        dot.classList.remove('w-8');
        dot.classList.add('w-2', 'bg-gray-300');
        dot.style.backgroundColor = '';
      }
    });
    
    // Show/hide navigation arrows based on position
    const prevBtn = document.querySelector('button[onclick="previousBlogCard()"]');
    const nextBtn = document.querySelector('button[onclick="nextBlogCard()"]');
    
    if (prevBtn) {
      prevBtn.style.opacity = currentBlogPage === 0 ? '0.3' : '1';
      prevBtn.style.pointerEvents = currentBlogPage === 0 ? 'none' : 'auto';
    }
    
    if (nextBtn) {
      nextBtn.style.opacity = currentBlogPage >= totalBlogPages - 1 ? '0.3' : '1';
      nextBtn.style.pointerEvents = currentBlogPage >= totalBlogPages - 1 ? 'none' : 'auto';
    }
  }

  function nextBlogCard() {
    if (currentBlogPage < totalBlogPages - 1) {
      currentBlogPage++;
      updateBlogsCarousel();
    }
  }

  function previousBlogCard() {
    if (currentBlogPage > 0) {
      currentBlogPage--;
      updateBlogsCarousel();
    }
  }
  
  function goToBlogPage(pageIndex) {
    currentBlogPage = pageIndex;
    updateBlogsCarousel();
  }
  
  // Make functions globally accessible
  window.nextBlogCard = nextBlogCard;
  window.previousBlogCard = previousBlogCard;
  window.goToBlogPage = goToBlogPage;

  // Update pagination dots on mobile scroll
  function updateBlogDotsOnScroll() {
    if (isBlogDesktop()) return;
    
    const container = document.getElementById('blogsContainer');
    const cards = document.querySelectorAll('.blog-card');
    const dots = document.querySelectorAll('#blogPaginationDots .pagination-dot');
    
    if (!container || cards.length === 0) return;
    
    // Calculate which card is most in view
    const containerRect = container.getBoundingClientRect();
    const containerCenter = containerRect.left + (containerRect.width / 2);
    
    let closestIndex = 0;
    let closestDistance = Infinity;
    
    cards.forEach((card, index) => {
      const cardRect = card.getBoundingClientRect();
      const cardCenter = cardRect.left + (cardRect.width / 2);
      const distance = Math.abs(cardCenter - containerCenter);
      
      if (distance < closestDistance) {
        closestDistance = distance;
        closestIndex = index;
      }
    });
    
    // Update current page for dots (groups of 3)
    const dotIndex = Math.floor(closestIndex / 3);
    
    // Update dots appearance
    dots.forEach((dot, index) => {
      if (index === dotIndex) {
        dot.classList.remove('w-2', 'bg-gray-300');
        dot.classList.add('w-8');
        dot.style.backgroundColor = '#ad986c';
      } else {
        dot.classList.remove('w-8');
        dot.classList.add('w-2', 'bg-gray-300');
        dot.style.backgroundColor = '';
      }
    });
  }

  // Initialize carousel on page load
  document.addEventListener('DOMContentLoaded', () => {
    initBlogsCarousel();
    
    // Add scroll listener for mobile
    const container = document.getElementById('blogsContainer');
    if (container) {
      container.addEventListener('scroll', updateBlogDotsOnScroll);
    }
    
    // Re-initialize on window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        initBlogsCarousel();
      }, 250);
    });
  });
</script>
