---
// Waiting List Modal Component
// Reusable modal for collecting waiting list signups for sold-out events
---

<!-- Waiting List Modal -->
<div id="waitingListModal" class="hidden fixed inset-0 z-50 bg-black/75 flex items-center justify-center p-4 overflow-y-auto">
  <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl relative my-8">
    <!-- Close Button -->
    <button
      id="closeWaitingListModal"
      class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Close modal"
      type="button"
    >
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Modal Header -->
    <div class="text-center mb-6">
      <h2 class="text-2xl font-playfair font-bold text-gray-900 mb-2">Join Waiting List</h2>
      <p class="text-sm font-inter text-gray-600">We'll notify you if a space becomes available for this event.</p>
    </div>

    <!-- Success Message (Hidden by default) -->
    <div id="waitingListSuccess" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
      <p class="text-sm font-inter text-green-800 text-center">
        <strong>Thank you!</strong> You've been added to the waiting list. We'll be in touch if a space becomes available.
      </p>
    </div>

    <!-- Error Message (Hidden by default) -->
    <div id="waitingListError" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-sm font-inter text-red-800 text-center" id="waitingListErrorText">
        Something went wrong. Please try again.
      </p>
    </div>

    <!-- Waiting List Form -->
    <form id="waitingListForm" class="space-y-4">
      <!-- Event Details (Auto-populated, Hidden) -->
      <input type="hidden" id="eventStartDate" name="eventStartDate" />
      <input type="hidden" id="eventEndDate" name="eventEndDate" />
      <input type="hidden" id="eventLocation" name="eventLocation" />
      <input type="hidden" id="eventVenuePlainText" name="eventVenuePlainText" />

      <!-- Event Details Display (Read-only) -->
      <div class="bg-gray-50 p-4 rounded-lg space-y-2">
        <div class="text-sm font-inter">
          <span class="text-gray-600">Event: </span>
          <span class="font-semibold text-gray-900" id="displayEventName">-</span>
        </div>
        <div class="text-sm font-inter">
          <span class="text-gray-600">Dates: </span>
          <span class="font-semibold text-gray-900" id="displayEventDates">-</span>
        </div>
      </div>

      <!-- First Name -->
      <div>
        <label for="firstName" class="block text-sm font-inter font-semibold text-gray-900 mb-2">
          First Name <span class="text-red-500 ml-1">*</span>
        </label>
        <input
          type="text"
          id="firstName"
          name="firstName"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
          placeholder="Enter your first name"
        />
      </div>

      <!-- Surname -->
      <div>
        <label for="surname" class="block text-sm font-inter font-semibold text-gray-900 mb-2">
          Surname <span class="text-red-500 ml-1">*</span>
        </label>
        <input
          type="text"
          id="surname"
          name="surname"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
          placeholder="Enter your surname"
        />
      </div>

      <!-- Email Address -->
      <div>
        <label for="email" class="block text-sm font-inter font-semibold text-gray-900 mb-2">
          Email Address <span class="text-red-500 ml-1">*</span>
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
          placeholder="your@email.com"
        />
      </div>

      <!-- Number of People -->
      <div>
        <label for="numberOfPeople" class="block text-sm font-inter font-semibold text-gray-900 mb-2">
          Number of People <span class="text-red-500 ml-1">*</span>
        </label>
        <input
          type="number"
          id="numberOfPeople"
          name="numberOfPeople"
          required
          min="1"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
          placeholder="Enter number of people"
        />
      </div>

      <!-- Consent Checkbox -->
      <div class="flex items-start">
        <input
          type="checkbox"
          id="consent"
          name="consent"
          required
          class="mt-1 h-4 w-4 text-[#ad986c] border-gray-300 rounded focus:ring-[#ad986c] focus:ring-2"
        />
        <label for="consent" class="ml-2 text-sm font-inter text-gray-700">
          I consent to updates from Active Away <span class="text-red-500">*</span>
        </label>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        id="waitingListSubmit"
        disabled
        class="w-full bg-[#ad986c] hover:bg-[#8a7454] text-white font-inter font-semibold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Join Waiting List
      </button>
    </form>
  </div>
</div>

<script>
  // Waiting List Modal Logic
  const waitingListModal = document.getElementById('waitingListModal');
  const waitingListForm = document.getElementById('waitingListForm') as HTMLFormElement;
  const closeModalBtn = document.getElementById('closeWaitingListModal');
  const submitButton = document.getElementById('waitingListSubmit') as HTMLButtonElement;
  const successMessage = document.getElementById('waitingListSuccess');
  const errorMessage = document.getElementById('waitingListError');
  const errorText = document.getElementById('waitingListErrorText');

  // Form fields
  const firstNameInput = document.getElementById('firstName') as HTMLInputElement;
  const surnameInput = document.getElementById('surname') as HTMLInputElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const numberOfPeopleInput = document.getElementById('numberOfPeople') as HTMLInputElement;
  const consentInput = document.getElementById('consent') as HTMLInputElement;
  const eventStartDateInput = document.getElementById('eventStartDate') as HTMLInputElement;
  const eventEndDateInput = document.getElementById('eventEndDate') as HTMLInputElement;
  const eventLocationInput = document.getElementById('eventLocation') as HTMLInputElement;
  const eventVenuePlainTextInput = document.getElementById('eventVenuePlainText') as HTMLInputElement;

  // Display elements
  const displayEventName = document.getElementById('displayEventName');
  const displayEventDates = document.getElementById('displayEventDates');

  // Webhook URL (not visible in HTML)
  const WEBHOOK_URL = 'https://hook.eu1.make.com/ug8yvdco9x7arpu5taa5ebdp13807okv';

  // Open modal function
  function openWaitingListModal(eventStart: string, eventEnd: string, eventName: string, venuePlainText: string) {
    if (!waitingListModal) return;
    
    // Populate hidden fields
    if (eventStartDateInput) eventStartDateInput.value = eventStart;
    if (eventEndDateInput) eventEndDateInput.value = eventEnd;
    if (eventLocationInput) eventLocationInput.value = eventName;
    if (eventVenuePlainTextInput) eventVenuePlainTextInput.value = venuePlainText;
    
    // Format and display event details
    if (displayEventName) displayEventName.textContent = eventName;
    if (displayEventDates && eventStart && eventEnd) {
      // Parse dates properly (they come in YYYY-MM-DD format)
      const startParts = eventStart.split('-');
      const endParts = eventEnd.split('-');
      
      const startDate = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
      const endDate = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));
      
      const formattedStart = startDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      const formattedEnd = endDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      displayEventDates.textContent = `${formattedStart} - ${formattedEnd}`;
    }
    
    // Show modal
    waitingListModal.classList.remove('hidden');
    
    // Hide messages
    if (successMessage) successMessage.classList.add('hidden');
    if (errorMessage) errorMessage.classList.add('hidden');
    
    // Reset form and validation
    if (waitingListForm) waitingListForm.reset();
    validateWaitingListForm();
  }

  // Close modal function
  function closeWaitingListModal() {
    if (!waitingListModal) return;
    waitingListModal.classList.add('hidden');
    if (waitingListForm) waitingListForm.reset();
    if (successMessage) successMessage.classList.add('hidden');
    if (errorMessage) errorMessage.classList.add('hidden');
  }

  // Form validation function
  function validateWaitingListForm() {
    if (!submitButton) return;
    
    const firstName = firstNameInput?.value.trim() || '';
    const surname = surnameInput?.value.trim() || '';
    const email = emailInput?.value.trim() || '';
    const numberOfPeople = numberOfPeopleInput?.value.trim() || '';
    const consent = consentInput?.checked || false;
    
    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const isEmailValid = emailRegex.test(email);
    
    // Number validation (must be at least 1)
    const numberOfPeopleNum = parseInt(numberOfPeople);
    const isNumberValid = numberOfPeople !== '' && numberOfPeopleNum >= 1;
    
    // Enable button only if all fields are valid
    const allValid = firstName !== '' && surname !== '' && isEmailValid && isNumberValid && consent;
    submitButton.disabled = !allValid;
  }

  // Add event listeners for validation
  if (firstNameInput) firstNameInput.addEventListener('input', validateWaitingListForm);
  if (surnameInput) surnameInput.addEventListener('input', validateWaitingListForm);
  if (emailInput) emailInput.addEventListener('input', validateWaitingListForm);
  if (numberOfPeopleInput) numberOfPeopleInput.addEventListener('input', validateWaitingListForm);
  if (consentInput) consentInput.addEventListener('change', validateWaitingListForm);

  // Close button event
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeWaitingListModal);
  }

  // Close on overlay click
  if (waitingListModal) {
    waitingListModal.addEventListener('click', (e) => {
      if (e.target === waitingListModal) {
        closeWaitingListModal();
      }
    });
  }

  // Form submission
  if (waitingListForm) {
    waitingListForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Hide messages
      if (successMessage) successMessage.classList.add('hidden');
      if (errorMessage) errorMessage.classList.add('hidden');
      
      // Disable submit button during submission
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
      }
      
      // Prepare form data
      const formData = {
        eventStartDate: eventStartDateInput?.value || '',
        eventEndDate: eventEndDateInput?.value || '',
        eventTitle: eventLocationInput?.value || '',
        eventLocation: eventVenuePlainTextInput?.value || '',
        firstName: firstNameInput?.value.trim() || '',
        surname: surnameInput?.value.trim() || '',
        email: emailInput?.value.trim() || '',
        numberOfPeople: numberOfPeopleInput?.value.trim() || '',
        consent: consentInput?.checked ? 'Yes' : 'No'
      };
      
      try {
        // Submit to webhook
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });
        
        if (response.ok) {
          // Show success message
          if (successMessage) successMessage.classList.remove('hidden');
          
          // Close modal after 2 seconds
          setTimeout(() => {
            closeWaitingListModal();
          }, 2000);
        } else {
          throw new Error('Submission failed');
        }
      } catch (error) {
        console.error('Error submitting waiting list form:', error);
        
        // Show error message
        if (errorMessage) errorMessage.classList.remove('hidden');
        if (errorText) errorText.textContent = 'Something went wrong. Please try again.';
        
        // Re-enable submit button
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Join Waiting List';
        }
        
        // Re-validate form
        validateWaitingListForm();
      }
    });
  }

  // Make function globally available
  (window as any).openWaitingListModal = openWaitingListModal;

  // Initial validation on load
  validateWaitingListForm();
</script>

