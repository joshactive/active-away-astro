---
// Product Hero section component for Active Away product pages - Tailwind CSS Version
import { getStrapiImageAttrs } from '../utils/cloudflareImages.js';

interface Props {
  productData?: any;
}

const { productData } = Astro.props;

// Extract hero data with fallbacks
const heroData = {
  kicker: productData?.hero?.kicker || 'ADULT ONLY TENNIS HOLIDAYS',
  heading: productData?.hero?.heading || 'Tennis Holidays for Adults',
  subheading: productData?.hero?.subheading || 'Unique Racket Experiences that unite like-minded individuals, through impeccable service delivered by truly knowledgeable hosts in excellent locations.',
  backgroundImage: productData?.hero?.backgroundImage || {
    url: 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/99097811-3e4c-47a0-00f4-92d14d4bb700/public',
    alt: 'Tennis court background'
  },
  heroImages: productData?.hero?.heroImages || [],
  buttonText: productData?.hero?.buttonText || 'View Destinations',
  buttonLink: productData?.hero?.buttonLink || '#destinations',
  mediaType: productData?.hero?.mediaType || 'split-screen-video',
  videoUrl: productData?.hero?.videoUrl || 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
  rightSideImage: productData?.hero?.rightSideImage || {
    url: 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/a5c7fc48-dfbc-4923-a015-20f2d9d31700/public',
    alt: 'Tennis players celebrating on court'
  }
};

// Process background image
let backgroundImageAttrs = null;
if (heroData.backgroundImage) {
  const imageUrl = heroData.backgroundImage.url || heroData.backgroundImage;
  const imageAlt = heroData.backgroundImage.alt || heroData.backgroundImage.alternativeText || heroData.heading;
  
  if (typeof imageUrl === 'string') {
    backgroundImageAttrs = getStrapiImageAttrs(
      { url: imageUrl, alt: imageAlt },
      {
        displayWidth: 1920,
        displayHeight: 1080,
        fit: 'cover',
        sizes: '100vw',
        quality: 75
      }
    );
    
    if (!backgroundImageAttrs) {
      backgroundImageAttrs = {
        src: imageUrl,
        url: imageUrl,
        alt: imageAlt,
        loading: 'eager'
      };
    }
  }
}

// Process right side image (for split-screen)
let rightSideImageAttrs = null;
if (heroData.rightSideImage) {
  const imageUrl = heroData.rightSideImage.url || heroData.rightSideImage;
  const imageAlt = heroData.rightSideImage.alt || heroData.rightSideImage.alternativeText || 'Hero image';
  
  if (typeof imageUrl === 'string') {
    rightSideImageAttrs = getStrapiImageAttrs(
      { url: imageUrl, alt: imageAlt },
      {
        displayWidth: 800,
        displayHeight: 600,
        fit: 'cover',
        sizes: '(max-width: 1024px) 100vw, 50vw',
        quality: 80
      }
    );
    
    if (!rightSideImageAttrs) {
      rightSideImageAttrs = {
        src: imageUrl,
        url: imageUrl,
        alt: imageAlt,
        loading: 'eager'
      };
    }
  }
}

// Extract YouTube ID from URL
function extractYouTubeId(url: string) {
  if (!url) return null;
  try {
    const parsed = new URL(url);
    if (parsed.hostname.includes('youtu.be')) {
      return parsed.pathname.replace('/', '');
    }
    if (parsed.searchParams.has('v')) {
      return parsed.searchParams.get('v');
    }
    const pathSegments = parsed.pathname.split('/').filter(Boolean);
    if (pathSegments[0] === 'embed' && pathSegments[1]) {
      return pathSegments[1];
    }
  } catch (error) {
    console.warn('Unable to parse YouTube URL', url, error);
  }
  return null;
}

const youTubeId = heroData.videoUrl ? extractYouTubeId(heroData.videoUrl) : null;
const youTubeThumbnail = youTubeId ? `https://i.ytimg.com/vi/${youTubeId}/maxresdefault.jpg` : null;

const isSplitScreen = heroData.mediaType === 'split-screen-image' || heroData.mediaType === 'split-screen-video';
---

{isSplitScreen ? (
  <!-- Split-Screen Hero Layout with Background -->
  <section class="relative w-full min-h-[600px] sm:min-h-[700px] lg:min-h-[700px] overflow-hidden">
    <!-- Background Image -->
    {backgroundImageAttrs && (
      <img 
        src={backgroundImageAttrs.src || backgroundImageAttrs.url}
        {...(backgroundImageAttrs.srcset && { srcset: backgroundImageAttrs.srcset })}
        {...(backgroundImageAttrs.sizes && { sizes: backgroundImageAttrs.sizes })}
        alt={backgroundImageAttrs.alt || heroData.heading}
        width={backgroundImageAttrs.width || 1920}
        height={backgroundImageAttrs.height || 1080}
        class="absolute inset-0 w-full h-full object-cover"
        fetchpriority="high"
        decoding="async"
      />
    )}
    
    <!-- Dark Overlay -->
    <div class="absolute inset-0 bg-gradient-to-r from-[#0D1C4E]/90 via-[#0D1C4E]/70 to-[#0D1C4E]/50 z-10"></div>
    
    <!-- Content Container -->
    <div class="relative z-20 h-full">
      <div class="lg:container lg:mx-auto lg:max-w-[1400px]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 min-h-[600px] sm:min-h-[700px] lg:min-h-[700px] items-center px-4 sm:px-10 py-24 sm:py-32 lg:py-20">
          
          <!-- Left Side - Content -->
          <div class="flex flex-col justify-center text-left">
          <!-- Kicker -->
          {heroData.kicker && (
            <div class="hidden sm:block text-xs sm:text-sm font-inter font-semibold text-gold tracking-[0.2em] uppercase mb-4 sm:mb-6">
              {heroData.kicker}
            </div>
          )}
          
          <!-- Heading -->
          <h1 class="text-4xl sm:text-5xl lg:text-6xl xl:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight">
            {heroData.heading}
          </h1>
          
          <!-- Subheading -->
          {heroData.subheading && (
            <div class="text-base sm:text-lg lg:text-xl font-inter text-white mb-8 sm:mb-10 leading-relaxed max-w-none prose prose-invert">
              <Fragment set:html={heroData.subheading} />
            </div>
          )}
          
          <!-- CTA Button -->
          {heroData.buttonText && (
            <div>
              <a 
                href={heroData.buttonLink || '#'}
                class="inline-flex items-center gap-3 bg-transparent hover:bg-white/10 text-white border-2 border-white px-6 sm:px-8 py-3 sm:py-4 rounded-full font-inter font-semibold text-base sm:text-lg transition-all duration-300 scroll-smooth"
              >
                <span>{heroData.buttonText}</span>
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            </div>
          )}
        </div>
        
        <!-- Right Side - Video/Image Card -->
        <div class="flex items-center justify-center lg:justify-end">
          {heroData.mediaType === 'split-screen-video' && youTubeId ? (
            <!-- Video Card -->
            <div class="w-full max-w-md lg:max-w-lg xl:max-w-xl rounded-2xl overflow-hidden shadow-2xl">
              <div class="relative aspect-video bg-gray-900">
                <button 
                  type="button"
                  class="lite-youtube-split group w-full h-full"
                  data-video-id={youTubeId}
                  aria-label={`Play ${heroData.heading} video`}
                >
                  {youTubeThumbnail && (
                    <img 
                      src={youTubeThumbnail}
                      alt={`${heroData.heading} video thumbnail`}
                      loading="lazy"
                      decoding="async"
                      class="absolute inset-0 w-full h-full object-cover"
                      fetchpriority="low"
                    />
                  )}
                  <div class="absolute inset-0 bg-black/20"></div>
                  <span class="lite-youtube__play"></span>
                </button>
              </div>
            </div>
          ) : heroData.mediaType === 'split-screen-image' && rightSideImageAttrs ? (
            <!-- Image Card -->
            <div class="w-full max-w-md lg:max-w-lg xl:max-w-xl rounded-2xl overflow-hidden shadow-2xl">
              <img 
                src={rightSideImageAttrs.src || rightSideImageAttrs.url}
                {...(rightSideImageAttrs.srcset && { srcset: rightSideImageAttrs.srcset })}
                {...(rightSideImageAttrs.sizes && { sizes: rightSideImageAttrs.sizes })}
                alt={rightSideImageAttrs.alt}
                width={rightSideImageAttrs.width || 800}
                height={rightSideImageAttrs.height || 600}
                class="w-full h-auto object-cover"
                fetchpriority="high"
                decoding="async"
              />
            </div>
          ) : null}
        </div>
          
        </div>
      </div>
    </div>
  </section>
) : (
  <!-- Fullscreen Background Hero Layout (Original) -->
  <section class="relative w-full h-[400px] sm:h-[500px] lg:h-[600px] overflow-hidden pt-24 md:pt-32 lg:pt-0">
    <!-- Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-b from-[#0D1C4E]/75 via-[#0D1C4E]/60 to-[#0D1C4E]/60 z-10"></div>
    
    <!-- Background Image -->
    {backgroundImageAttrs && (
      <img 
        src={backgroundImageAttrs.src || backgroundImageAttrs.url}
        {...(backgroundImageAttrs.srcset && { srcset: backgroundImageAttrs.srcset })}
        {...(backgroundImageAttrs.sizes && { sizes: backgroundImageAttrs.sizes })}
        alt={backgroundImageAttrs.alt || heroData.heading}
        width={backgroundImageAttrs.width || 1920}
        height={backgroundImageAttrs.height || 1080}
        class="absolute inset-0 w-full h-full object-cover"
        fetchpriority="high"
        decoding="async"
      />
    )}
    
    <!-- Content -->
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <!-- Kicker -->
      {heroData.kicker && (
        <div class="hidden sm:block text-xs sm:text-sm font-inter font-semibold text-gold tracking-[0.2em] uppercase mb-4 sm:mb-6 border-t border-b border-gold/50 py-2 px-6">
          {heroData.kicker}
        </div>
      )}
      
      <!-- Heading -->
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {heroData.heading}
      </h1>
      
      <!-- Subheading -->
      {heroData.subheading && (
        <div class="text-lg sm:text-xl lg:text-2xl font-inter text-white max-w-3xl leading-relaxed prose prose-invert">
          <Fragment set:html={heroData.subheading} />
        </div>
      )}
      
      <!-- CTA Button -->
      {heroData.buttonText && (
        <div class="mt-8">
          <a 
            href={heroData.buttonLink || '#'}
            class="inline-flex items-center gap-3 bg-transparent hover:bg-white/10 text-white border-2 border-white px-6 sm:px-8 py-3 sm:py-4 rounded-full font-inter font-semibold text-base sm:text-lg transition-all duration-300"
          >
            <span>{heroData.buttonText}</span>
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
              <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      )}
    </div>
  </section>
)}

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }
  
  /* Ensure prose styling works with the text color */
  .prose-invert p {
    color: rgb(255 255 255) !important;
    margin: 0 0 0.75rem 0;
  }
  
  .prose-invert p:last-child {
    margin-bottom: 0;
  }
  
  /* Force white text for subheading */
  .text-white p,
  .text-white {
    color: rgb(255 255 255) !important;
  }
  
  /* YouTube Video Player Styles */
  .lite-youtube-split {
    position: relative;
    display: block;
    width: 100%;
    height: 100%;
    background-color: #000;
    cursor: pointer;
    border: none;
    padding: 0;
  }

  .lite-youtube-split img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .lite-youtube__play {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 80px;
    height: 60px;
    transform: translate(-50%, -50%);
    background: rgba(33, 33, 33, 0.8);
    border-radius: 14px;
    transition: background 0.3s ease;
    z-index: 10;
  }

  .lite-youtube__play::before {
    content: '';
    position: absolute;
    left: 28px;
    top: 18px;
    border-style: solid;
    border-width: 12px 0 12px 20px;
    border-color: transparent transparent transparent #fff;
  }

  .lite-youtube-split:hover .lite-youtube__play {
    background: rgba(214, 0, 0, 0.9);
  }
</style>

{youTubeId && (
  <script is:inline>
    // Optimized lazy-loaded YouTube embed
    document.addEventListener('DOMContentLoaded', () => {
      // Use Intersection Observer for lazy initialization
      const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const trigger = entry.target;
            // Only add click listener when video is in viewport
            if (!trigger.dataset.initialized) {
              trigger.dataset.initialized = 'true';
              trigger.addEventListener('click', () => {
                const videoId = trigger.getAttribute('data-video-id');
                if (!videoId) return;
                
                const iframe = document.createElement('iframe');
                iframe.setAttribute('allowfullscreen', '');
                iframe.setAttribute('loading', 'lazy');
                iframe.setAttribute('title', 'Product video');
                iframe.setAttribute(
                  'src',
                  `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`
                );
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                iframe.style.position = 'absolute';
                iframe.style.inset = '0';
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';

                const wrapper = document.createElement('div');
                wrapper.style.position = 'absolute';
                wrapper.style.inset = '0';
                wrapper.style.width = '100%';
                wrapper.style.height = '100%';
                wrapper.appendChild(iframe);

                trigger.replaceWith(wrapper);
              }, { once: true });
            }
          }
        });
      }, {
        rootMargin: '100px', // Start loading 100px before viewport
        threshold: 0.1
      });

      document.querySelectorAll('.lite-youtube-split').forEach((trigger) => {
        videoObserver.observe(trigger);
      });
    });
  </script>
)}

