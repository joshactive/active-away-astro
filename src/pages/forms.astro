---
// Forms archive page
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import { getForms, getFormsPage, getFormsPageSEO } from '../utils/strapi.js';

// Fetch forms page content from Strapi
let pageContent = null;
try {
  pageContent = await getFormsPage();
  console.log('üìù [forms.astro] Forms page content fetched successfully');
} catch (error) {
  console.warn('[forms.astro] Could not fetch forms page content, using defaults:', error.message);
}

// Fetch SEO data from Strapi
let seoData = null;
try {
  seoData = await getFormsPageSEO();
  if (seoData) {
    console.log('üìÑ [forms.astro] SEO data fetched successfully');
  }
} catch (error) {
  console.warn('[forms.astro] Could not fetch SEO data:', error.message);
}

// Fetch forms data
let forms = [];
try {
  forms = await getForms(1, 100);
  
  // Sort by title A-Z by default
  forms.sort((a, b) => a.title.localeCompare(b.title));
  
  console.log('üìù [forms.astro] Forms data fetched successfully:', forms.length, 'items');
} catch (error) {
  console.error('[forms.astro] Error fetching forms:', error.message);
}

// Extract page content with fallbacks
const heroTitle = pageContent?.hero?.title || 'Forms';
const heroSubtitle = pageContent?.hero?.subtitle || 'Get in touch with us using one of our contact forms below.';
const heroKicker = pageContent?.hero?.kicker || 'GET IN TOUCH';
const heroBackgroundImage = pageContent?.hero?.backgroundImage?.url || 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/45b69090-1c22-46cd-7f98-086ba71efc00/public';
const heroBackgroundImageAlt = pageContent?.hero?.backgroundImage?.alt || 'Contact forms';

// Extract SEO fields with fallbacks
const pageTitle = seoData?.metaTitle || pageContent?.meta?.title || 'Forms - Active Away';
const pageDescription = seoData?.metaDescription || pageContent?.meta?.description || 'Contact Active Away using our forms.';
const metaImage = seoData?.metaImage || null;
const metaImageAlt = seoData?.metaImageAlt || null;
const metaImageWidth = seoData?.metaImageWidth || null;
const metaImageHeight = seoData?.metaImageHeight || null;
const keywords = seoData?.keywords || null;
const canonicalURL = seoData?.canonicalURL || 'https://activeaway.com/forms';
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section with Background Image -->
  <section class="relative w-full h-[400px] sm:h-[500px] lg:h-[600px] overflow-hidden">
    <!-- Background Image -->
    <div class="absolute inset-0 bg-gradient-to-r from-[#0D1C4E]/90 to-[#0D1C4E]/70 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt={heroBackgroundImageAlt}
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <!-- Centered Content -->
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <div class="hidden sm:block text-xs sm:text-sm font-inter font-semibold text-gold tracking-[0.2em] uppercase mb-4 sm:mb-6 border-t border-b border-gold/50 py-2 px-6">
        {heroKicker}
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {heroTitle}
      </h1>
      <p class="text-lg sm:text-xl lg:text-2xl font-inter text-gray-100 max-w-3xl leading-relaxed">
        {heroSubtitle}
      </p>
    </div>
  </section>

  <!-- Main Content Section -->
  <section class="w-full bg-white py-12 sm:py-16 lg:py-24">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      
      <!-- Results Header with Sort -->
      <div class="flex items-center justify-between mb-8 pb-4 border-b border-gray-200">
        <div class="text-base sm:text-lg font-inter text-gray-900">
          Showing <span class="font-semibold">{forms.length}</span> {forms.length === 1 ? 'form' : 'forms'}
        </div>
        
        <!-- Sort By Dropdown -->
        <div class="flex items-center gap-3">
          <label for="sortBy" class="text-sm font-inter text-gray-600 hidden sm:block">Sort by</label>
          <div class="relative">
            <select 
              id="sortBy"
              class="appearance-none bg-white border border-gray-300 rounded-lg pl-4 pr-10 py-2.5 text-sm font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all cursor-pointer"
            >
              <option value="title-asc" selected>Title: A to Z</option>
              <option value="title-desc">Title: Z to A</option>
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
            </select>
            <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-600 pointer-events-none" viewBox="0 0 24 24" fill="none">
              <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Forms Grid -->
      {forms.length > 0 ? (
        <div id="formsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {forms.map((form) => (
            <a 
              href={`/forms/${form.slug}/`}
              class="form-card group bg-white border-2 border-gray-200 rounded-2xl p-8 shadow-md hover:shadow-xl hover:border-gold transition-all duration-300 hover:-translate-y-1"
              data-title={form.title}
              data-created={form.createdAt}
            >
              <!-- Content -->
              <div>
                <h2 class="text-xl font-playfair font-semibold text-gray-900 mb-3 leading-tight group-hover:text-[#ad986c] transition-colors">
                  {form.title}
                </h2>
                
                {form.excerpt && (
                  <p class="text-base font-inter text-gray-800 leading-relaxed line-clamp-4">
                    {form.excerpt}
                  </p>
                )}
                
                <!-- Read More Arrow -->
                <div class="mt-6 flex items-center gap-2 text-[#ad986c] font-inter font-semibold">
                  <span>Open Form</span>
                  <svg class="w-5 h-5 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <!-- Empty State -->
        <div class="text-center py-16">
          <svg class="w-24 h-24 mx-auto text-gray-300 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="text-xl font-playfair font-semibold text-gray-900 mb-3">No forms available</h3>
          <p class="text-base font-inter text-gray-800 leading-relaxed mb-6">Check back soon</p>
        </div>
      )}
    </div>
  </section>
</BaseLayout>

<style>
  /* Line clamp for excerpt text */
  .line-clamp-4 {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Sorting functionality
  const sortBySelect = document.getElementById('sortBy');
  const formsGrid = document.getElementById('formsGrid');

  if (sortBySelect && formsGrid) {
    sortBySelect.addEventListener('change', (e) => {
      const sortValue = e.target.value;
      const cards = Array.from(formsGrid.querySelectorAll('.form-card'));
      
      // Sort the cards
      cards.sort((a, b) => {
        switch (sortValue) {
          case 'title-asc':
            return a.dataset.title.localeCompare(b.dataset.title);
          
          case 'title-desc':
            return b.dataset.title.localeCompare(a.dataset.title);
          
          case 'oldest':
            return new Date(a.dataset.created) - new Date(b.dataset.created);
          
          case 'newest':
          default:
            return new Date(b.dataset.created) - new Date(a.dataset.created);
        }
      });
      
      // Re-append cards in sorted order
      cards.forEach(card => formsGrid.appendChild(card));
    });
  }
</script>

