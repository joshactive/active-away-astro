---
// Search Results - Checkfront Booking Page
// Accepts URL parameters: item_ids, start_date, end_date, tid
// Example: /search-results?item_ids=15997&start_date=20260509&end_date=20260516

import BaseLayout from '../layouts/BaseLayout.astro';
import PageHeroTailwind from '../components/PageHeroTailwind.astro';
import BreadcrumbsTailwind from '../components/BreadcrumbsTailwind.astro';
import { getSearchResultsPage, getSearchResultsPageSEO } from '../utils/strapi.js';

// Parse URL query parameters
const url = Astro.url;
const itemIds = url.searchParams.get('item_ids') || '';
const startDate = url.searchParams.get('start_date') || '';
const endDate = url.searchParams.get('end_date') || '';
const trackingId = url.searchParams.get('tid') || '';

// Fetch page content from Strapi
let pageData = null;
try {
  pageData = await getSearchResultsPage();
  console.log('üîç [search-results] Page data fetched');
} catch (error) {
  console.error('‚ùå [search-results] Error fetching page:', error.message);
}

// Fetch SEO data separately
let seoData = null;
try {
  seoData = await getSearchResultsPageSEO();
  if (seoData) {
    console.log('üìÑ [search-results] SEO data fetched');
  }
} catch (error) {
  console.warn('‚ö†Ô∏è  [search-results] Could not fetch SEO data:', error.message);
}

// Handle date formatting (Ymd format: 20260509)
let checkfrontStartDate = startDate;
let checkfrontEndDate = endDate;

// If no dates provided, set defaults
if (!checkfrontStartDate) {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  checkfrontStartDate = `${year}${month}${day}`;
}

if (!checkfrontEndDate) {
  const today = new Date();
  const futureYear = today.getFullYear() + 2;
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  checkfrontEndDate = `${futureYear}${month}${day}`;
}

// Extract SEO fields with fallbacks
const pageTitle = seoData?.metaTitle 
  || pageData?.seo?.metaTitle 
  || 'Event Booking - Active Away';

const pageDescription = seoData?.metaDescription 
  || pageData?.seo?.metaDescription 
  || 'Complete your event booking with Active Away';

const metaImage = seoData?.metaImage || pageData?.seo?.metaImage || null;
const metaImageAlt = seoData?.metaImageAlt || pageData?.seo?.metaImageAlt || null;
const metaImageWidth = seoData?.metaImageWidth || null;
const metaImageHeight = seoData?.metaImageHeight || null;
const keywords = seoData?.keywords || pageData?.seo?.keywords || null;
const canonicalURL = seoData?.canonicalURL || pageData?.seo?.canonicalURL || 'https://activeaway.com/search-results';

// Show warning if no item_ids provided
const hasItems = itemIds !== '';
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
  robots="noindex, nofollow"
>
  <!-- Page Hero -->
  {pageData?.pageHero && (
    <div class="search-results-hero">
      <PageHeroTailwind pageData={pageData} />
    </div>
  )}
  
  <!-- Breadcrumbs -->
  {pageData?.pageHero?.showBreadcrumbs !== false && (
    <BreadcrumbsTailwind 
      breadcrumbs={[
        { label: 'Home', href: '/' },
        { label: 'Event Booking' }
      ]}
    />
  )}

  <!-- Main Content Section -->
  <section class="w-full bg-white py-8 sm:py-12">
    <div class="container mx-auto max-w-[1200px] px-2 sm:px-6 lg:px-8">
      
      {!hasItems ? (
        <!-- Error State: No Items -->
        <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8 text-center max-w-2xl mx-auto">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h2 class="text-2xl font-playfair font-semibold text-gray-900 mb-3">No Event Selected</h2>
          <p class="text-base font-inter text-gray-700 mb-6">
            Please select an event from our events page to view booking availability.
          </p>
          <a 
            href="/events" 
            class="inline-block bg-[#ad986c] hover:bg-[#8d7a56] text-white font-inter font-semibold px-8 py-3 rounded-full transition-colors duration-300"
          >
            View All Events
          </a>
        </div>
      ) : (
        <!-- Checkfront Booking Widget -->
        <div class="location-booking" style="text-align: center;">
          
          <!-- Checkfront Widget Container -->
          <div id="CHECKFRONT_WIDGET_01" style="margin: 0 auto; text-align: center;">
            <p 
              id="CHECKFRONT_LOADER" 
              style="background: url('//activeaway.checkfront.co.uk/images/loader.gif') left center no-repeat; padding: 5px 5px 5px 20px;"
            >
              Searching Availability...
            </p>
          </div>

          <!-- Fallback for users without JavaScript -->
          <noscript>
            <div style="text-align: center; padding: 40px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; margin-top: 20px;">
              <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">JavaScript Required</h3>
              <p style="font-size: 16px; margin-bottom: 24px;">
                Please enable JavaScript to use our booking system.
              </p>
              <a 
                href="https://activeaway.checkfront.co.uk/reserve/" 
                style="display: inline-block; background-color: #ad986c; color: white; padding: 12px 32px; border-radius: 50px; text-decoration: none; font-weight: 600;"
              >
                Continue to Secure Booking System &raquo;
              </a>
            </div>
          </noscript>

        </div>
      )}

    </div>
  </section>
</BaseLayout>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }

  /* Adjust hero height to match blog page */
  .search-results-hero :global(section) {
    height: 300px !important;
  }

  @media (min-width: 640px) {
    .search-results-hero :global(section) {
      height: 400px !important;
    }
  }

  @media (min-width: 1024px) {
    .search-results-hero :global(section) {
      height: 450px !important;
    }
  }

  /* Checkfront widget container */
  .location-booking {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    overflow: visible;
  }

  /* Make Checkfront widget fully responsive and centered */
  :global(#CHECKFRONT_WIDGET_01) {
    font-family: 'Montserrat', 'Inter', sans-serif !important;
    color: #222222;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important;
    text-align: center !important;
  }
  
  :global(#CHECKFRONT_WIDGET_01 *) {
    font-family: 'Montserrat', 'Inter', sans-serif !important;
  }
  
  /* Force main content wrapper to center */
  :global(#CHECKFRONT_WIDGET_01 > div:first-child) {
    display: block !important;
    text-align: center !important;
    margin: 0 auto !important;
  }

  /* Force iframe and container to be responsive */
  :global(#CHECKFRONT_WIDGET_01 iframe) {
    width: 100% !important;
    max-width: 100% !important;
    min-height: 800px !important;
    border: none !important;
    margin: 0 auto !important;
    display: block !important;
  }

  /* Make all Checkfront elements responsive and centered */
  :global(#CHECKFRONT_WIDGET_01 .DROPLET_container),
  :global(#CHECKFRONT_WIDGET_01 .DROPLET_widget),
  :global(#CHECKFRONT_WIDGET_01 .checkfront-container) {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: auto !important;
    margin-right: auto !important;
    text-align: center !important;
    display: flex !important;
    justify-content: center !important;
    flex-wrap: wrap !important;
  }

  /* Center all items/cards inside the widget */
  :global(#CHECKFRONT_WIDGET_01 .item),
  :global(#CHECKFRONT_WIDGET_01 .booking-item),
  :global(#CHECKFRONT_WIDGET_01 .availability-item),
  :global(#CHECKFRONT_WIDGET_01 article),
  :global(#CHECKFRONT_WIDGET_01 > div),
  :global(#CHECKFRONT_WIDGET_01 > div > div) {
    margin-left: auto !important;
    margin-right: auto !important;
    float: none !important;
    display: inline-block !important;
    vertical-align: top !important;
  }

  /* Force grid/list containers to center */
  :global(#CHECKFRONT_WIDGET_01 .items-grid),
  :global(#CHECKFRONT_WIDGET_01 .items-list),
  :global(#CHECKFRONT_WIDGET_01 .availability-grid),
  :global(#CHECKFRONT_WIDGET_01 ul),
  :global(#CHECKFRONT_WIDGET_01 .item-list) {
    display: flex !important;
    justify-content: center !important;
    flex-wrap: wrap !important;
    margin: 0 auto !important;
  }

  /* Make modals/popups responsive */
  :global(#CHECKFRONT_WIDGET_01 .modal),
  :global(#CHECKFRONT_WIDGET_01 .modal-dialog),
  :global(#CHECKFRONT_WIDGET_01 .DROPLET_modal),
  :global(#CHECKFRONT_WIDGET_01 .booking-details),
  :global(#CHECKFRONT_WIDGET_01 .item-details) {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Make item cards responsive and centered */
  :global(#CHECKFRONT_WIDGET_01 .item),
  :global(#CHECKFRONT_WIDGET_01 .item-card),
  :global(#CHECKFRONT_WIDGET_01 .availability-item) {
    width: auto !important;
    max-width: 100% !important;
    float: none !important;
    display: inline-block !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }

  /* Responsive table handling */
  :global(#CHECKFRONT_WIDGET_01 table) {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Force forms and inputs to be responsive */
  :global(#CHECKFRONT_WIDGET_01 form),
  :global(#CHECKFRONT_WIDGET_01 .form-group),
  :global(#CHECKFRONT_WIDGET_01 .form-control) {
    max-width: 100% !important;
  }

  /* Handle mobile breakpoint */
  @media (max-width: 768px) {
    /* Reduce container padding on mobile */
    .location-booking {
      padding: 0 !important;
      margin: 0 !important;
    }

    :global(#CHECKFRONT_WIDGET_01) {
      padding: 0 !important;
      margin: 0 !important;
    }

    :global(#CHECKFRONT_WIDGET_01 iframe) {
      min-height: 600px !important;
    }
    
    /* Make sure modals work well on mobile */
    :global(#CHECKFRONT_WIDGET_01 .modal),
    :global(#CHECKFRONT_WIDGET_01 .modal-dialog) {
      margin: 10px !important;
    }

    /* Ensure items use full width on mobile */
    :global(#CHECKFRONT_WIDGET_01 .item),
    :global(#CHECKFRONT_WIDGET_01 .item-card),
    :global(#CHECKFRONT_WIDGET_01 .availability-item) {
      width: 100% !important;
      max-width: 100% !important;
    }
  }
</style>

{hasItems && (
  <>
    <!-- Load Checkfront library -->
    <script is:inline type="text/javascript" src="//activeaway.checkfront.co.uk/lib/interface--0.js"></script>

    <!-- Initialize Checkfront widget with URL parameters -->
    <script is:inline define:vars={{ itemIds, checkfrontStartDate, checkfrontEndDate, trackingId }}>
      // Wait for DROPLET to be available
      function initCheckfront() {
        if (typeof DROPLET === 'undefined') {
          setTimeout(initCheckfront, 100);
          return;
        }

        try {
          const widgetConfig = {
            host: 'activeaway.checkfront.co.uk',
            target: 'CHECKFRONT_WIDGET_01',
            provider: 'droplet',
            options: 'hidesearch,responsive',
            style: {
              width: '100%',
              max_width: '100%',
              font_family: 'Montserrat, Inter, sans-serif',
              color: '#222222'
            }
          };

          // Add item_id if provided
          if (itemIds) {
            widgetConfig.item_id = itemIds;
          }

          // Add date if provided
          if (checkfrontStartDate) {
            widgetConfig.date = checkfrontStartDate;
          }

          // Add end_date if provided
          if (checkfrontEndDate) {
            widgetConfig.end_date = checkfrontEndDate;
          }

          // Add tracking ID if provided
          if (trackingId) {
            widgetConfig.tid = trackingId;
          }

          // Initialize the widget
          new DROPLET.Widget(widgetConfig).render();
          
          console.log('‚úÖ Checkfront widget initialized with config:', widgetConfig);
          
          // Wait for widget to load, then make it responsive and centered
          setTimeout(() => {
            const container = document.getElementById('CHECKFRONT_WIDGET_01');
            if (container) {
              // Force container to center content
              container.style.textAlign = 'center';
              container.style.display = 'block';
              container.style.margin = '0 auto';
              
              // Find all iframes and make them responsive
              const iframes = container.querySelectorAll('iframe');
              iframes.forEach(iframe => {
                iframe.style.width = '100%';
                iframe.style.maxWidth = '100%';
                iframe.style.margin = '0 auto';
                iframe.style.display = 'block';
              });
              
              // Center all child divs and remove floats
              const allElements = container.querySelectorAll('*');
              allElements.forEach(el => {
                const computed = window.getComputedStyle(el);
                if (computed.float !== 'none') {
                  el.style.float = 'none';
                  el.style.display = 'inline-block';
                  el.style.verticalAlign = 'top';
                }
                if (el.className && el.className.includes('item')) {
                  el.style.marginLeft = 'auto';
                  el.style.marginRight = 'auto';
                }
              });
              
              // Add responsive class to container
              container.classList.add('checkfront-responsive');
              
              console.log('‚úÖ Applied responsive and centered styles to Checkfront widget');
            }
          }, 2000);
        } catch (error) {
          console.error('‚ùå Error initializing Checkfront widget:', error);
          
          // Show error message to user
          const loader = document.getElementById('CHECKFRONT_LOADER');
          if (loader) {
            loader.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: #dc2626; font-size: 16px; margin-bottom: 16px;">Unable to load booking system. Please try again or contact us for assistance.</p><a href="/contact" style="display: inline-block; background-color: #ad986c; color: white; padding: 12px 32px; border-radius: 9999px; text-decoration: none; font-weight: 600;">Contact Us</a></div>';
          }
        }
      }

      // Start initialization when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCheckfront);
      } else {
        initCheckfront();
      }
    </script>
  </>
)}

