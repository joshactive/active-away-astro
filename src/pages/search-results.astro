---
// Search Results - Checkfront Booking Page New
// URL parameters: item_ids, start_date, end_date, tid
// Example: /search-results?item_ids=15997&start_date=20260509&end_date=20260516

import BaseLayout from '../layouts/BaseLayout.astro';
import PageHeroTailwind from '../components/PageHeroTailwind.astro';
import BreadcrumbsTailwind from '../components/BreadcrumbsTailwind.astro';
import { getSearchResultsPage, getSearchResultsPageSEO } from '../utils/strapi.js';

// Parse URL query parameters
const url = Astro.url;
const itemIds = url.searchParams.get('item_ids') || '';
const startDate = url.searchParams.get('start_date') || '';
const endDate = url.searchParams.get('end_date') || '';
const trackingId = url.searchParams.get('tid') || '';

// Fetch page content from Strapi
let pageData = null;
try {
  pageData = await getSearchResultsPage();
  console.log('üîç [search-results] Page data fetched');
} catch (error) {
  console.error('‚ùå [search-results] Error fetching page:', error.message);
}

// Fetch SEO data separately
let seoData = null;
try {
  seoData = await getSearchResultsPageSEO();
  if (seoData) {
    console.log('üìÑ [search-results] SEO data fetched');
  }
} catch (error) {
  console.warn('‚ö†Ô∏è  [search-results] Could not fetch SEO data:', error.message);
}

// Handle date formatting (Ymd format: 20260509)
let checkfrontStartDate = startDate;
let checkfrontEndDate = endDate;

// If no dates provided, set defaults
if (!checkfrontStartDate) {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  checkfrontStartDate = `${year}${month}${day}`;
}

if (!checkfrontEndDate) {
  const today = new Date();
  const futureYear = today.getFullYear() + 2;
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  checkfrontEndDate = `${futureYear}${month}${day}`;
}

// Extract SEO fields with fallbacks
const pageTitle = seoData?.metaTitle 
  || pageData?.seo?.metaTitle 
  || 'Event Booking - Active Away';

const pageDescription = seoData?.metaDescription 
  || pageData?.seo?.metaDescription 
  || 'Complete your event booking with Active Away';

const metaImage = seoData?.metaImage || pageData?.seo?.metaImage || null;
const metaImageAlt = seoData?.metaImageAlt || pageData?.seo?.metaImageAlt || null;
const metaImageWidth = seoData?.metaImageWidth || null;
const metaImageHeight = seoData?.metaImageHeight || null;
const keywords = seoData?.keywords || pageData?.seo?.keywords || null;
const canonicalURL = seoData?.canonicalURL || pageData?.seo?.canonicalURL || 'https://activeaway.com/search-results';

// Show warning if no item_ids provided
const hasItems = itemIds !== '';
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
  robots="noindex, nofollow"
>
  <!-- Page Hero -->
  {pageData?.pageHero && (
    <div class="search-results-hero">
      <PageHeroTailwind pageData={pageData} />
    </div>
  )}
  
  <!-- Breadcrumbs -->
  {pageData?.pageHero?.showBreadcrumbs !== false && (
    <BreadcrumbsTailwind 
      breadcrumbs={[
        { label: 'Home', href: '/' },
        { label: 'Event Booking' }
      ]}
    />
  )}

  <!-- Main Content Section -->
  <section class="w-full bg-white py-8 sm:py-12">
    <div class="container mx-auto max-w-[1200px] px-2 sm:px-6 lg:px-8">
      
      {!hasItems ? (
        <!-- Error State: No Items -->
        <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8 text-center max-w-2xl mx-auto">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h2 class="text-2xl font-playfair font-semibold text-gray-900 mb-3">No Event Selected</h2>
          <p class="text-base font-inter text-gray-700 mb-6">
            Please select an event from our events page to view booking availability.
          </p>
          <a 
            href="/events" 
            class="inline-block bg-[#ad986c] hover:bg-[#8d7a56] text-white font-inter font-semibold px-8 py-3 rounded-full transition-colors duration-300"
          >
            View All Events
          </a>
        </div>
      ) : (
        <!-- Checkfront Booking Widget -->
        <div class="location-booking" style="text-align: center;">
          
          <!-- Checkfront Widget Container -->
          <div id="CHECKFRONT_WIDGET_01" style="margin: 0 auto; text-align: center;">
            <p 
              id="CHECKFRONT_LOADER" 
              style="background: url('//activeaway.checkfront.co.uk/images/loader.gif') left center no-repeat; padding: 5px 5px 5px 20px;"
            >
              Searching Availability...
            </p>
          </div>

          <!-- Fallback for users without JavaScript -->
          <noscript>
            <div style="text-align: center; padding: 40px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; margin-top: 20px;">
              <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">JavaScript Required</h3>
              <p style="font-size: 16px; margin-bottom: 24px;">
                Please enable JavaScript to use our booking system.
              </p>
              <a 
                href="https://activeaway.checkfront.co.uk/reserve/" 
                style="display: inline-block; background-color: #ad986c; color: white; padding: 12px 32px; border-radius: 50px; text-decoration: none; font-weight: 600;"
              >
                Continue to Secure Booking System &raquo;
              </a>
            </div>
          </noscript>

        </div>
      )}

    </div>
  </section>
</BaseLayout>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }

  /* Adjust hero height to match blog page */
  .search-results-hero :global(section) {
    height: 300px !important;
  }

  @media (min-width: 640px) {
    .search-results-hero :global(section) {
      height: 400px !important;
    }
  }

  @media (min-width: 1024px) {
    .search-results-hero :global(section) {
      height: 450px !important;
    }
  }

  /* Checkfront widget container */
  .location-booking {
    max-width: 610px;
    margin: 0 auto 30px auto;
    text-align: center;
    width: 100%;
  }

  /* Make Checkfront widget centered */
  :global(#CHECKFRONT_WIDGET_01) {
    font-family: 'Inter', sans-serif !important;
    color: #222222 !important;
    width: 100% !important;
    max-width: 610px !important;
    margin: 0 auto !important;
    text-align: center !important;
  }
  
  :global(#CHECKFRONT_WIDGET_01 *) {
    font-family: 'Inter', sans-serif !important;
  }
  
  /* Align currency selector with items */
  :global(#CHECKFRONT_WIDGET_01 .DROPLET_widget),
  :global(#CHECKFRONT_WIDGET_01 .DROPLET_container),
  :global(#CHECKFRONT_WIDGET_01 > div) {
    max-width: 610px !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }
  
  /* Currency selector alignment */
  :global(#CHECKFRONT_WIDGET_01 .currency-selector),
  :global(#CHECKFRONT_WIDGET_01 .DROPLET_currency),
  :global(#CHECKFRONT_WIDGET_01 select[name="currency"]),
  :global(#CHECKFRONT_WIDGET_01 .filter),
  :global(#CHECKFRONT_WIDGET_01 .toolbar) {
    max-width: 610px !important;
    margin-left: auto !important;
    margin-right: auto !important;
    box-sizing: border-box !important;
  }

  /* Keep widget iframe responsive */
  :global(#CHECKFRONT_WIDGET_01 iframe) {
    width: 100% !important;
    border: none !important;
    margin: 0 auto !important;
    display: block !important;
    min-height: 600px !important;
  }

  /* Handle mobile breakpoint */
  @media (max-width: 768px) {
    .location-booking {
      max-width: 100%;
      padding: 0 10px;
    }

    :global(#CHECKFRONT_WIDGET_01 iframe) {
      min-height: 500px !important;
    }
  }
</style>

{hasItems && (
  <>
    <!-- Load Checkfront library -->
    <script is:inline type="text/javascript" src="https://activeaway.checkfront.co.uk/lib/interface--20.js"></script>

    <!-- Initialize Checkfront widget with URL parameters -->
    <script is:inline define:vars={{ itemIds, checkfrontStartDate, checkfrontEndDate, trackingId }}>
      // Wait for DROPLET to be available
      function initCheckfront() {
        if (typeof DROPLET === 'undefined') {
          setTimeout(initCheckfront, 100);
          return;
        }

        try {
          const widgetConfig = {
            host: 'activeaway.checkfront.co.uk',
            target: 'CHECKFRONT_WIDGET_01',
            provider: 'droplet',
            options: 'hidesearch',
            style: 'color: #222222; font-family: Inter, sans-serif;'
          };

          // Add item_id if provided
          if (itemIds) {
            widgetConfig.item_id = itemIds;
          }

          // Add date if provided
          if (checkfrontStartDate) {
            widgetConfig.date = checkfrontStartDate;
          }

          // Add end_date if provided
          if (checkfrontEndDate) {
            widgetConfig.end_date = checkfrontEndDate;
          }

          // Add tracking ID if provided
          if (trackingId) {
            widgetConfig.tid = trackingId;
          }

          // Log style parameter before initialization
          console.log('üìã Style parameter being sent:', widgetConfig.style);
          console.log('üîß Full widget config:', JSON.stringify(widgetConfig, null, 2));
          
          // Initialize the widget
          new DROPLET.Widget(widgetConfig).render();
          
          console.log('‚úÖ Checkfront widget initialized');
          
          // ========================================
          // üé® ADVANCED STYLE INJECTION SYSTEM
          // ========================================
          
          // Function to check and try to access iframe content
          function tryAccessIframe() {
            const container = document.getElementById('CHECKFRONT_WIDGET_01');
            if (!container) {
              console.warn('‚ö†Ô∏è Container not found');
              return false;
            }
            
            const iframe = container.querySelector('iframe');
            if (!iframe) {
              console.warn('‚ö†Ô∏è iframe not loaded yet');
              return false;
            }
            
            console.log('üìç iframe found:', iframe.src);
            
            // Try to access iframe content
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              
              if (iframeDoc) {
                console.log('‚úÖ iframe content accessible!');
                
                // Inject custom styles into iframe
                const style = iframeDoc.createElement('style');
                style.textContent = `
                  * {
                    font-family: Inter, sans-serif !important;
                  }
                  body, main, div {
                    max-width: 610px !important;
                    margin-left: auto !important;
                    margin-right: auto !important;
                  }
                  .currency-selector, .filter, .toolbar {
                    max-width: 610px !important;
                    margin: 0 auto !important;
                  }
                `;
                iframeDoc.head.appendChild(style);
                console.log('üé® Custom styles injected into iframe!');
                return true;
              }
            } catch (error) {
              console.error('‚ùå CORS Error - Cannot access iframe content:', error.message);
              console.log('üí° Reason: iframe loads from different domain (activeaway.checkfront.co.uk)');
              console.log('üìå Solution: Must configure styles through Checkfront Dashboard');
              return false;
            }
            
            return false;
          }
          
          // Test iframe access after load
          setTimeout(() => {
            tryAccessIframe();
          }, 2000);
          
          setTimeout(() => {
            tryAccessIframe();
          }, 4000);
        } catch (error) {
          console.error('‚ùå Error initializing Checkfront widget:', error);
          
          // Show error message to user
          const loader = document.getElementById('CHECKFRONT_LOADER');
          if (loader) {
            loader.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: #dc2626; font-size: 16px; margin-bottom: 16px;">Unable to load booking system. Please try again or contact us for assistance.</p><a href="/contact" style="display: inline-block; background-color: #ad986c; color: white; padding: 12px 32px; border-radius: 9999px; text-decoration: none; font-weight: 600;">Contact Us</a></div>';
          }
        }
      }

      // Start initialization when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCheckfront);
      } else {
        initCheckfront();
      }
    </script>
  </>
)}
