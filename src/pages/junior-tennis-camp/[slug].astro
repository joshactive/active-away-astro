---
// Dynamic route for individual junior tennis camps
export const prerender = true;

import HolidayDetail from '../../components/HolidayDetail.astro';
import { getJuniorTennisCamps, getJuniorTennisCampBySlug, getJuniorTennisCampNestedData, getJuniorTennisCampSEO, getEventsByUniqueValue, getProductReviews } from '../../utils/strapi.js';

// Generate static paths for all junior tennis camps
export async function getStaticPaths() {
  const juniorCamps = await getJuniorTennisCamps(1, 100);
  
  return juniorCamps.map((camp) => ({
    params: { slug: camp.slug },
    props: { 
      slug: camp.slug,
      id: camp.strapiId,
      documentId: camp.documentId
    }
  }));
}

const { slug } = Astro.params;
const { id, documentId } = Astro.props;
const fallbackIdentifiers = { id, documentId };
console.log(`üë¶ [${slug}] Static props identifiers:`, fallbackIdentifiers);

// Fetch the specific junior tennis camp data
let holidayData = null;
try {
  holidayData = await getJuniorTennisCampBySlug(slug, fallbackIdentifiers);
  if (holidayData) {
    console.log(`üë¶ [${slug}] Junior camp data fetched successfully`);
  } else {
    console.warn(`üë¶ [${slug}] Junior camp data not found after lookup`);
  }
} catch (error) {
  console.error(`[${slug}] Error fetching junior camp:`, error.message);
}

// If no data found, show 404
if (!holidayData) {
  return Astro.redirect('/404');
}

// Helper to calculate product schema
const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": holidayData.title,
  "description": holidayData.introText || `Junior Tennis Camp at ${holidayData.title}`,
  "image": holidayData.headerImage?.url || `https://activeaway.com/images/junior-tennis-camp-placeholder.jpg`,
  "offers": {
    "@type": "Offer",
    "priceCurrency": "GBP",
    "price": holidayData.priceFrom || "0",
    "url": Astro.url.href,
    "availability": "https://schema.org/InStock"
  }
};

// Add AggregateRating if reviews exist
if (holidayData.productReviews && holidayData.productReviews.length > 0) {
  const reviewCount = holidayData.productReviews.length;
  const avgRating = holidayData.productReviews.reduce((acc, r) => acc + (r.reviewRating || 5), 0) / reviewCount;
  
  productSchema.aggregateRating = {
    "@type": "AggregateRating",
    "ratingValue": avgRating.toFixed(1),
    "reviewCount": reviewCount,
    "bestRating": "5",
    "worstRating": "1"
  };
}

// SEPARATE API CALL: Fetch nested data (tripImages)
try {
  const nestedData = await getJuniorTennisCampNestedData(slug);
  if (nestedData) {
    if (nestedData.tripImages && nestedData.tripImages.length > 0) {
      holidayData.tripImages = nestedData.tripImages;
    }
    console.log(`üë¶ [${slug}] Nested data merged: ${nestedData.tripImages?.length || 0} trip images`);
  }
} catch (error) {
  console.error(`[${slug}] Error fetching nested data:`, error.message);
}

// SEPARATE API CALL: Fetch SEO data with metaImage
try {
  const seoData = await getJuniorTennisCampSEO(slug);
  if (seoData) {
    holidayData.seo = seoData;
    console.log(`üìÑ [${slug}] SEO data merged: ${seoData.metaTitle || 'No title'}, metaImage: ${seoData.metaImage ? 'Yes' : 'No'}`);
  }
} catch (error) {
  console.error(`[${slug}] Error fetching SEO data:`, error.message);
}

// Fetch random other junior camp destinations (excluding current one)
let similarHolidays = [];
try {
  const allCamps = await getJuniorTennisCamps(1, 50);
  
  // Filter: exclude current camp AND only show those with displayOnFrontEnd = true
  const otherCamps = allCamps.filter(c => 
    c.slug !== slug && c.displayOnFrontEnd === true
  );
  
  // Randomize and select 3 destinations
  if (otherCamps.length > 0) {
    const shuffled = [...otherCamps];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    similarHolidays = shuffled.slice(0, 3);
    console.log(`üé≤ Selected ${similarHolidays.length} random junior camps from ${otherCamps.length} available`);
  }
} catch (error) {
  console.error('Error fetching other junior camps:', error);
}

// Fetch events matching this junior camp's uniqueValue
let matchingEvents = [];
try {
  if (holidayData.uniqueValue) {
    console.log(`üë¶ Fetching events for junior camp uniqueValue: "${holidayData.uniqueValue}"`);
    matchingEvents = await getEventsByUniqueValue(holidayData.uniqueValue);
    console.log(`üë¶ Found ${matchingEvents.length} matching event(s)`);
  } else {
    console.warn(`‚ö†Ô∏è Junior camp "${slug}" has no uniqueValue set`);
  }
} catch (error) {
  console.error('Error fetching events for junior camp:', error);
}

// Fetch product reviews if uniqueValue exists
let productReviews = [];
try {
  if (holidayData.uniqueValue) {
    productReviews = await getProductReviews(holidayData.uniqueValue);
    if (productReviews.length > 0) {
      holidayData.productReviews = productReviews;
      console.log(`‚≠ê [${slug}] Found ${productReviews.length} reviews matching uniqueValue "${holidayData.uniqueValue}"`);
    }
  }
} catch (error) {
  console.error('Error fetching reviews:', error);
}
---

<HolidayDetail 
  holidayData={holidayData}
  holidayType="junior-tennis-camp"
  matchingEvents={matchingEvents}
  similarHolidays={similarHolidays}
  slug={slug}
>
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(productSchema)} />
</HolidayDetail>

