---
// Dynamic route for individual forms
export const prerender = true;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { getForms, getFormBySlug } from '../../utils/strapi.js';

// Generate static paths for all forms
export async function getStaticPaths() {
  const forms = await getForms(1, 100);
  
  return forms.map((form) => ({
    params: { slug: form.slug },
    props: { 
      slug: form.slug,
      id: form.id,
      documentId: form.documentId
    }
  }));
}

const { slug } = Astro.params;
const { id, documentId } = Astro.props;
const fallbackIdentifiers = { id, documentId };
console.log(`ğŸ“ [${slug}] Static props identifiers:`, fallbackIdentifiers);

// Fetch the specific form data
let formData = null;
try {
  formData = await getFormBySlug(slug, fallbackIdentifiers);
  if (formData) {
    console.log(`ğŸ“ [${slug}] Form data fetched successfully`);
    console.log(`ğŸ“ [${slug}] Form layout: ${formData.formLayout}`);
    console.log(`ğŸ“ [${slug}] Show other options: ${formData.showOtherOptions}`);
  } else {
    console.warn(`ğŸ“ [${slug}] Form data not found after lookup`);
  }
} catch (error) {
  console.error(`[${slug}] Error fetching form:`, error.message);
}

// If no data found, show 404
if (!formData) {
  return Astro.redirect('/404');
}

// Helper to sanitize description HTML (allowing only <br>, <b>, <u>, and <a href> tags)
const sanitizeDescription = (input = '') => {
  if (!input) {
    return '';
  }

  // Store safe HTML temporarily with tokens
  const links = [];
  const placeholders = [
    { regex: /<br\s*\/?>/gi, token: '__BR__' },
    { regex: /<b>/gi, token: '__B_OPEN__' },
    { regex: /<\/b>/gi, token: '__B_CLOSE__' },
    { regex: /<u>/gi, token: '__U_OPEN__' },
    { regex: /<\/u>/gi, token: '__U_CLOSE__' }
  ];

  let output = input;

  // Extract and tokenize anchor tags
  output = output.replace(/<a\s+href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi, (match, href, text) => {
    // Only allow http, https, mailto, and tel protocols
    if (href.match(/^(https?:\/\/|mailto:|tel:|\/)/)) {
      const index = links.length;
      links.push({ href, text });
      return `__LINK_${index}__`;
    }
    return text; // Strip the link but keep the text if invalid protocol
  });

  // Replace allowed tags with tokens
  placeholders.forEach(({ regex, token }) => {
    output = output.replace(regex, token);
  });

  // Escape all remaining HTML
  output = output
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Restore allowed tags
  output = output
    .replace(/__BR__/g, '<br />')
    .replace(/__B_OPEN__/g, '<b>')
    .replace(/__B_CLOSE__/g, '</b>')
    .replace(/__U_OPEN__/g, '<u>')
    .replace(/__U_CLOSE__/g, '</u>');

  // Restore links
  links.forEach((link, index) => {
    output = output.replace(
      `__LINK_${index}__`,
      `<a href="${link.href}" class="text-[#ad986c] underline hover:text-[#8a7454] transition-colors">${link.text}</a>`
    );
  });

  return output;
};

// Extract data with fallbacks
const heroTitle = formData.hero?.title || formData.title || 'Form';
const heroSubtitle = formData.hero?.subtitle || formData.excerpt || '';
const heroKicker = formData.hero?.kicker || 'GET IN TOUCH';
const heroBackgroundImage = formData.hero?.backgroundImage?.url || 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/45b69090-1c22-46cd-7f98-086ba71efc00/public';
const heroBackgroundImageAlt = formData.hero?.backgroundImage?.alt || heroTitle;

const formFields = formData.formFields || [];
// Don't pass webhook URL to client - it will be fetched server-side by the API
const formSlug = slug;

// Extract SEO fields with fallbacks
const pageTitle = formData.seo?.metaTitle || `${formData.title} - Active Away`;
const pageDescription = formData.seo?.metaDescription || formData.excerpt || `Contact Active Away via ${formData.title}`;
const metaImage = formData.seo?.metaImage || null;
const metaImageAlt = formData.seo?.metaImageAlt || null;
const keywords = formData.seo?.keywords || null;
const canonicalURL = formData.seo?.canonicalURL || `https://activeaway.com/forms/${slug}`;

const formDescriptionHtml = sanitizeDescription(formData.description || '');
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section with Background Image -->
  <section class="relative w-full h-[400px] sm:h-[500px] lg:h-[600px] overflow-hidden">
    <!-- Background Image with Centered Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-b from-[#0D1C4E]/95 via-[#0D1C4E]/80 to-[#0D1C4E]/60 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt={heroBackgroundImageAlt}
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <!-- Centered Content -->
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <div class="hidden sm:block text-xs sm:text-sm font-inter font-semibold text-gold tracking-[0.2em] uppercase mb-4 sm:mb-6 border-t border-b border-gold/50 py-2 px-6">
        {heroKicker}
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {heroTitle}
      </h1>
      <p class="text-lg sm:text-xl lg:text-2xl font-inter text-gray-100 max-w-3xl leading-relaxed">
        {heroSubtitle}
      </p>
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="w-full bg-gray-50 py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <nav class="flex items-center gap-2 text-sm font-inter">
        <a href="/" class="text-gray-600 hover:text-[#ad986c] transition-colors">Home</a>
        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/forms" class="text-gray-600 hover:text-[#ad986c] transition-colors">Forms</a>
        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium">{formData.title}</span>
      </nav>
    </div>
  </section>

  <!-- Main Content Section -->
  <section class="w-full bg-white py-12 sm:py-16 lg:py-20">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      
      <!-- Introduction / Description -->
      {(formData.descriptionTitle || formData.description) && (
        <div class="w-full mb-12 sm:mb-16">
          {formData.descriptionTitle && (
            <h2 class="text-2xl sm:text-3xl lg:text-4xl font-playfair font-bold text-gray-900 mb-6">
              {formData.descriptionTitle}
            </h2>
          )}
          {formData.description && (
            <div class="prose prose-lg max-w-none font-inter text-gray-800 leading-relaxed" set:html={formDescriptionHtml}></div>
          )}
        </div>
      )}

      <!-- Form Section -->
      <div class="w-full">
        <div class="bg-white border-2 border-gray-200 rounded-2xl p-8 sm:p-10 shadow-lg">
          {formData.formHeading && (
            <h2 class="text-2xl sm:text-3xl font-playfair font-semibold text-gray-900 mb-4">
              {formData.formHeading}
            </h2>
          )}
          {formData.formSubtitle && (
            <p class="text-base font-inter text-gray-700 mb-8 leading-relaxed">
              {formData.formSubtitle}
            </p>
          )}
          
          <form id="dynamicForm" class={formData.formLayout === 'two-column' ? 'grid grid-cols-1 md:grid-cols-2 gap-6' : 'space-y-6'}>
            {formFields.map((field, index) => {
              // Helper function to check if field should span full width in two-column layout
              const shouldSpanFullWidth = () => {
                if (formData.formLayout !== 'two-column') return false;
                
                // Sections, textareas, and checkboxes always span full width
                if (field.type === 'section' || field.type === 'textarea' || field.type === 'checkbox') {
                  return true;
                }
                
                // Count how many consecutive regular fields remain AFTER this one
                // before hitting a full-width field or end
                let fieldsAfterThis = 0;
                for (let i = index + 1; i < formFields.length; i++) {
                  const f = formFields[i];
                  // Stop counting when we hit a full-width element
                  if (f.type === 'section' || f.type === 'textarea' || f.type === 'checkbox') {
                    break;
                  }
                  fieldsAfterThis++;
                }
                
                // If there are 0 fields after this one, check if we should be orphaned
                // by looking back to see if we're at an odd position in the group
                if (fieldsAfterThis === 0) {
                  // Count how many regular fields came before this one in the current group
                  let fieldsBeforeThis = 0;
                  for (let i = index - 1; i >= 0; i--) {
                    const f = formFields[i];
                    // Stop counting when we hit a full-width element
                    if (f.type === 'section' || f.type === 'textarea' || f.type === 'checkbox') {
                      break;
                    }
                    fieldsBeforeThis++;
                  }
                  
                  // If odd number of fields before this (1, 3, 5...), we're the 2nd, 4th, 6th... field
                  // which means we're paired. If even (0, 2, 4...), we're orphaned (1st, 3rd, 5th...)
                  if (fieldsBeforeThis % 2 === 0) {
                    return true; // Orphaned - span full width
                  }
                }
                
                return false;
              };
              
              return (
              <>
                {/* Hidden Field - renders outside grid, takes no space */}
                {field.type === 'hidden' ? (
                  <input
                    type="hidden"
                    id={field.name}
                    name={field.name}
                    value={field.value || ''}
                    data-query-param={field.queryParam || ''}
                  />
                ) : field.type === 'section' ? (
                  /* Section Heading - spans full width and adds visual separation */
                  <div 
                    class={formData.formLayout === 'two-column' ? 'md:col-span-2 pt-6 pb-2' : 'pt-6 pb-2'}
                    data-conditional={field.conditional ? 'true' : 'false'}
                    data-condition-field={field.conditionalField || ''}
                    data-condition-operator={field.conditionalOperator || ''}
                    data-condition-value={field.conditionalValue || ''}
                    style={field.conditional ? 'display: none;' : ''}
                  >
                    <h3 class="text-xl sm:text-2xl font-playfair font-semibold text-gray-900 mb-2">
                      {field.label}
                    </h3>
                    {field.description && (
                      <p class="text-base font-inter text-gray-600 leading-relaxed">
                        {field.description}
                      </p>
                    )}
                    <div class="mt-4 border-t border-gray-200"></div>
                  </div>
                ) : (
                  /* Regular Form Field */
                  <div 
                    class={shouldSpanFullWidth() ? 'md:col-span-2' : ''}
                    data-conditional={field.conditional ? 'true' : 'false'}
                    data-condition-field={field.conditionalField || ''}
                    data-condition-operator={field.conditionalOperator || ''}
                    data-condition-value={field.conditionalValue || ''}
                    style={field.conditional ? 'display: none;' : ''}
                  >
                    {/* Name Field */}
                    {field.type === 'namefield' ? (
                      /* Name Field - Display only with gold underline */
                      <div class="name-field-display">
                        {field.label && (
                          <label class="block text-sm font-inter font-semibold text-gray-900 mb-2">
                            {field.label}
                          </label>
                        )}
                        <div class="mb-2">
                          <div class="text-2xl font-playfair font-semibold text-gray-900 inline-block border-b-2 border-[#ad986c] pb-1">
                            {field.value || field.placeholder || ''}
                          </div>
                        </div>
                        <input
                          type="hidden"
                          id={field.name}
                          name={field.name}
                          value={field.value || ''}
                          data-query-param={field.queryParam || ''}
                        />
                      </div>
                    ) : field.type === 'repeater' ? (
                      /* Repeater Field */
                      <div class="repeater-container" data-repeater-name={field.name}>
                        <div class="mb-4">
                          <label class="block text-sm font-inter font-semibold text-gray-900 mb-2">
                            {field.label}
                            {field.required && <span class="text-red-500 ml-1">*</span>}
                          </label>
                          {field.description && (
                            <p class="text-sm font-inter text-gray-600 mb-3 leading-relaxed">
                              {field.description}
                            </p>
                          )}
                        </div>
                        
                        <div class="repeater-items space-y-4" data-min-items={field.minItems || 0} data-max-items={field.maxItems || 999}>
                          {/* Initial repeater item */}
                          <div class="repeater-item border-2 border-gray-200 rounded-lg p-6 relative">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                              {field.fields && field.fields.map((subfield) => (
                                <div class={subfield.type === 'textarea' ? 'md:col-span-2' : ''}>
                                  <label class="block text-sm font-inter font-semibold text-gray-900 mb-2">
                                    {subfield.label}
                                    {subfield.required && <span class="text-red-500 ml-1">*</span>}
                                  </label>
                                  {subfield.description && (
                                    <p class="text-sm font-inter text-gray-600 mb-2">
                                      {subfield.description}
                                    </p>
                                  )}
                                  {subfield.type === 'textarea' ? (
                                    <textarea
                                      name={`${field.name}[0][${subfield.name}]`}
                                      required={subfield.required}
                                      placeholder={subfield.placeholder || ''}
                                      rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all resize-vertical"
                                    ></textarea>
                                  ) : subfield.type === 'select' ? (
                                    <select
                                      name={`${field.name}[0][${subfield.name}]`}
                                      required={subfield.required}
                                      data-dynamic-options={subfield.dynamicOptions || ''}
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                                    >
                                      <option value="">{subfield.placeholder || 'Select an option...'}</option>
                                      {subfield.options && subfield.options.map((option) => (
                                        <option value={option}>{option}</option>
                                      ))}
                                    </select>
                                  ) : (
                                    <input
                                      type={subfield.type || 'text'}
                                      name={`${field.name}[0][${subfield.name}]`}
                                      required={subfield.required}
                                      placeholder={subfield.placeholder || ''}
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                                    />
                                  )}
                                </div>
                              ))}
                            </div>
                            <button
                              type="button"
                              class="remove-item absolute top-4 right-4 text-red-600 hover:text-red-800 font-inter font-semibold text-sm hidden"
                            >
                              âœ• Remove
                            </button>
                          </div>
                        </div>
                        
                        <button
                          type="button"
                          class="add-item mt-4 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-900 rounded-lg font-inter font-semibold transition-colors"
                        >
                          {field.addButtonText || '+ Add Item'}
                        </button>
                      </div>
                    ) : field.type === 'checkbox' ? (
                      <div class="space-y-3">
                        {field.options && field.options.map((option) => (
                          <div class="flex items-start gap-3">
                            <input
                              type="checkbox"
                              id={field.options.length === 1 ? field.name : `${field.name}_${option.replace(/\s+/g, '_')}`}
                              name={field.name}
                              value={option}
                              required={field.required && field.options.length === 1}
                              class="mt-1 w-5 h-5 text-[#ad986c] border-gray-300 rounded focus:ring-2 focus:ring-gold transition-all cursor-pointer"
                            />
                            <label 
                              for={field.options.length === 1 ? field.name : `${field.name}_${option.replace(/\s+/g, '_')}`}
                              class="flex-1 text-sm font-inter text-gray-900 leading-relaxed cursor-pointer select-none"
                            >
                              {option}
                              {field.required && field.options.length === 1 && <span class="text-red-500 ml-1">*</span>}
                            </label>
                          </div>
                        ))}
                        {field.description && (
                          <p class="text-sm font-inter text-gray-600 mt-2 ml-8">
                            {field.description}
                          </p>
                        )}
                      </div>
                    ) : (
                      /* All Other Field Types */
                      <>
                        <label 
                          for={field.name}
                          class="block text-sm font-inter font-semibold text-gray-900 mb-2"
                        >
                          {field.label}
                          {field.required && <span class="text-red-500 ml-1">*</span>}
                        </label>
                        
                        {field.description && (
                          <p class="text-sm font-inter text-gray-600 mb-3 leading-relaxed">
                            {field.description}
                          </p>
                        )}
                        
                        {field.type === 'textarea' ? (
                          <textarea
                            id={field.name}
                            name={field.name}
                            required={field.required}
                            placeholder={field.placeholder || ''}
                            minlength={field.minLength}
                            maxlength={field.maxLength}
                            rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all resize-vertical"
                          ></textarea>
                        ) : field.type === 'select' ? (
                          <select
                            id={field.name}
                            name={field.name}
                            required={field.required}
                            data-dynamic-options={field.dynamicOptions || ''}
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                          >
                            <option value="">{field.placeholder || 'Select an option...'}</option>
                            {field.options && field.options.map((option) => (
                              <option value={option}>{option}</option>
                            ))}
                          </select>
                        ) : field.type === 'tel' ? (
                          <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative w-full sm:w-52">
                              <input
                                type="text"
                                id={`${field.name}_country`}
                                name={`${field.name}_country`}
                                list={`${field.name}_countries`}
                                value="+44"
                                placeholder="ğŸ‡¬ğŸ‡§ +44"
                                class="w-full sm:min-w-[12rem] px-3 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                              />
                              <datalist id={`${field.name}_countries`}>
                                <option value="+93">ğŸ‡¦ğŸ‡« Afghanistan +93</option>
                                <option value="+355">ğŸ‡¦ğŸ‡± Albania +355</option>
                                <option value="+213">ğŸ‡©ğŸ‡¿ Algeria +213</option>
                                <option value="+376">ğŸ‡¦ğŸ‡© Andorra +376</option>
                                <option value="+244">ğŸ‡¦ğŸ‡´ Angola +244</option>
                                <option value="+54">ğŸ‡¦ğŸ‡· Argentina +54</option>
                                <option value="+374">ğŸ‡¦ğŸ‡² Armenia +374</option>
                                <option value="+61">ğŸ‡¦ğŸ‡º Australia +61</option>
                                <option value="+43">ğŸ‡¦ğŸ‡¹ Austria +43</option>
                                <option value="+994">ğŸ‡¦ğŸ‡¿ Azerbaijan +994</option>
                                <option value="+973">ğŸ‡§ğŸ‡­ Bahrain +973</option>
                                <option value="+880">ğŸ‡§ğŸ‡© Bangladesh +880</option>
                                <option value="+375">ğŸ‡§ğŸ‡¾ Belarus +375</option>
                                <option value="+32">ğŸ‡§ğŸ‡ª Belgium +32</option>
                                <option value="+501">ğŸ‡§ğŸ‡¿ Belize +501</option>
                                <option value="+229">ğŸ‡§ğŸ‡¯ Benin +229</option>
                                <option value="+975">ğŸ‡§ğŸ‡¹ Bhutan +975</option>
                                <option value="+591">ğŸ‡§ğŸ‡´ Bolivia +591</option>
                                <option value="+387">ğŸ‡§ğŸ‡¦ Bosnia +387</option>
                                <option value="+55">ğŸ‡§ğŸ‡· Brazil +55</option>
                                <option value="+673">ğŸ‡§ğŸ‡³ Brunei +673</option>
                                <option value="+359">ğŸ‡§ğŸ‡¬ Bulgaria +359</option>
                                <option value="+855">ğŸ‡°ğŸ‡­ Cambodia +855</option>
                                <option value="+237">ğŸ‡¨ğŸ‡² Cameroon +237</option>
                                <option value="+1">ğŸ‡¨ğŸ‡¦ Canada +1</option>
                                <option value="+56">ğŸ‡¨ğŸ‡± Chile +56</option>
                                <option value="+86">ğŸ‡¨ğŸ‡³ China +86</option>
                                <option value="+57">ğŸ‡¨ğŸ‡´ Colombia +57</option>
                                <option value="+506">ğŸ‡¨ğŸ‡· Costa Rica +506</option>
                                <option value="+385">ğŸ‡­ğŸ‡· Croatia +385</option>
                                <option value="+53">ğŸ‡¨ğŸ‡º Cuba +53</option>
                                <option value="+357">ğŸ‡¨ğŸ‡¾ Cyprus +357</option>
                                <option value="+420">ğŸ‡¨ğŸ‡¿ Czech Republic +420</option>
                                <option value="+45">ğŸ‡©ğŸ‡° Denmark +45</option>
                                <option value="+593">ğŸ‡ªğŸ‡¨ Ecuador +593</option>
                                <option value="+20">ğŸ‡ªğŸ‡¬ Egypt +20</option>
                                <option value="+372">ğŸ‡ªğŸ‡ª Estonia +372</option>
                                <option value="+251">ğŸ‡ªğŸ‡¹ Ethiopia +251</option>
                                <option value="+358">ğŸ‡«ğŸ‡® Finland +358</option>
                                <option value="+33">ğŸ‡«ğŸ‡· France +33</option>
                                <option value="+995">ğŸ‡¬ğŸ‡ª Georgia +995</option>
                                <option value="+49">ğŸ‡©ğŸ‡ª Germany +49</option>
                                <option value="+233">ğŸ‡¬ğŸ‡­ Ghana +233</option>
                                <option value="+30">ğŸ‡¬ğŸ‡· Greece +30</option>
                                <option value="+852">ğŸ‡­ğŸ‡° Hong Kong +852</option>
                                <option value="+36">ğŸ‡­ğŸ‡º Hungary +36</option>
                                <option value="+354">ğŸ‡®ğŸ‡¸ Iceland +354</option>
                                <option value="+91">ğŸ‡®ğŸ‡³ India +91</option>
                                <option value="+62">ğŸ‡®ğŸ‡© Indonesia +62</option>
                                <option value="+98">ğŸ‡®ğŸ‡· Iran +98</option>
                                <option value="+964">ğŸ‡®ğŸ‡¶ Iraq +964</option>
                                <option value="+353">ğŸ‡®ğŸ‡ª Ireland +353</option>
                                <option value="+972">ğŸ‡®ğŸ‡± Israel +972</option>
                                <option value="+39">ğŸ‡®ğŸ‡¹ Italy +39</option>
                                <option value="+81">ğŸ‡¯ğŸ‡µ Japan +81</option>
                                <option value="+962">ğŸ‡¯ğŸ‡´ Jordan +962</option>
                                <option value="+7">ğŸ‡°ğŸ‡¿ Kazakhstan +7</option>
                                <option value="+254">ğŸ‡°ğŸ‡ª Kenya +254</option>
                                <option value="+965">ğŸ‡°ğŸ‡¼ Kuwait +965</option>
                                <option value="+371">ğŸ‡±ğŸ‡» Latvia +371</option>
                                <option value="+961">ğŸ‡±ğŸ‡§ Lebanon +961</option>
                                <option value="+423">ğŸ‡±ğŸ‡® Liechtenstein +423</option>
                                <option value="+370">ğŸ‡±ğŸ‡¹ Lithuania +370</option>
                                <option value="+352">ğŸ‡±ğŸ‡º Luxembourg +352</option>
                                <option value="+853">ğŸ‡²ğŸ‡´ Macau +853</option>
                                <option value="+60">ğŸ‡²ğŸ‡¾ Malaysia +60</option>
                                <option value="+960">ğŸ‡²ğŸ‡» Maldives +960</option>
                                <option value="+356">ğŸ‡²ğŸ‡¹ Malta +356</option>
                                <option value="+52">ğŸ‡²ğŸ‡½ Mexico +52</option>
                                <option value="+377">ğŸ‡²ğŸ‡¨ Monaco +377</option>
                                <option value="+212">ğŸ‡²ğŸ‡¦ Morocco +212</option>
                                <option value="+95">ğŸ‡²ğŸ‡² Myanmar +95</option>
                                <option value="+264">ğŸ‡³ğŸ‡¦ Namibia +264</option>
                                <option value="+977">ğŸ‡³ğŸ‡µ Nepal +977</option>
                                <option value="+31">ğŸ‡³ğŸ‡± Netherlands +31</option>
                                <option value="+64">ğŸ‡³ğŸ‡¿ New Zealand +64</option>
                                <option value="+47">ğŸ‡³ğŸ‡´ Norway +47</option>
                                <option value="+968">ğŸ‡´ğŸ‡² Oman +968</option>
                                <option value="+92">ğŸ‡µğŸ‡° Pakistan +92</option>
                                <option value="+507">ğŸ‡µğŸ‡¦ Panama +507</option>
                                <option value="+51">ğŸ‡µğŸ‡ª Peru +51</option>
                                <option value="+63">ğŸ‡µğŸ‡­ Philippines +63</option>
                                <option value="+48">ğŸ‡µğŸ‡± Poland +48</option>
                                <option value="+351">ğŸ‡µğŸ‡¹ Portugal +351</option>
                                <option value="+974">ğŸ‡¶ğŸ‡¦ Qatar +974</option>
                                <option value="+40">ğŸ‡·ğŸ‡´ Romania +40</option>
                                <option value="+7">ğŸ‡·ğŸ‡º Russia +7</option>
                                <option value="+966">ğŸ‡¸ğŸ‡¦ Saudi Arabia +966</option>
                                <option value="+381">ğŸ‡·ğŸ‡¸ Serbia +381</option>
                                <option value="+65">ğŸ‡¸ğŸ‡¬ Singapore +65</option>
                                <option value="+421">ğŸ‡¸ğŸ‡° Slovakia +421</option>
                                <option value="+386">ğŸ‡¸ğŸ‡® Slovenia +386</option>
                                <option value="+27">ğŸ‡¿ğŸ‡¦ South Africa +27</option>
                                <option value="+82">ğŸ‡°ğŸ‡· South Korea +82</option>
                                <option value="+34">ğŸ‡ªğŸ‡¸ Spain +34</option>
                                <option value="+94">ğŸ‡±ğŸ‡° Sri Lanka +94</option>
                                <option value="+46">ğŸ‡¸ğŸ‡ª Sweden +46</option>
                                <option value="+41">ğŸ‡¨ğŸ‡­ Switzerland +41</option>
                                <option value="+886">ğŸ‡¹ğŸ‡¼ Taiwan +886</option>
                                <option value="+66">ğŸ‡¹ğŸ‡­ Thailand +66</option>
                                <option value="+90">ğŸ‡¹ğŸ‡· Turkey +90</option>
                                <option value="+971">ğŸ‡¦ğŸ‡ª UAE +971</option>
                                <option value="+44">ğŸ‡¬ğŸ‡§ UK +44</option>
                                <option value="+1">ğŸ‡ºğŸ‡¸ USA +1</option>
                                <option value="+598">ğŸ‡ºğŸ‡¾ Uruguay +598</option>
                                <option value="+58">ğŸ‡»ğŸ‡ª Venezuela +58</option>
                                <option value="+84">ğŸ‡»ğŸ‡³ Vietnam +84</option>
                              </datalist>
                            </div>
                            <input
                              type="tel"
                              id={field.name}
                              name={field.name}
                              required={field.required}
                              placeholder={field.placeholder || ''}
                              pattern={field.pattern}
                              class="w-full sm:flex-1 px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                            />
                          </div>
                        ) : (
                          <input
                            type={field.type || 'text'}
                            id={field.name}
                            name={field.name}
                            required={field.required}
                            placeholder={field.placeholder || ''}
                            pattern={field.pattern}
                            minlength={field.minLength}
                            maxlength={field.maxLength}
                            min={field.min}
                            max={field.max}
                            data-query-param={field.queryParam || ''}
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg font-inter text-gray-900 focus:ring-2 focus:ring-gold focus:border-gold transition-all"
                          />
                        )}
                      </>
                    )}
                  </div>
                )}
              </>
              );
            })}
            
            <!-- Cloudflare Turnstile -->
            <div class={formData.formLayout === 'two-column' ? 'md:col-span-2' : ''}>
              {import.meta.env.PUBLIC_TURNSTILE_SITE_KEY && (
                <div class="cf-turnstile" data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY} data-theme="light"></div>
              )}
            </div>
            
            <!-- Submit Button -->
            <div 
              class={formData.formLayout === 'two-column' ? 'md:col-span-2' : ''}
              data-conditional={formData.submitButtonConditional ? 'true' : 'false'}
              data-condition-field={formData.submitButtonConditionalField || ''}
              data-condition-operator={formData.submitButtonConditionalOperator || ''}
              data-condition-value={formData.submitButtonConditionalValue || ''}
              style={formData.submitButtonConditional ? 'display: none;' : ''}
            >
              <button
                type="submit"
                class="w-full bg-[#ad986c] text-white px-8 py-4 rounded-lg font-inter font-semibold hover:bg-[#8a7454] transition-colors focus:ring-4 focus:ring-gold/30 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span id="submitButtonText">Submit Form</span>
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
              </button>
            </div>
          </form>
          
          <!-- Success Message (Hidden by Default) -->
          <div id="successMessage" class="hidden mt-8 p-6 bg-green-50 border-2 border-green-500 rounded-xl">
            <div class="flex items-start gap-3">
              <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <h3 class="text-lg font-inter font-semibold text-green-900 mb-1">Thank you!</h3>
                <p class="text-base font-inter text-green-800">Your form has been submitted successfully. We'll be in touch soon.</p>
              </div>
            </div>
          </div>
          
          <!-- Error Message (Hidden by Default) -->
          <div id="errorMessage" class="hidden mt-8 p-6 bg-red-50 border-2 border-red-500 rounded-xl">
            <div class="flex items-start gap-3">
              <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <h3 class="text-lg font-inter font-semibold text-red-900 mb-1">Error</h3>
                <p class="text-base font-inter text-red-800" id="errorText">Something went wrong. Please try again.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </section>
  
  <!-- Other Options Section (Call Us / Email Us) -->
  {formData.showOtherOptions && (
    <section class="w-full bg-gray-50 py-12 sm:py-16 lg:py-20 border-t border-gray-200">
      <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-playfair font-semibold text-gray-900 mb-8 sm:mb-12 text-center">
          Other Options
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
          <!-- Phone -->
          <a 
            href="tel:+442079657277"
            class="group bg-white border-2 border-gray-200 rounded-2xl p-8 shadow-sm hover:shadow-xl hover:border-[#ad986c] transition-all duration-300 hover:-translate-y-1 text-center"
          >
            <svg class="w-8 h-8 mx-auto mb-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <h3 class="text-lg font-playfair font-semibold text-gray-900 mb-2 group-hover:text-[#ad986c] transition-colors">
              Phone
            </h3>
            <p class="text-base font-inter text-gray-700 group-hover:text-[#ad986c] transition-colors">
              +44 020 7965 7277
            </p>
          </a>
          
          <!-- Email -->
          <a 
            href={`mailto:hello@activeaway.com?subject=${encodeURIComponent(formData.title)}`}
            class="group bg-white border-2 border-gray-200 rounded-2xl p-8 shadow-sm hover:shadow-xl hover:border-[#ad986c] transition-all duration-300 hover:-translate-y-1 text-center"
          >
            <svg class="w-8 h-8 mx-auto mb-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <h3 class="text-lg font-playfair font-semibold text-gray-900 mb-2 group-hover:text-[#ad986c] transition-colors">
              Email
            </h3>
            <p class="text-base font-inter text-gray-700 group-hover:text-[#ad986c] transition-colors">
              hello@activeaway.com
            </p>
          </a>
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script define:vars={{ formSlug }}>
  // Form submission handling
  const form = document.getElementById('dynamicForm');
  const successMessage = document.getElementById('successMessage');
  const errorMessage = document.getElementById('errorMessage');
  const errorText = document.getElementById('errorText');
  const submitButtonText = document.getElementById('submitButtonText');
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Hide previous messages
      successMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');
      
      // Get submit button
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButtonText.textContent;
      
      try {
        // Get Turnstile token
        let turnstileToken = null;
        try {
          if (typeof window.turnstile !== 'undefined' && window.turnstile) {
            turnstileToken = window.turnstile.getResponse();
          }
        } catch (err) {
          console.warn('Turnstile not available:', err);
        }
        
        // Disable submit button and show loading
        submitButton.disabled = true;
        submitButtonText.textContent = 'Submitting...';
        
        // Collect form data
        const formDataObj = new FormData(form);
        const data = {};
        
        // Handle all form fields, including checkboxes and repeaters
        for (const [key, value] of formDataObj.entries()) {
          // Check if this is a repeater field (format: fieldname[index][subfieldname])
          const repeaterMatch = key.match(/^(.+?)\[(\d+)\]\[(.+?)\]$/);
          
          if (repeaterMatch) {
            // This is a repeater field
            const [, repeaterName, index, subfieldName] = repeaterMatch;
            const idx = parseInt(index);
            
            if (!data[repeaterName]) {
              data[repeaterName] = [];
            }
            
            if (!data[repeaterName][idx]) {
              data[repeaterName][idx] = {};
            }
            
            data[repeaterName][idx][subfieldName] = value;
          } else {
            // Regular field or checkbox
            if (data[key]) {
              // If key already exists, convert to array or append to existing array
              if (Array.isArray(data[key])) {
                data[key].push(value);
              } else {
                data[key] = [data[key], value];
              }
            } else {
              // Check if this field has multiple values (checkboxes)
              const allValues = formDataObj.getAll(key);
              if (allValues.length > 1) {
                data[key] = allValues;
              } else {
                data[key] = value;
              }
            }
          }
        }
        
        // Combine country code with phone number for tel fields
        Object.keys(data).forEach(key => {
          if (key.endsWith('_country')) {
            const phoneFieldName = key.replace('_country', '');
            if (data[phoneFieldName]) {
              // Remove + symbol and spaces, then combine without space
              const cleanCountryCode = String(data[key]).replace(/[\+\s]/g, '');
              data[phoneFieldName] = `${cleanCountryCode}${data[phoneFieldName]}`;
              delete data[key]; // Remove the country code field from submission
            }
          }
        });
        
        // Submit to API endpoint (webhook URL will be fetched server-side)
        const response = await fetch('/api/submit-form.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            formSlug: formSlug,
            data: data,
            turnstileToken: turnstileToken
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Show success message
          successMessage?.classList.remove('hidden');
          form.reset();
          
          // Reset Turnstile
          try {
            if (typeof window.turnstile !== 'undefined' && window.turnstile) {
              window.turnstile.reset();
            }
          } catch (err) {
            console.warn('Could not reset Turnstile:', err);
          }
          
          // Scroll to success message
          successMessage?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          throw new Error(result.error || 'Form submission failed');
        }
        
      } catch (error) {
        console.error('Form submission error:', error);
        
        // Show error message
        if (errorText) {
          errorText.textContent = error.message || 'Something went wrong. Please try again.';
        }
        errorMessage?.classList.remove('hidden');
        
        // Reset Turnstile on error
        try {
          if (typeof window.turnstile !== 'undefined' && window.turnstile) {
            window.turnstile.reset();
          }
        } catch (err) {
          console.warn('Could not reset Turnstile:', err);
        }
        
        // Scroll to error message
        errorMessage?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
      } finally {
        // Re-enable submit button
        submitButton.disabled = false;
        submitButtonText.textContent = originalButtonText;
      }
    });
  }
</script>

<script>
  // Combined script: Query params + Conditional logic
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('dynamicForm');
    if (!form) return;
    
    // STEP 1: Populate form fields from URL query parameters FIRST
    const urlParams = new URLSearchParams(window.location.search);
    
    // Find all fields with data-query-param attribute
    const fieldsWithQueryParams = document.querySelectorAll('[data-query-param]');
    
    fieldsWithQueryParams.forEach((field) => {
      const queryParam = field.getAttribute('data-query-param');
      if (queryParam && urlParams.has(queryParam)) {
        const value = urlParams.get(queryParam);
        if (value) {
          field.value = value;
          
          // Also update the display text for namefield type
          const parentDiv = field.closest('.name-field-display');
          if (parentDiv) {
            const textDiv = parentDiv.querySelector('.text-2xl');
            if (textDiv) {
              textDiv.textContent = value;
            }
          }
        }
      }
    });
    
    console.log('âœ… Form fields populated from query parameters');
    
    // STEP 1.5: Load dynamic options for select fields
    const dynamicSelects = document.querySelectorAll('select[data-dynamic-options]');
    
    if (dynamicSelects.length > 0) {
      dynamicSelects.forEach(async (select) => {
        const dynamicType = select.getAttribute('data-dynamic-options');
        
        if (dynamicType === 'resorts') {
          try {
            const response = await fetch('/api/get-resorts.json');
            const result = await response.json();
            
            if (result.success && result.resorts) {
              // Keep the placeholder option
              const placeholder = select.querySelector('option[value=""]');
              select.innerHTML = '';
              
              if (placeholder) {
                select.appendChild(placeholder);
              }
              
              // Add resort options
              result.resorts.forEach(resort => {
                const option = document.createElement('option');
                option.value = resort;
                option.textContent = resort;
                select.appendChild(option);
              });
              
              console.log(`âœ… Loaded ${result.resorts.length} resorts dynamically`);
            }
          } catch (error) {
            console.error('Failed to load dynamic resorts:', error);
          }
        } else if (dynamicType === 'venues') {
          try {
            const response = await fetch('/api/get-venues.json');
            const result = await response.json();
            
            if (result.success && result.venues) {
              // Keep the placeholder option
              const placeholder = select.querySelector('option[value=""]');
              select.innerHTML = '';
              
              if (placeholder) {
                select.appendChild(placeholder);
              }
              
              // Add venue options
              result.venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue;
                option.textContent = venue;
                select.appendChild(option);
              });
              
              console.log(`âœ… Loaded ${result.venues.length} venues dynamically`);
            }
          } catch (error) {
            console.error('Failed to load dynamic venues:', error);
          }
        } else if (dynamicType === 'clinics') {
          try {
            const response = await fetch('/api/get-clinics.json');
            const result = await response.json();
            
            if (result.success && result.clinics) {
              // Keep the placeholder option
              const placeholder = select.querySelector('option[value=""]');
              select.innerHTML = '';
              
              if (placeholder) {
                select.appendChild(placeholder);
              }
              
              // Add clinic options
              result.clinics.forEach(clinic => {
                const option = document.createElement('option');
                option.value = clinic;
                option.textContent = clinic;
                select.appendChild(option);
              });
              
              console.log(`âœ… Loaded ${result.clinics.length} clinics dynamically`);
            }
          } catch (error) {
            console.error('Failed to load dynamic clinics:', error);
          }
        }
      });
    }
    
    // STEP 2: Now handle conditional field display
    
    // Function to check if condition is met
    function checkCondition(field, operator, value) {
      if (!field) return false;
      
      const fieldValue = field.value || '';
      
      switch(operator) {
        case 'contains':
        case 'contain':
          return fieldValue.includes(value);
        case 'not_contain':
          return !fieldValue.includes(value);
        case 'equals':
        case 'equal':
          return fieldValue === value;
        case 'not_equals':
          return fieldValue !== value;
        case 'not_empty':
          return fieldValue.trim() !== '';
        case 'empty':
          return fieldValue.trim() === '';
        case 'greater':
          return fieldValue.length > parseInt(value);
        case 'less':
          return fieldValue.length < parseInt(value);
        default:
          return false;
      }
    }
    
    // Function to update conditional elements
    function updateConditionals() {
      const conditionalElements = document.querySelectorAll('[data-conditional="true"]');
      
      conditionalElements.forEach((element) => {
        const conditionFieldName = element.getAttribute('data-condition-field');
        const conditionOperator = element.getAttribute('data-condition-operator');
        const conditionValue = element.getAttribute('data-condition-value');
        
        if (!conditionFieldName) return;
        
        const conditionField = form.querySelector(`[name="${conditionFieldName}"]`);
        const conditionMet = checkCondition(conditionField, conditionOperator, conditionValue);
        
        // Show/hide element based on condition
        element.style.display = conditionMet ? '' : 'none';
        
        // Disable fields inside hidden elements
        if (!conditionMet) {
          element.querySelectorAll('input, select, textarea').forEach(field => {
            field.setAttribute('data-was-required', field.required);
            field.required = false;
          });
        } else {
          element.querySelectorAll('input[data-was-required="true"], select[data-was-required="true"], textarea[data-was-required="true"]').forEach(field => {
            field.required = true;
          });
        }
      });
    }
    
    // Listen for changes on all form fields
    form.addEventListener('input', updateConditionals);
    form.addEventListener('change', updateConditionals);
    
    // STEP 3: Run initial conditional check AFTER query params are populated
    updateConditionals();
    
    console.log('âœ… Conditional field logic initialized');
  });
</script>

<script>
  // Handle repeater field add/remove functionality
  document.addEventListener('DOMContentLoaded', () => {
    const repeaterContainers = document.querySelectorAll('.repeater-container');
    
    repeaterContainers.forEach((container) => {
      const repeaterName = container.getAttribute('data-repeater-name');
      const itemsContainer = container.querySelector('.repeater-items');
      const addButton = container.querySelector('.add-item');
      const minItems = parseInt(itemsContainer.getAttribute('data-min-items') || '0');
      const maxItems = parseInt(itemsContainer.getAttribute('data-max-items') || '999');
      
      // Function to update item indices and remove buttons
      function updateItems() {
        const items = itemsContainer.querySelectorAll('.repeater-item');
        
        items.forEach((item, index) => {
          // Update all field names with correct index
          item.querySelectorAll('input, select, textarea').forEach((field) => {
            const name = field.getAttribute('name');
            if (name) {
              // Replace [X] with correct [index]
              const newName = name.replace(/\[\d+\]/, `[${index}]`);
              field.setAttribute('name', newName);
            }
          });
          
          // Show/hide remove button
          const removeButton = item.querySelector('.remove-item');
          if (items.length > minItems) {
            removeButton.classList.remove('hidden');
          } else {
            removeButton.classList.add('hidden');
          }
        });
        
        // Show/hide add button based on max items
        if (items.length >= maxItems) {
          addButton.classList.add('hidden');
        } else {
          addButton.classList.remove('hidden');
        }
      }
      
      // Add item handler
      addButton.addEventListener('click', () => {
        const items = itemsContainer.querySelectorAll('.repeater-item');
        if (items.length >= maxItems) return;
        
        // Clone the first item
        const template = items[0].cloneNode(true);
        
        // Clear all values in cloned item
        template.querySelectorAll('input, select, textarea').forEach((field) => {
          if (field.type === 'checkbox' || field.type === 'radio') {
            field.checked = false;
          } else {
            field.value = '';
          }
        });
        
        // Copy dynamic options to cloned selects
        template.querySelectorAll('select[data-dynamic-options]').forEach((clonedSelect, idx) => {
          const originalSelect = items[0].querySelectorAll('select[data-dynamic-options]')[idx];
          if (originalSelect) {
            clonedSelect.innerHTML = originalSelect.innerHTML;
          }
        });
        
        // Add to container
        itemsContainer.appendChild(template);
        
        // Setup remove button for new item
        const removeButton = template.querySelector('.remove-item');
        removeButton.addEventListener('click', () => {
          template.remove();
          updateItems();
        });
        
        // Update all items
        updateItems();
        
        // Scroll to new item
        template.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
      
      // Setup remove buttons for existing items
      itemsContainer.querySelectorAll('.repeater-item').forEach((item) => {
        const removeButton = item.querySelector('.remove-item');
        removeButton.addEventListener('click', () => {
          item.remove();
          updateItems();
        });
      });
      
      // Initial update
      updateItems();
    });
    
    console.log('âœ… Repeater fields initialized');
  });
</script>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }
</style>

