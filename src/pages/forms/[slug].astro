---
// Dynamic route for individual forms
export const prerender = true;

import BaseLayout from '../../layouts/BaseLayout.astro';
import DynamicFormTailwind from '../../components/DynamicFormTailwind.astro';
import { getForms, getFormBySlug, getFormSEO } from '../../utils/strapi.js';

// Generate static paths for all forms
export async function getStaticPaths() {
  const forms = await getForms(1, 100);
  
  return forms.map((form) => ({
    params: { slug: form.slug },
    props: { 
      slug: form.slug,
      id: form.id,
      documentId: form.documentId
    }
  }));
}

const { slug } = Astro.params;
const { id, documentId } = Astro.props;
const fallbackIdentifiers = { id, documentId };
console.log(`üìù [${slug}] Static props identifiers:`, fallbackIdentifiers);

// Fetch the specific form data
let formData = null;
try {
  formData = await getFormBySlug(slug, fallbackIdentifiers);
  if (formData) {
    console.log(`üìù [${slug}] Form data fetched successfully`);
    console.log(`üìù [${slug}] Form layout: ${formData.formLayout}`);
    console.log(`üìù [${slug}] Show other options: ${formData.showOtherOptions}`);
  } else {
    console.warn(`üìù [${slug}] Form data not found after lookup`);
  }
} catch (error) {
  console.error(`[${slug}] Error fetching form:`, error.message);
}

// If no data found, show 404
if (!formData) {
  return Astro.redirect('/404');
}

// SEPARATE API CALL: Fetch SEO data with metaImage
try {
  const seoData = await getFormSEO(slug);
  if (seoData) {
    formData.seo = seoData;
    console.log(`üìÑ [${slug}] SEO data merged: ${seoData.metaTitle || 'No title'}, metaImage: ${seoData.metaImage ? 'Yes' : 'No'}`);
  }
} catch (error) {
  console.error(`[${slug}] Error fetching SEO data:`, error.message);
}

// Helper to sanitize description HTML (allowing only <br>, <b>, <u>, and <a href> tags)
const sanitizeDescription = (input = '') => {
  if (!input) {
    return '';
  }

  // Store safe HTML temporarily with tokens
  const links = [];
  const placeholders = [
    { regex: /<br\s*\/?>/gi, token: '__BR__' },
    { regex: /<b>/gi, token: '__B_OPEN__' },
    { regex: /<\/b>/gi, token: '__B_CLOSE__' },
    { regex: /<u>/gi, token: '__U_OPEN__' },
    { regex: /<\/u>/gi, token: '__U_CLOSE__' }
  ];

  let output = input;

  // Extract and tokenize anchor tags
  output = output.replace(/<a\s+href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi, (match, href, text) => {
    // Only allow http, https, mailto, and tel protocols
    if (href.match(/^(https?:\/\/|mailto:|tel:|\/)/)) {
      const index = links.length;
      links.push({ href, text });
      return `__LINK_${index}__`;
    }
    return text; // Strip the link but keep the text if invalid protocol
  });

  // Replace allowed tags with tokens
  placeholders.forEach(({ regex, token }) => {
    output = output.replace(regex, token);
  });

  // Escape all remaining HTML
  output = output
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Restore allowed tags
  output = output
    .replace(/__BR__/g, '<br />')
    .replace(/__B_OPEN__/g, '<b>')
    .replace(/__B_CLOSE__/g, '</b>')
    .replace(/__U_OPEN__/g, '<u>')
    .replace(/__U_CLOSE__/g, '</u>');

  // Restore links
  links.forEach((link, index) => {
    output = output.replace(
      `__LINK_${index}__`,
      `<a href="${link.href}" class="text-[#ad986c] underline hover:text-[#8a7454] transition-colors">${link.text}</a>`
    );
  });

  return output;
};

// Extract data with fallbacks
const heroTitle = formData.hero?.title || formData.title || 'Form';
const heroSubtitle = formData.hero?.subtitle || formData.excerpt || '';
const heroKicker = formData.hero?.kicker || 'GET IN TOUCH';
const heroBackgroundImage = formData.hero?.backgroundImage?.url || 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/45b69090-1c22-46cd-7f98-086ba71efc00/public';
const heroBackgroundImageAlt = formData.hero?.backgroundImage?.alt || heroTitle;

// Don't pass webhook URL to client - it will be fetched server-side by the API
const formSlug = slug;

// Extract SEO fields with fallbacks
const pageTitle = formData.seo?.metaTitle || `${formData.title} - Active Away`;
const pageDescription = formData.seo?.metaDescription || formData.excerpt || `Contact Active Away via ${formData.title}`;
const metaImage = formData.seo?.metaImage || null;
const metaImageAlt = formData.seo?.metaImageAlt || null;
const keywords = formData.seo?.keywords || null;
const canonicalURL = formData.seo?.canonicalURL || `https://activeaway.com/forms/${slug}`;

const formDescriptionHtml = sanitizeDescription(formData.description || '');
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section with Background Image -->
  <section class="relative w-full h-[400px] sm:h-[500px] lg:h-[600px] overflow-hidden">
    <!-- Background Image with Centered Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-b from-[#0D1C4E]/95 via-[#0D1C4E]/80 to-[#0D1C4E]/60 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt={heroBackgroundImageAlt}
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <!-- Centered Content -->
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <div class="hidden sm:block text-xs sm:text-sm font-inter font-semibold text-gold tracking-[0.2em] uppercase mb-4 sm:mb-6 border-t border-b border-gold/50 py-2 px-6">
        {heroKicker}
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {heroTitle}
      </h1>
      <p class="text-lg sm:text-xl lg:text-2xl font-inter text-gray-100 max-w-3xl leading-relaxed">
        {heroSubtitle}
      </p>
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="w-full bg-gray-50 py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <nav class="flex items-center gap-2 text-sm font-inter">
        <a href="/" class="text-gray-600 hover:text-[#ad986c] transition-colors">Home</a>
        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/forms" class="text-gray-600 hover:text-[#ad986c] transition-colors">Forms</a>
        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium">{formData.title}</span>
      </nav>
    </div>
  </section>

  <!-- Main Content Section -->
  <section class="w-full bg-white py-12 sm:py-16 lg:py-20">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      
      <!-- Introduction / Description -->
      {(formData.descriptionTitle || formData.description) && (
        <div class="w-full mb-12 sm:mb-16">
          {formData.descriptionTitle && (
            <h2 class="text-2xl sm:text-3xl lg:text-4xl font-playfair font-bold text-gray-900 mb-6">
              {formData.descriptionTitle}
            </h2>
          )}
          {formData.description && (
            <div class="prose prose-lg max-w-none font-inter text-gray-800 leading-relaxed" set:html={formDescriptionHtml}></div>
          )}
        </div>
      )}

      <!-- Form Section -->
      <div class="w-full">
        <DynamicFormTailwind formData={formData} formSlug={formSlug} />
      </div>
      
    </div>
  </section>
  
</BaseLayout>


<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }
</style>

