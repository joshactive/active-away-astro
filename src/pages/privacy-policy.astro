---
// Privacy Policy Page
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import DynamicFormTailwind from '../components/DynamicFormTailwind.astro';
import { getPrivacyPolicyPage, getPageSEO } from '../utils/strapi.js';
import { marked } from 'marked';

// Configure marked
marked.setOptions({
  breaks: true,
  gfm: true
});

// Fetch page content from Strapi
let pageContent = null;
try {
  pageContent = await getPrivacyPolicyPage();
  console.log('ðŸ“„ [privacy-policy] Page content fetched successfully');
} catch (error) {
  console.warn('[privacy-policy] Could not fetch page content, using defaults:', error.message);
}

// Fetch SEO data separately
let seoData = null;
try {
  seoData = await getPageSEO('privacy-policy-page');
  if (seoData) {
    console.log('ðŸ“„ [privacy-policy] SEO data fetched successfully');
  }
} catch (error) {
  console.warn('[privacy-policy] Could not fetch SEO data:', error.message);
}

// Extract data with fallbacks
const pageTitle = pageContent?.pageTitle || 'Privacy Policy';
const introText = pageContent?.introText || '';
const sections = pageContent?.sections || [];
const lastUpdated = pageContent?.lastUpdated || null;

// Extract SEO fields
const metaTitle = seoData?.metaTitle || pageContent?.seo?.metaTitle || 'Privacy Policy | Active Away';
const metaDescription = seoData?.metaDescription || pageContent?.seo?.metaDescription || 'Read our privacy policy to understand how Active Away collects, uses, and protects your personal data.';
const metaImage = seoData?.metaImage || pageContent?.seo?.metaImage || null;
const metaImageAlt = seoData?.metaImageAlt || pageContent?.seo?.metaImageAlt || null;
const metaImageWidth = seoData?.metaImageWidth || null;
const metaImageHeight = seoData?.metaImageHeight || null;
const keywords = seoData?.keywords || pageContent?.seo?.keywords || null;
const canonicalURL = seoData?.canonicalURL || pageContent?.seo?.canonicalURL || 'https://activeaway.com/privacy-policy';

// Hero content
const heroBackgroundImage = pageContent?.heroBackgroundImage?.url || 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/45b69090-1c22-46cd-7f98-086ba71efc00/public';
const heroBackgroundImageAlt = pageContent?.heroBackgroundImage?.alt || 'Privacy Policy';
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section -->
  <section class="relative w-full h-[300px] sm:h-[400px] lg:h-[500px] overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-[#0D1C4E]/75 to-[#0D1C4E]/60 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt={heroBackgroundImageAlt}
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {pageTitle}
      </h1>
      {lastUpdated && (
        <p class="text-base sm:text-lg font-inter text-gray-100">
          Last updated: {new Date(lastUpdated).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
        </p>
      )}
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="w-full bg-gray-50 py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <nav class="flex items-center space-x-2 text-sm font-inter">
        <a href="/" class="text-gray-600 hover:text-[#ad986c] transition-colors">Home</a>
        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium">{pageTitle}</span>
      </nav>
    </div>
  </section>

  <!-- Main Content -->
  <main class="w-full bg-white py-12 sm:py-16 lg:py-20">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      
      <!-- Introduction -->
      {introText && (
        <div class="mb-12 bg-gray-50 border border-gray-200 rounded-xl p-6 sm:p-8">
          <p class="text-xs font-inter font-semibold text-[#ad986c] tracking-wider uppercase mb-3">IMPORTANT</p>
          <div class="prose prose-lg max-w-none font-inter" set:html={marked.parse(introText)}></div>
        </div>
      )}

      <!-- Table of Contents -->
      {sections.length > 0 && (
        <div class="mb-12 bg-white border-2 border-gray-200 rounded-xl p-6 sm:p-8 shadow-sm">
          <h2 class="text-2xl font-playfair font-bold text-gray-900 mb-6">Contents</h2>
          <nav class="grid grid-cols-1 sm:grid-cols-2 gap-3" data-privacy-toc>
            {sections.map((section) => (
              <a href={`#${section.sectionSlug}`} class="flex items-center gap-2 text-base font-inter text-gray-700 hover:text-[#ad986c] transition-colors py-2 px-3 rounded-lg hover:bg-gray-50">
                <svg class="w-4 h-4 flex-shrink-0 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                {section.sectionTitle}
              </a>
            ))}
          </nav>
        </div>
      )}

      <!-- Privacy Sections -->
      <div class="privacy-accordion-list space-y-4">
        {sections.map((section, index) => (
          <div id={section.sectionSlug} class="privacy-accordion bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300 scroll-mt-20">
            <button class="privacy-accordion-header flex w-full items-center justify-between px-4 py-4 sm:px-6 sm:py-5 text-left cursor-pointer hover:bg-gray-50 transition-colors" type="button" aria-expanded="false">
              <h3 class="text-base lg:text-lg font-inter font-medium text-gray-900 pr-4">{section.sectionTitle}</h3>
              <div class="privacy-accordion-icon flex-shrink-0">
                <div class="privacy-accordion-arrow w-6 h-6 flex items-center justify-center transition-transform duration-300">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4 6L8 10L12 6" stroke="#1E1E1E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </div>
              </div>
            </button>
            <div class="privacy-accordion-content overflow-hidden">
              <div class="px-4 pb-6 sm:px-6 sm:pb-8 pt-0">
                {section.content && (
                  <div class="privacy-richtext prose prose-lg max-w-none font-inter mb-6" set:html={marked.parse(section.content)}></div>
                )}
                
                {section.showForm && section.formFields && (
                  <div class="mt-6">
                    <DynamicFormTailwind 
                      formData={{
                        slug: section.sectionSlug,
                        formFields: section.formFields,
                        webhookUrl: section.formWebhookUrl || 'https://hook.eu2.make.com/your-webhook-url',
                        formLayout: 'single-column',
                        showOtherOptions: false,
                        formHeading: '',
                        formSubtitle: ''
                      }}
                      formSlug={section.sectionSlug}
                      heading=""
                      subtitle=""
                      showOtherOptions={false}
                    />
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </main>

  <script is:inline>
    if (typeof window !== 'undefined') {
      const initPrivacyAccordions = () => {
        const accordions = document.querySelectorAll('.privacy-accordion');
        accordions.forEach((accordion) => {
          const header = accordion.querySelector('.privacy-accordion-header');
          if (header) {
            header.addEventListener('click', () => togglePrivacyAccordion(accordion));
          }
        });

        const tocLinks = document.querySelectorAll('[data-privacy-toc] a[href^="#"]');
        tocLinks.forEach((link) => {
          link.addEventListener('click', () => {
            const targetId = link.getAttribute('href')?.replace('#', '');
            if (!targetId) return;
            const targetAccordion = document.getElementById(targetId);
            if (!targetAccordion) return;
            setTimeout(() => openPrivacyAccordion(targetAccordion), 150);
          });
        });
      };

      const togglePrivacyAccordion = (accordion) => {
        if (!accordion) return;
        const isOpen = accordion.classList.contains('open');
        const parent = accordion.parentElement;

        if (parent) {
          parent.querySelectorAll('.privacy-accordion').forEach((item) => {
            if (item !== accordion) {
              collapsePrivacyAccordion(item);
            }
          });
        }

        if (isOpen) {
          collapsePrivacyAccordion(accordion);
        } else {
          openPrivacyAccordion(accordion);
        }
      };

      const openPrivacyAccordion = (accordion) => {
        const content = accordion.querySelector('.privacy-accordion-content');
        const arrow = accordion.querySelector('.privacy-accordion-arrow');
        const header = accordion.querySelector('.privacy-accordion-header');

        accordion.classList.add('open', 'shadow-lg');
        accordion.classList.remove('shadow-sm');

        if (content) {
          content.style.maxHeight = content.scrollHeight + 'px';
          content.style.opacity = '1';
        }

        if (arrow) {
          arrow.classList.add('rotate-180');
        }

        if (header) {
          header.setAttribute('aria-expanded', 'true');
        }
      };

      const collapsePrivacyAccordion = (accordion) => {
        const content = accordion.querySelector('.privacy-accordion-content');
        const arrow = accordion.querySelector('.privacy-accordion-arrow');
        const header = accordion.querySelector('.privacy-accordion-header');

        accordion.classList.remove('open', 'shadow-lg');
        accordion.classList.add('shadow-sm');

        if (content) {
          content.style.maxHeight = '0px';
          content.style.opacity = '0';
        }

        if (arrow) {
          arrow.classList.remove('rotate-180');
        }

        if (header) {
          header.setAttribute('aria-expanded', 'false');
        }
      };

      document.addEventListener('DOMContentLoaded', initPrivacyAccordions);
    }
  </script>
</BaseLayout>

<style>
  .prose {
    color: #1f2937;
  }

  .privacy-richtext :global(h1),
  .privacy-richtext :global(h2),
  .privacy-richtext :global(h3),
  .privacy-richtext :global(h4),
  .privacy-richtext :global(h5),
  .privacy-richtext :global(h6) {
    font-family: 'Playfair Display', serif;
    color: #111827;
    font-weight: 700;
    line-height: 1.2;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .privacy-richtext :global(h1) {
    font-size: clamp(2.25rem, 5vw, 3rem);
    border-bottom: 3px solid #ad986c;
    padding-bottom: 0.75rem;
  }

  .privacy-richtext :global(h2) {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.5rem;
  }

  .privacy-richtext :global(h3) {
    font-size: clamp(1.5rem, 3vw, 2rem);
  }

  .privacy-richtext :global(h4) {
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
  }

  .privacy-richtext :global(h5) {
    font-size: 1.125rem;
    color: #111827;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .privacy-richtext :global(h6) {
    font-size: 1rem;
    color: #111827;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .privacy-richtext :global(p) {
    margin-bottom: 1.25rem;
    line-height: 1.75;
    color: #1f2937;
  }

  .privacy-richtext :global(ul),
  .privacy-richtext :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
  }

  .privacy-richtext :global(li) {
    margin-bottom: 0.5rem;
    line-height: 1.7;
  }

  .privacy-richtext :global(strong) {
    color: #111827;
  }

  .privacy-richtext :global(a) {
    color: #ad986c;
    text-decoration: underline;
    transition: color 0.2s ease;
  }

  .privacy-richtext :global(a:hover) {
    color: #8d7a56;
  }

  .privacy-accordion-header {
    background: transparent;
    border: none;
  }

  .privacy-accordion-header:focus-visible {
    outline: 2px solid #ad986c;
    outline-offset: 2px;
  }

  .privacy-accordion-content {
    max-height: 0;
    opacity: 0;
    transition: max-height 0.4s ease, opacity 0.3s ease;
  }

  .privacy-accordion.open .privacy-accordion-content {
    opacity: 1;
  }

  /* Privacy Policy Form Styling - Flat fields without shadows */
  :global(.privacy-accordion input[type="text"]),
  :global(.privacy-accordion input[type="email"]),
  :global(.privacy-accordion input[type="tel"]),
  :global(.privacy-accordion input[type="date"]),
  :global(.privacy-accordion input[type="number"]),
  :global(.privacy-accordion textarea),
  :global(.privacy-accordion select) {
    box-shadow: none !important;
    border: 1px solid #d1d5db !important;
    background: #ffffff !important;
  }

  :global(.privacy-accordion input[type="text"]:focus),
  :global(.privacy-accordion input[type="email"]:focus),
  :global(.privacy-accordion input[type="tel"]:focus),
  :global(.privacy-accordion input[type="date"]:focus),
  :global(.privacy-accordion input[type="number"]:focus),
  :global(.privacy-accordion textarea:focus),
  :global(.privacy-accordion select:focus) {
    box-shadow: none !important;
    border-color: #ad986c !important;
    outline: none !important;
  }
</style>

