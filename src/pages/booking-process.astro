---
// Booking Process Page
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import PageHeroTailwind from '../components/PageHeroTailwind.astro';
import BreadcrumbsTailwind from '../components/BreadcrumbsTailwind.astro';
import { getBookingProcessPage, getBookingProcessPageSEO } from '../utils/strapi.js';
import { parseMarkdown } from '../utils/markdown.js';

function extractYouTubeId(url) {
  if (!url) return null;
  try {
    const cleanedUrl = url.trim();
    const regex =
      /(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
    const match = cleanedUrl.match(regex);
    if (match && match[1]) {
      return match[1];
    }

    const parsedUrl = new URL(cleanedUrl);
    if (parsedUrl.hostname === 'youtu.be') {
      return parsedUrl.pathname.slice(1);
    }

    return parsedUrl.searchParams.get('v');
  } catch (error) {
    console.warn('âš ï¸  [extractYouTubeId] Could not parse URL:', url);
    return null;
  }
}

// Fetch Booking Process page data
let pageData = null;
try {
  pageData = await getBookingProcessPage();
  console.log('ðŸ“‹ [booking-process] Page data fetched');
} catch (error) {
  console.error('âŒ [booking-process] Error fetching page:', error.message);
}

// Fetch SEO data
let seoData = null;
try {
  seoData = await getBookingProcessPageSEO();
  if (seoData) {
    console.log('ðŸ“„ [booking-process] SEO data fetched');
  }
} catch (error) {
  console.warn('âš ï¸  [booking-process] Could not fetch SEO data:', error.message);
}

// Extract SEO fields
const pageTitle = seoData?.metaTitle || pageData?.seo?.metaTitle || 'The Booking Process | Active Away';
const pageDescription = seoData?.metaDescription || pageData?.seo?.metaDescription || 'Learn how to book your tennis holiday with Active Away. Find information about accommodation, payments, and making changes to your booking.';

// Extract meta image URL properly
let metaImage = null;
if (seoData?.metaImage) {
  metaImage = typeof seoData.metaImage === 'string' ? seoData.metaImage : seoData.metaImage.url;
} else if (pageData?.seo?.metaImage) {
  metaImage = typeof pageData.seo.metaImage === 'string' ? pageData.seo.metaImage : pageData.seo.metaImage.url;
}

const metaImageAlt = seoData?.metaImageAlt || pageData?.seo?.metaImageAlt || null;
const metaImageWidth = seoData?.metaImageWidth || pageData?.seo?.metaImageWidth || null;
const metaImageHeight = seoData?.metaImageHeight || pageData?.seo?.metaImageHeight || null;
const keywords = seoData?.keywords || pageData?.seo?.keywords || null;
const canonicalURL = seoData?.canonicalURL || pageData?.seo?.canonicalURL || 'https://activeaway.com/booking-process';

// Parse markdown content
const introTitle = pageData?.introTitle || 'How to Book';
const introSubtitle = pageData?.introSubtitle || '';

const youTubeId = pageData?.videoGuideUrl ? extractYouTubeId(pageData.videoGuideUrl) : null;
const youTubeThumbnail = youTubeId
  ? `https://i.ytimg.com/vi/${youTubeId}/hqdefault.jpg`
  : null;

// Tab data
const tabs = [
  {
    id: 'video',
    title: pageData?.videoGuideTitle || 'Video Guide',
    hasContent: !!youTubeId
  },
  {
    id: 'general',
    title: pageData?.generalInfoTitle || 'General Info',
    hasContent: !!pageData?.generalInfoContent
  },
  {
    id: 'included',
    title: pageData?.accommodationIncludedTitle || 'Accommodation Included',
    hasContent: !!pageData?.accommodationIncludedContent
  },
  {
    id: 'excluded',
    title: pageData?.accommodationExcludedTitle || 'Accommodation Excluded',
    hasContent: !!pageData?.accommodationExcludedContent
  },
  {
    id: 'changes',
    title: pageData?.makingChangesTitle || 'Making Changes',
    hasContent: !!pageData?.makingChangesContent
  }
].filter(tab => tab.hasContent);

// Parse content for rich text tabs
const generalInfoContent = pageData?.generalInfoContent ? parseMarkdown(pageData.generalInfoContent) : '';
const accommodationIncludedContent = pageData?.accommodationIncludedContent ? parseMarkdown(pageData.accommodationIncludedContent) : '';
const accommodationExcludedContent = pageData?.accommodationExcludedContent ? parseMarkdown(pageData.accommodationExcludedContent) : '';
const makingChangesContent = pageData?.makingChangesContent ? parseMarkdown(pageData.makingChangesContent) : '';

// Get first tab with content as default
const firstTabId = tabs.length > 0 ? tabs[0].id : 'video';
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Page Hero (Background Image) -->
  {pageData?.pageHero && (
    <PageHeroTailwind pageData={pageData} />
  )}
  
  <!-- Breadcrumbs Section -->
  {pageData?.pageHero?.showBreadcrumbs !== false && (
    <BreadcrumbsTailwind 
      breadcrumbs={[
        { label: 'Home', href: '/' },
        { label: 'The Booking Process' }
      ]}
    />
  )}
  
  <!-- Main Content -->
  <main class="w-full bg-white">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10 py-12 sm:py-16 lg:py-20">
      
      <!-- Introduction Section -->
      <div class="text-center max-w-4xl mx-auto">
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-playfair font-bold text-gray-900 mb-4">
          {introTitle}
        </h2>
        {introSubtitle && (
          <p class="text-lg sm:text-xl text-gray-600 font-inter">
            {introSubtitle}
          </p>
        )}
      </div>
      
    </div>
    
    <!-- Tab Navigation - Sticky -->
    {tabs.length > 0 && (
      <nav class="sticky top-0 z-30 w-full bg-white border-b border-gray-200 shadow-sm">
        <div class="w-full overflow-x-auto scrollbar-hide">
          <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
            <div class="flex items-center justify-start sm:justify-center gap-2 py-3">
              {tabs.map((tab, index) => (
                <button 
                  class={`booking-tab ${index === 0 ? 'active' : ''} px-6 py-3 text-sm font-medium font-inter rounded-full whitespace-nowrap transition-all`}
                  data-tab={tab.id}
                >
                  {tab.title}
                </button>
              ))}
            </div>
          </div>
        </div>
      </nav>
    )}
    
    <!-- Tab Content Sections -->
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10 py-8 sm:py-12 lg:py-16 mb-12 sm:mb-16 lg:mb-20">
      
      <!-- Video Guide Tab -->
      {youTubeId && (
        <div 
          id="tab-video" 
          class={`tab-content ${firstTabId === 'video' ? 'active' : ''}`}
        >
          <div class="max-w-5xl mx-auto">
            <div class="relative w-full aspect-video rounded-xl overflow-hidden shadow-lg">
              <button 
                type="button"
                class="lite-youtube-booking group"
                data-video-id={youTubeId}
                aria-label={pageData?.videoGuideTitle || 'Play booking process video guide'}
              >
                {youTubeThumbnail && (
                  <img 
                    src={youTubeThumbnail}
                    alt={pageData?.videoGuideTitle || 'Booking process video guide thumbnail'}
                    loading="lazy"
                    decoding="async"
                    class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                )}
                <span class="lite-youtube__play"></span>
              </button>
            </div>
          </div>
        </div>
      )}
      
      <!-- General Info Tab -->
      {generalInfoContent && (
        <div 
          id="tab-general" 
          class={`tab-content ${firstTabId === 'general' ? 'active' : ''}`}
        >
          <div class="prose prose-lg max-w-none font-inter" set:html={generalInfoContent}></div>
        </div>
      )}
      
      <!-- Accommodation Included Tab -->
      {accommodationIncludedContent && (
        <div 
          id="tab-included" 
          class={`tab-content ${firstTabId === 'included' ? 'active' : ''}`}
        >
          <!-- Payment Calculator -->
          <div class="bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200 rounded-2xl p-6 sm:p-8 mb-8 shadow-sm">
            <h3 class="text-xl sm:text-2xl font-playfair font-bold text-gray-900 mb-2">
              Payment Calculator
            </h3>
            <p class="text-sm sm:text-base text-gray-600 font-inter mb-6">
              Find out if you need to pay a deposit or the full balance based on your trip date.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-end">
              <div class="flex-1 w-full">
                <label for="trip-date" class="block text-sm font-inter font-semibold text-gray-700 mb-2">
                  Trip Start Date
                </label>
                <input 
                  type="date" 
                  id="trip-date"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-inter text-base focus:outline-none focus:ring-2 focus:ring-[#ad986c] focus:border-transparent transition-all"
                  placeholder="Select your trip date"
                />
              </div>
              <button 
                id="calculate-payment"
                class="w-full sm:w-auto px-6 py-3 bg-[#ad986c] hover:bg-[#8a7454] text-white font-inter font-semibold rounded-lg transition-all duration-300 hover:shadow-lg"
              >
                Calculate
              </button>
            </div>
            
            <!-- Result Display -->
            <div id="payment-result" class="hidden mt-6 p-4 sm:p-6 bg-white rounded-xl border-2 border-gray-200">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#ad986c]/10 flex items-center justify-center">
                  <svg class="w-5 h-5 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-inter text-gray-600 mb-1" id="days-until"></p>
                  <p class="text-lg sm:text-xl font-playfair font-bold text-gray-900 mb-1">
                    You need to pay: <span id="payment-type" class="text-[#ad986c]"></span>
                  </p>
                  <p class="text-sm font-inter text-gray-600" id="payment-explanation"></p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="prose prose-lg max-w-none font-inter" set:html={accommodationIncludedContent}></div>
        </div>
      )}
      
      <!-- Accommodation Excluded Tab -->
      {accommodationExcludedContent && (
        <div 
          id="tab-excluded" 
          class={`tab-content ${firstTabId === 'excluded' ? 'active' : ''}`}
        >
          <div class="prose prose-lg max-w-none font-inter" set:html={accommodationExcludedContent}></div>
        </div>
      )}
      
      <!-- Making Changes Tab -->
      {makingChangesContent && (
        <div 
          id="tab-changes" 
          class={`tab-content ${firstTabId === 'changes' ? 'active' : ''}`}
        >
          <div class="prose prose-lg max-w-none font-inter" set:html={makingChangesContent}></div>
        </div>
      )}
      
    </div>
  </main>
</BaseLayout>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }
  
  .lite-youtube-booking {
    position: relative;
    display: block;
    width: 100%;
    height: 100%;
    background-color: #000;
    cursor: pointer;
    border: none;
    padding: 0;
  }

  .lite-youtube-booking::before {
    content: '';
    display: block;
    padding-top: 56.25%;
  }

  .lite-youtube-booking img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .lite-youtube__play {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 72px;
    height: 52px;
    transform: translate(-50%, -50%);
    background: rgba(13, 28, 78, 0.85);
    border-radius: 16px;
    transition: background 0.3s ease, transform 0.3s ease;
    box-shadow: 0 15px 30px rgba(13, 28, 78, 0.35);
  }

  .lite-youtube__play::before {
    content: '';
    position: absolute;
    left: 26px;
    top: 16px;
    border-style: solid;
    border-width: 10px 0 10px 18px;
    border-color: transparent transparent transparent #fff;
  }

  .lite-youtube-booking:hover .lite-youtube__play {
    background: rgba(173, 152, 108, 0.95);
    transform: translate(-50%, -50%) scale(1.05);
  }
  
  /* Tab Navigation Styles */
  .booking-tab {
    background: white;
    color: #6b7280;
    border: 1px solid #e5e7eb;
  }
  
  .booking-tab:hover {
    background: #f9fafb;
    color: #ad986c;
    border-color: #ad986c;
  }
  
  .booking-tab.active {
    background: #ad986c;
    color: white;
    border-color: #ad986c;
  }
  
  /* Tab Content Styles */
  .tab-content {
    display: none;
    opacity: 0;
    animation: fadeIn 0.3s ease-in-out forwards;
  }
  
  .tab-content.active {
    display: block;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Hide scrollbar but keep functionality */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  /* Prose Styles - Using :global() to properly target markdown content */
  :global(.prose p) {
    margin: 0 0 1.5rem 0;
    line-height: 1.75;
    font-size: 1rem;
  }
  
  @media (min-width: 640px) {
    :global(.prose p) {
      font-size: 1.125rem;
    }
  }
  
  :global(.prose p:last-child) {
    margin-bottom: 0;
  }
  
  :global(.prose h1),
  :global(.prose h2),
  :global(.prose h3),
  :global(.prose h4),
  :global(.prose h5),
  :global(.prose h6) {
    font-family: 'Playfair Display', serif !important;
    color: rgb(17 24 39) !important;
    font-weight: 600 !important;
    font-style: normal !important;
    letter-spacing: normal !important;
    text-transform: none !important;
  }
  
  :global(.prose h1) {
    font-size: 2.25rem !important;
    margin-top: 0 !important;
    margin-bottom: 2rem !important;
    line-height: 1.2 !important;
  }
  
  :global(.prose h2) {
    font-size: 1.875rem !important;
    margin-top: 3rem !important;
    margin-bottom: 1.5rem !important;
    line-height: 1.3 !important;
  }
  
  :global(.prose h3) {
    font-size: 1.5rem !important;
    margin-top: 2rem !important;
    margin-bottom: 1rem !important;
    line-height: 1.4 !important;
  }
  
  :global(.prose h4) {
    font-size: 1.25rem !important;
    margin-top: 1.5rem !important;
    margin-bottom: 0.75rem !important;
  }
  
  @media (min-width: 640px) {
    :global(.prose h1) {
      font-size: 2.5rem !important;
    }
    
    :global(.prose h2) {
      font-size: 2rem !important;
    }
    
    :global(.prose h3) {
      font-size: 1.625rem !important;
    }
  }
  
  @media (min-width: 1024px) {
    :global(.prose h1) {
      font-size: 3rem !important;
    }
    
    :global(.prose h2) {
      font-size: 2.25rem !important;
    }
    
    :global(.prose h3) {
      font-size: 1.75rem !important;
    }
  }
  
  :global(.prose ul),
  :global(.prose ol) {
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    padding-left: 1.75rem;
  }
  
  :global(.prose li) {
    margin-bottom: 0.5rem;
  }
  
  :global(.prose strong) {
    font-weight: 600;
    color: rgb(17 24 39);
  }
  
  :global(.prose a) {
    color: #ad986c;
    text-decoration: underline;
  }
  
  :global(.prose a:hover) {
    color: #8a7454;
  }
  
  :global(.prose blockquote) {
    border-left: 4px solid #ad986c;
    padding-left: 1.5rem;
    font-style: italic;
    color: rgb(75 85 99);
    margin: 2rem 0;
  }
  
  :global(.prose code) {
    background: #f3f4f6;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }
  
  :global(.prose pre) {
    background: #1f2937;
    color: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
  }
  
  :global(.prose pre code) {
    background: transparent;
    padding: 0;
    color: inherit;
  }
  
  :global(.prose table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }
  
  :global(.prose th),
  :global(.prose td) {
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    text-align: left;
  }
  
  :global(.prose th) {
    background: #f9fafb;
    font-weight: 600;
  }
  
  :global(.prose hr) {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 2rem 0;
  }
</style>

<script>
  // Tab switching + lite YouTube embeds + Payment Calculator
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.booking-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    if (tabButtons.length && tabContents.length) {
      tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const tabId = button.getAttribute('data-tab');
          
          // Remove active class from all tabs and contents
          tabButtons.forEach((btn) => btn.classList.remove('active'));
          tabContents.forEach((content) => content.classList.remove('active'));
          
          // Add active class to clicked tab
          button.classList.add('active');
          
          // Show corresponding content
          const targetContent = document.getElementById(`tab-${tabId}`);
          if (targetContent) {
            targetContent.classList.add('active');
            
            // Smooth scroll to content on mobile
            if (window.innerWidth < 768) {
              targetContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }
        });
      });
    }

    // Payment Calculator Logic
    const calculateButton = document.getElementById('calculate-payment');
    const tripDateInput = document.getElementById('trip-date');
    const resultDiv = document.getElementById('payment-result');
    const daysUntilText = document.getElementById('days-until');
    const paymentTypeText = document.getElementById('payment-type');
    const paymentExplanationText = document.getElementById('payment-explanation');

    // Set minimum date to today (prevent past dates)
    if (tripDateInput) {
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      tripDateInput.setAttribute('min', todayString);
    }

    if (calculateButton && tripDateInput) {
      calculateButton.addEventListener('click', () => {
        const tripDate = tripDateInput.value;
        
        if (!tripDate) {
          alert('Please select your trip start date');
          return;
        }

        // Calculate days between today and trip date
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day
        
        const selectedDate = new Date(tripDate);
        selectedDate.setHours(0, 0, 0, 0); // Reset time to start of day
        
        const diffTime = selectedDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // Determine payment type based on 84-day threshold
        let paymentType = '';
        let explanation = '';
        
        if (diffDays < 0) {
          // Past date
          daysUntilText.textContent = 'This date has already passed';
          paymentTypeText.textContent = 'N/A';
          explanationText.textContent = 'Please select a future date for your trip.';
        } else if (diffDays < 84) {
          // Less than 84 days - Balance due
          paymentType = 'Full Balance';
          daysUntilText.textContent = `Your trip is ${diffDays} day${diffDays !== 1 ? 's' : ''} away`;
          explanation = 'Since your trip is less than 84 days away, the full balance is due now.';
        } else {
          // 84 days or more - Deposit due
          paymentType = 'Deposit';
          daysUntilText.textContent = `Your trip is ${diffDays} day${diffDays !== 1 ? 's' : ''} away`;
          explanation = 'Since your trip is 84 days or more away, you only need to pay a deposit now. The balance will be due 84 days before your trip.';
        }

        // Update result display
        paymentTypeText.textContent = paymentType;
        paymentExplanationText.textContent = explanation;
        
        // Show result
        resultDiv.classList.remove('hidden');
        
        // Smooth scroll to result
        setTimeout(() => {
          resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      });
    }

    const liteYouTubeTriggers = document.querySelectorAll('.lite-youtube-booking');
    liteYouTubeTriggers.forEach((trigger) => {
      trigger.addEventListener(
        'click',
        () => {
          const videoId = trigger.getAttribute('data-video-id');
          if (!videoId) return;

          const iframe = document.createElement('iframe');
          iframe.setAttribute('allowfullscreen', '');
          iframe.setAttribute('loading', 'lazy');
          iframe.setAttribute(
            'title',
            trigger.getAttribute('aria-label') || 'Booking process video guide'
          );
          iframe.setAttribute(
            'src',
            `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0`
          );
          iframe.setAttribute(
            'allow',
            'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'
          );
          iframe.style.position = 'absolute';
          iframe.style.inset = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';

          const wrapper = document.createElement('div');
          wrapper.style.position = 'relative';
          wrapper.style.width = '100%';
          wrapper.style.height = '100%';
          wrapper.appendChild(iframe);

          trigger.replaceWith(wrapper);
        },
        { once: true }
      );
    });
  });
</script>

