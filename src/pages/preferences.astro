---
/**
 * Email Preferences Page
 * Allows subscribers to update their interests/preferences
 * Dynamically fetches current preferences from Moosend
 * 
 * Usage: https://activeaway.com/preferences?email=user@example.com
 * Moosend will redirect users here with their email pre-filled
 */

import BaseLayout from '../layouts/BaseLayout.astro';

// Get email from URL query parameter (Moosend will pass this)
const url = new URL(Astro.request.url);
const prefilledEmail = url.searchParams.get('email') || '';

// Page content
const heroTitle = "Update Your Preferences";
const heroSubtitle = "Tell us what you're interested in so we can send you relevant updates, offers, and information.";
const heroKicker = "YOUR INFO";
const heroBackgroundImage = "https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/f1c3c78b-d25b-4394-c243-37f8162a2d00/public";

// Preference options (matching Moosend custom field options)
const preferenceOptions = [
  { id: 'tennis', label: 'Tennis', value: 'Tennis' },
  { id: 'padel', label: 'Padel', value: 'Padel' },
  { id: 'pickleball', label: 'Pickleball', value: 'Pickleball' },
  { id: 'junior-tennis', label: 'Junior Tennis', value: 'Junior Tennis' },
  { id: 'skiing', label: 'Skiing', value: 'Skiing' },
  { id: 'golf', label: 'Golf', value: 'Golf' },
  { id: 'walking', label: 'Walking', value: 'Walking' },
  { id: 'luxury-holiday', label: 'Luxury Holiday', value: 'Luxury Holiday' },
];

// SEO
const pageTitle = "Update Your Preferences - Active Away";
const pageDescription = "Update your email preferences to receive relevant updates about tennis holidays, padel, pickleball, and more from Active Away.";
const canonicalURL = "https://activeaway.com/preferences";
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section with Background Image -->
  <section class="relative w-full h-[400px] sm:h-[500px] lg:h-[600px] overflow-hidden">
    <!-- Background Image with Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-b from-[#0D1C4E]/95 via-[#0D1C4E]/80 to-[#0D1C4E]/60 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt="Update Your Preferences"
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <!-- Centered Content -->
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <div class="hidden sm:block text-xs sm:text-sm font-inter font-semibold text-gold tracking-[0.2em] uppercase mb-4 sm:mb-6 border-t border-b border-gold/50 py-2 px-6">
        {heroKicker}
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {heroTitle}
      </h1>
      <p class="text-lg sm:text-xl lg:text-2xl font-inter text-gray-100 max-w-3xl leading-relaxed">
        {heroSubtitle}
      </p>
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="w-full bg-gray-50 py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <nav class="flex items-center gap-2 text-sm font-inter">
        <a href="/" class="text-gray-600 hover:text-[#ad986c] transition-colors">Home</a>
        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium">Preferences</span>
      </nav>
    </div>
  </section>

  <!-- Main Content Section -->
  <section class="w-full bg-white py-12 sm:py-16 lg:py-20">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      
      <!-- Section Header -->
      <div class="text-center mb-8">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-playfair font-semibold text-gray-900 mb-4">
          Submit Your Preferences
        </h2>
        <p class="text-base font-inter text-gray-800 leading-relaxed">
          Update your preferences to receive relevant updates from Active Away
        </p>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="hidden mb-6">
        <div class="flex items-center justify-center gap-3 p-6 bg-gray-50 rounded-lg">
          <svg class="animate-spin h-5 w-5 text-[#ad986c]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="text-gray-600 font-inter">Loading your current preferences...</span>
        </div>
      </div>

      <form id="preferences-form" class="space-y-6">
        
        <!-- Card: Your Information -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 font-playfair">Your Information</h3>
            <p class="text-xs text-gray-500 mt-1 font-inter">Please provide your email address</p>
          </div>
          <div class="p-6">
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 font-inter mb-2">
                Email Address <span class="text-red-500">*</span>
              </label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                required
                value={prefilledEmail}
                placeholder="Enter your email address"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-900 font-inter text-base focus:outline-none focus:ring-2 focus:ring-[#ad986c] focus:border-transparent transition-all"
              />
              <p id="email-hint" class="mt-2 text-sm text-gray-500 font-inter hidden">
                Enter the email address you subscribed with
              </p>
            </div>
          </div>
        </div>

        <!-- Card: Preferences -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 font-playfair">Please select what you are interested in</h3>
            <p class="text-xs text-gray-500 mt-1 font-inter">Select all that apply</p>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="preferences-container">
              {preferenceOptions.map((option) => (
                <label class="flex items-center gap-3 cursor-pointer group p-3 rounded-lg hover:bg-gray-50 transition-colors">
                  <input 
                    type="checkbox" 
                    name="preferences" 
                    value={option.value}
                    data-preference={option.value}
                    class="w-5 h-5 rounded border-gray-300 text-[#ad986c] focus:ring-[#ad986c] cursor-pointer"
                  />
                  <span class="text-gray-800 font-inter text-base group-hover:text-[#ad986c] transition-colors">
                    {option.label}
                  </span>
                </label>
              ))}
            </div>
            
            <!-- Current preferences info -->
            <div id="current-prefs-info" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <p class="text-blue-800 font-inter text-sm">
                <span class="font-medium">Your current selections are shown above.</span> 
                Update them and click save to change your preferences.
              </p>
            </div>
          </div>
        </div>

        <!-- Consent Card -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 font-playfair">Marketing Consent</h3>
          </div>
          <div class="p-6">
            <label class="flex items-start gap-3 cursor-pointer group">
              <input 
                type="checkbox" 
                name="consent" 
                id="consent"
                required
                class="w-5 h-5 mt-0.5 rounded border-gray-300 text-[#ad986c] focus:ring-[#ad986c] cursor-pointer"
              />
              <span class="text-gray-800 font-inter text-sm leading-relaxed">
                I consent to receiving updates, offers, and information from Active Away. 
                <span class="text-red-500">*</span>
              </span>
            </label>
          </div>
        </div>

        <!-- Cloudflare Turnstile -->
        {import.meta.env.PUBLIC_TURNSTILE_SITE_KEY && (
          <div class="cf-turnstile" data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY} data-theme="light"></div>
        )}

        <!-- Submit Button -->
        <div class="pt-4">
          <button 
            type="submit"
            id="submit-button"
            class="w-full sm:w-auto px-8 py-3 bg-[#ad986c] hover:bg-[#8d7a56] text-white font-inter font-semibold text-base rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="button-text">Save Preferences</span>
          </button>
        </div>

        <!-- Messages -->
        <div id="success-message" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <p class="text-green-800 font-inter text-sm">Your preferences have been saved successfully! Redirecting...</p>
          </div>
        </div>

        <div id="error-message" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <p id="error-text" class="text-red-800 font-inter text-sm">Something went wrong. Please try again.</p>
          </div>
        </div>

      </form>
      
    </div>
  </section>
  
</BaseLayout>

<script define:vars={{ prefilledEmail }}>
  document.addEventListener('DOMContentLoaded', async () => {
    const form = document.getElementById('preferences-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const loadingState = document.getElementById('loading-state');
    const emailInput = document.getElementById('email');
    const emailHint = document.getElementById('email-hint');
    const currentPrefsInfo = document.getElementById('current-prefs-info');

    if (!form) return;

    // Function to fetch current preferences
    async function fetchCurrentPreferences(email) {
      if (!email) return;

      try {
        loadingState.classList.remove('hidden');
        form.classList.add('opacity-50');
        submitButton.disabled = true;

        const response = await fetch(`/api/get-preferences.json?email=${encodeURIComponent(email)}`);
        const data = await response.json();

        if (data.success && data.found && data.preferences && data.preferences.length > 0) {
          // Pre-check the checkboxes based on current preferences
          const checkboxes = document.querySelectorAll('input[name="preferences"]');
          checkboxes.forEach((checkbox) => {
            const value = checkbox.getAttribute('data-preference');
            if (data.preferences.includes(value)) {
              checkbox.checked = true;
            }
          });
          
          // Show the info message
          currentPrefsInfo.classList.remove('hidden');
          console.log('✅ Loaded current preferences:', data.preferences);
        } else {
          console.log('ℹ️ No existing preferences found for this email');
        }
      } catch (error) {
        console.error('Error fetching preferences:', error);
        // Don't show error - just let user fill in fresh
      } finally {
        loadingState.classList.add('hidden');
        form.classList.remove('opacity-50');
        submitButton.disabled = false;
      }
    }

    // If email is provided in URL, fetch current preferences
    if (prefilledEmail) {
      await fetchCurrentPreferences(prefilledEmail);
    } else {
      // Show hint to enter email
      emailHint.classList.remove('hidden');
    }

    // Also fetch when email field loses focus (in case they typed it manually)
    let lastFetchedEmail = prefilledEmail;
    emailInput.addEventListener('blur', async () => {
      const email = emailInput.value.trim();
      if (email && email !== lastFetchedEmail && email.includes('@')) {
        lastFetchedEmail = email;
        await fetchCurrentPreferences(email);
      }
    });

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Get form data
      const formData = new FormData(form);
      const email = formData.get('email');
      const preferences = formData.getAll('preferences');
      
      // Get Turnstile token if available
      let turnstileToken = '';
      const turnstileInput = form.querySelector('[name="cf-turnstile-response"]');
      if (turnstileInput) {
        turnstileToken = turnstileInput.value;
      }

      // Get consent checkbox
      const consent = formData.get('consent');

      // Validate
      if (!email) {
        showError('Please enter your email address.');
        return;
      }

      if (preferences.length === 0) {
        showError('Please select at least one preference.');
        return;
      }

      if (!consent) {
        showError('Please confirm your consent to receive updates.');
        return;
      }

      // Show loading state
      submitButton.disabled = true;
      buttonText.textContent = 'Saving...';
      hideMessages();

      try {
        const response = await fetch('/api/update-preferences.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email,
            preferences,
            turnstileToken
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          showSuccess();
          
          // Dispatch analytics event
          try {
            const analyticsEvent = new CustomEvent('active-away-form-success', { 
              detail: { 
                formSlug: 'preferences-update', 
                data: { email, preferences } 
              } 
            });
            document.dispatchEvent(analyticsEvent);
          } catch (err) {
            console.error('Error dispatching analytics event:', err);
          }

          // Redirect to thank you page after a short delay
          setTimeout(() => {
            window.location.href = 'https://activeaway.com/thanks-for-confirming';
          }, 1500);
        } else {
          showError(data.error || 'Something went wrong. Please try again.');
        }
      } catch (error) {
        console.error('Preferences update error:', error);
        showError('Network error. Please check your connection and try again.');
      } finally {
        submitButton.disabled = false;
        buttonText.textContent = 'Save Preferences';
        
        // Reset Turnstile if available
        try {
          if (typeof window.turnstile !== 'undefined' && window.turnstile) {
            window.turnstile.reset();
          }
        } catch (err) {
          console.warn('Could not reset Turnstile:', err);
        }
      }
    });

    function showSuccess() {
      successMessage.classList.remove('hidden');
      errorMessage.classList.add('hidden');
    }

    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      successMessage.classList.add('hidden');
    }

    function hideMessages() {
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
    }
  });
</script>

<style>
  .font-inter {
    font-family: 'Inter', sans-serif;
  }
  
  .font-playfair {
    font-family: 'Playfair Display', serif;
  }

  /* Custom checkbox styling */
  input[type="checkbox"] {
    accent-color: #ad986c;
  }

  input[type="checkbox"]:checked {
    background-color: #ad986c;
    border-color: #ad986c;
  }
</style>
