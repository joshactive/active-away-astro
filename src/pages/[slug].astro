---
// Dynamic Product Page - Handles all product category pages (Adult Tennis Holidays, Padel, etc.)
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import ProductHeroTailwind from '../components/ProductHeroTailwind.astro';
import QuoteSectionTailwind from '../components/QuoteSectionTailwind.astro';
import JamieMurrayTailwind from '../components/JamieMurrayTailwind.astro';
import ScheduleTableTailwind from '../components/ScheduleTableTailwind.astro';
import DiscountCTATailwind from '../components/DiscountCTATailwind.astro';
import StoriesOfHopeTailwind from '../components/StoriesOfHopeTailwind.astro';
import LocationsTailwind from '../components/LocationsTailwind.astro';
import FAQAccordionTailwind from '../components/FAQAccordionTailwind.astro';
import OurPartnersTailwind from '../components/OurPartnersTailwind.astro';
import TwoColumnContentTailwind from '../components/TwoColumnContentTailwind.astro';
import KeyInformationTailwind from '../components/KeyInformationTailwind.astro';
import BasicStaticPageTailwind from '../components/BasicStaticPageTailwind.astro';
import PageHeroTailwind from '../components/PageHeroTailwind.astro';
import BreadcrumbsTailwind from '../components/BreadcrumbsTailwind.astro';
import SalesLandingPageTailwind from '../components/SalesLandingPageTailwind.astro';
import { 
  getProductPages, 
  getProductPageBySlug, 
  getProductPageSEO, 
  getHomeData, 
  getBasicStaticPages, 
  getBasicStaticPageBySlug,
  getSalesLandingPages,
  getSalesLandingPageBySlug
} from '../utils/strapi.js';

// Generate static paths for all pages (product pages + static pages)
export async function getStaticPaths() {
  try {
    const paths = [];
    
    // Get product pages
    const productPages = await getProductPages();
    if (productPages && productPages.length > 0) {
      productPages.forEach(page => {
        paths.push({
          params: { slug: page.slug },
          props: { pageSlug: page.slug, pageType: 'product' }
        });
      });
      console.log(`üì¶ [pages] Added ${productPages.length} product pages`);
    }
    
    // Get static pages
    const staticPages = await getBasicStaticPages();
    if (staticPages && staticPages.length > 0) {
      staticPages.forEach(page => {
        paths.push({
          params: { slug: page.slug },
          props: { pageSlug: page.slug, pageType: 'static' }
        });
      });
      console.log(`üìÑ [pages] Added ${staticPages.length} static pages`);
    }
    
    // Get sales landing pages
    const landingPages = await getSalesLandingPages();
    if (landingPages && landingPages.length > 0) {
      landingPages.forEach(page => {
        paths.push({
          params: { slug: page.slug },
          props: { pageSlug: page.slug, pageType: 'sales-landing' }
        });
      });
      console.log(`üéØ [pages] Added ${landingPages.length} landing pages`);
    }
    
    console.log(`üì¶ [pages] Generating ${paths.length} total pages`);
    return paths;
  } catch (error) {
    console.error('‚ùå [pages] Error generating static paths:', error);
    return [];
  }
}

const { slug } = Astro.params;
const { pageSlug } = Astro.props;

// Try fetching product page first
let productData = null;
let staticPageData = null;
let landingPageData = null;

try {
  productData = await getProductPageBySlug(slug || pageSlug);
  if (productData) {
    console.log(`üì¶ [page] Product page data fetched: ${productData.title}`);
  }
} catch (error) {
  console.error(`‚ùå [page] Error fetching product page:`, error.message);
}

// If no product page found, try static page
if (!productData) {
  try {
    staticPageData = await getBasicStaticPageBySlug(slug || pageSlug);
    if (staticPageData) {
      console.log(`üìÑ [page] Static page data fetched: ${staticPageData.title}`);
    }
  } catch (error) {
    console.error(`‚ùå [page] Error fetching static page:`, error.message);
  }
}

// If still nothing, try sales landing page
if (!productData && !staticPageData) {
  try {
    landingPageData = await getSalesLandingPageBySlug(slug || pageSlug);
    if (landingPageData) {
      console.log(`üéØ [page] Sales landing page data fetched: ${landingPageData.title}`);
    }
  } catch (error) {
    console.error(`‚ùå [page] Error fetching sales landing page:`, error.message);
  }
}

// Fetch SEO data separately
let seoData = null;
try {
  seoData = await getProductPageSEO(slug || pageSlug);
  if (seoData) {
    console.log(`üìÑ [product-page] SEO data fetched for: ${slug}`);
  }
} catch (error) {
  console.warn(`‚ö†Ô∏è  [product-page] Could not fetch SEO data for ${slug}:`, error.message);
}

// Fetch homepage data for partners
let homepageData = null;
try {
  homepageData = await getHomeData();
  console.log(`üè† [product-page] Homepage data fetched for partners`);
} catch (error) {
  console.warn(`‚ö†Ô∏è  [product-page] Could not fetch homepage data:`, error.message);
}

// If nothing found, return 404
if (!productData && !staticPageData && !landingPageData) {
  return Astro.redirect('/404');
}

// Determine which type of page we're rendering
const isStaticPage = !!staticPageData && !productData;
const isLandingPage = !!landingPageData && !productData && !staticPageData;

// Extract SEO fields with fallbacks (handle both page types)
const pageTitle = seoData?.metaTitle 
  || productData?.seo?.metaTitle 
  || staticPageData?.seo?.metaTitle 
  || landingPageData?.seo?.metaTitle 
  || productData?.title 
  || staticPageData?.title 
  || landingPageData?.title
  || 'Page';
  
const pageDescription = seoData?.metaDescription 
  || productData?.seo?.metaDescription 
  || staticPageData?.seo?.metaDescription 
  || landingPageData?.seo?.metaDescription 
  || productData?.hero?.subheading 
  || landingPageData?.hero?.subheading
  || 'Explore our products and services.';

// Extract meta image URL properly (handle both page types)
let metaImage = null;
if (seoData?.metaImage) {
  metaImage = typeof seoData.metaImage === 'string' ? seoData.metaImage : seoData.metaImage.url;
} else if (productData?.seo?.metaImage) {
  metaImage = typeof productData.seo.metaImage === 'string' ? productData.seo.metaImage : productData.seo.metaImage.url;
} else if (staticPageData?.seo?.metaImage) {
  metaImage = typeof staticPageData.seo.metaImage === 'string' ? staticPageData.seo.metaImage : staticPageData.seo.metaImage.url;
} else if (landingPageData?.seo?.metaImage) {
  metaImage = landingPageData.seo.metaImage;
}

const metaImageAlt = seoData?.metaImageAlt || productData?.seo?.metaImageAlt || staticPageData?.seo?.metaImageAlt || landingPageData?.seo?.metaImageAlt || null;
const metaImageWidth = seoData?.metaImageWidth || productData?.seo?.metaImageWidth || staticPageData?.seo?.metaImageWidth || landingPageData?.seo?.metaImageWidth || null;
const metaImageHeight = seoData?.metaImageHeight || productData?.seo?.metaImageHeight || staticPageData?.seo?.metaImageHeight || landingPageData?.seo?.metaImageHeight || null;
const keywords = seoData?.keywords || productData?.seo?.keywords || staticPageData?.seo?.keywords || landingPageData?.seo?.keywords || null;
const canonicalURL = seoData?.canonicalURL || productData?.seo?.canonicalURL || staticPageData?.seo?.canonicalURL || landingPageData?.seo?.canonicalURL || `https://activeaway.com/${slug}`;

// Prepare data for reusable components
const homeData = {
  jamieMurray: productData?.jamieMurray || null,
  partners: homepageData?.partners || [],
  stories: null // Will use Google reviews
};
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  {isStaticPage ? (
    <!-- Static Page Layout -->
    <>
      <!-- Page Hero -->
      {staticPageData?.pageHero && (
        <PageHeroTailwind pageData={staticPageData} />
      )}
      
      <!-- Breadcrumbs -->
      {staticPageData?.pageHero?.showBreadcrumbs !== false && (
        <BreadcrumbsTailwind 
          breadcrumbs={[
            { label: 'Home', href: '/' },
            { label: staticPageData.title }
          ]}
        />
      )}
      
      <!-- Static Page Content -->
      <BasicStaticPageTailwind staticPageData={staticPageData} />
    </>
  ) : isLandingPage ? (
    <SalesLandingPageTailwind pageData={landingPageData} homeData={homeData} />
  ) : (
    <!-- Product Page Layout -->
    <>
      <!-- Hero Section -->
      <ProductHeroTailwind productData={productData} />
  
  <!-- Quote Section -->
  {productData?.quote && (
    <QuoteSectionTailwind productData={productData} />
  )}
  
  <!-- Jamie Murray Section -->
  {productData?.jamieMurray && (
    <JamieMurrayTailwind homeData={homeData} />
  )}
  
  <!-- Two Column Content Section (Hosting / Tennis Standards) -->
  {productData?.twoColumnContent && (
    <TwoColumnContentTailwind productData={productData} />
  )}
  
  <!-- Key Information Section -->
  {productData?.keyInformation && productData?.keyInformation?.infoCards?.length > 0 && (
    <KeyInformationTailwind productData={productData} />
  )}
  
  <!-- Schedule/Itinerary Table -->
  {productData?.schedule && productData?.schedule?.scheduleRows?.length > 0 && (
    <ScheduleTableTailwind productData={productData} />
  )}
  
  <!-- Discount CTA Section -->
  {productData?.discount && (
    <DiscountCTATailwind productData={productData} />
  )}
  
  <!-- Testimonials/Stories Section -->
  <StoriesOfHopeTailwind homeData={homeData} customTitle="Our Online Reviews" customSubtitle="Have you ever seen reviews like these?" />
  
  <!-- Destinations/Locations Section -->
  {productData?.destinations?.showDestinations !== false && (
    <LocationsTailwind 
      customHeading={productData?.destinations?.heading || `${productData.title} Locations`}
      customEyebrow={productData?.destinations?.eyebrow}
      featuredSlugs={productData?.destinations?.featuredLocationSlugs}
    />
  )}
  
  <!-- FAQ Section -->
  {productData?.faq && productData?.faq?.faqs?.length > 0 && (
    <FAQAccordionTailwind productData={productData} />
  )}
  
  <!-- Partners Section -->
  <OurPartnersTailwind homeData={homeData} />
    </>
  )}
</BaseLayout>

