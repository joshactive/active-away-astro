---
// Dynamic Blog Post Page
export const prerender = true;

import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getAllBlogPosts, getBlogBySlug, getBlogSEO } from '../../../utils/strapi.js';
import { marked } from 'marked';

// Configure marked
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: true,
  mangle: false
});

// Helper function to extract H2 headers from markdown for table of contents
function extractH2Headers(markdown) {
  if (!markdown) return [];
  
  const headers = [];
  const h2Regex = /^##\s+(.+)$/gm;
  let match;
  
  while ((match = h2Regex.exec(markdown)) !== null) {
    const text = match[1].trim();
    // Create a slug from the header text
    const slug = text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '');
    
    headers.push({
      text: text,
      slug: slug
    });
  }
  
  return headers;
}

// Helper function to add IDs to H2 headers in HTML
function addHeaderIds(html) {
  if (!html) return html;
  
  return html.replace(/<h2>(.*?)<\/h2>/gi, (match, headerText) => {
    const text = headerText.trim();
    const slug = text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '');
    
    return `<h2 id="${slug}">${headerText}</h2>`;
  });
}

// Helper function to parse YouTube URLs and convert to embeds
function parseYouTubeLinks(html) {
  if (!html) return html;
  
  // Match paragraph tags containing only a YouTube URL
  const paragraphYoutubeRegex = /<p>\s*(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:[&?][\w=&]*)?\s*<\/p>/gi;
  
  // Replace paragraph-wrapped YouTube URLs with embedded player
  html = html.replace(paragraphYoutubeRegex, (match, videoId) => {
    return `
      <div class="youtube-embed-wrapper">
        <iframe
          src="https://www.youtube.com/embed/${videoId}"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          loading="lazy"
        ></iframe>
      </div>
    `;
  });
  
  // Also match anchor tags with YouTube URLs
  const linkYoutubeRegex = /<a[^>]*href=["'](?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:[&?][\w=&]*)?["'][^>]*>.*?<\/a>/gi;
  
  html = html.replace(linkYoutubeRegex, (match, videoId) => {
    return `
      <div class="youtube-embed-wrapper">
        <iframe
          src="https://www.youtube.com/embed/${videoId}"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          loading="lazy"
        ></iframe>
      </div>
    `;
  });
  
  return html;
}

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const blogPosts = await getAllBlogPosts();
  
  return blogPosts.map((post) => ({
    params: { 
      categorySlug: post.categorySlug,
      slug: post.slug 
    },
    props: { 
      categorySlug: post.categorySlug,
      slug: post.slug,
      id: post.id,
      documentId: post.documentId
    }
  }));
}

const { categorySlug, slug } = Astro.params;
const { id, documentId } = Astro.props;
const fallbackIdentifiers = { id, documentId };
console.log(`üìù [blog/${categorySlug}/${slug}] Static props identifiers:`, fallbackIdentifiers);

// Fetch the blog post data
let blogData = null;
try {
  blogData = await getBlogBySlug(categorySlug, slug, fallbackIdentifiers);
  if (blogData) {
    console.log(`üìù [blog/${categorySlug}/${slug}] Blog post fetched successfully`);
  } else {
    console.warn(`üìù [blog/${categorySlug}/${slug}] Blog post not found after lookup`);
  }
} catch (error) {
  console.error(`[blog/${categorySlug}/${slug}] Error fetching blog post:`, error.message);
}

// If no data found, show 404
if (!blogData) {
  return Astro.redirect('/404');
}

// SEPARATE API CALL: Fetch SEO data with metaImage
try {
  const seoData = await getBlogSEO(categorySlug, slug);
  if (seoData) {
    blogData.seo = seoData;
    console.log(`üìÑ [blog/${categorySlug}/${slug}] SEO data merged: ${seoData.metaTitle || 'No title'}, metaImage: ${seoData.metaImage ? 'Yes' : 'No'}`);
  }
} catch (error) {
  console.error(`[blog/${categorySlug}/${slug}] Error fetching SEO data:`, error.message);
}

// Extract data with fallbacks
const pageTitle = blogData.title || 'Blog Post';
const content = blogData.content || '';
const excerpt = blogData.blogExcerpt || '';
const author = blogData.authorFullName || 'Active Away';
const date = blogData.formattedDate || '';
const categoryName = blogData.categoryName || '';

// Extract H2 headers for table of contents
const tocHeaders = extractH2Headers(content);

// Extract SEO fields
const metaTitle = blogData.seo?.metaTitle || `${pageTitle} | Active Away Blog`;
const metaDescription = blogData.seo?.metaDescription || excerpt || `Read ${pageTitle} on the Active Away blog.`;
const metaImage = blogData.seo?.metaImage || blogData.headerImage?.url || null;
const metaImageAlt = blogData.seo?.metaImageAlt || blogData.headerImage?.alt || pageTitle;
const metaImageWidth = blogData.seo?.metaImageWidth || null;
const metaImageHeight = blogData.seo?.metaImageHeight || null;
const keywords = blogData.seo?.keywords || null;
const canonicalURL = blogData.seo?.canonicalURL || `https://activeaway.com/blog/${categorySlug}/${slug}`;

// Hero content
const heroBackgroundImage = blogData.headerImage?.url || 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/45b69090-1c22-46cd-7f98-086ba71efc00/public';
const heroBackgroundImageAlt = blogData.headerImage?.alt || pageTitle;
---

<BaseLayout 
  title={metaTitle}
  description={metaDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section -->
  <section class="relative w-full h-[300px] sm:h-[400px] lg:h-[500px] overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-[#0D1C4E]/75 to-[#0D1C4E]/60 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt={heroBackgroundImageAlt}
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <h1 class="text-4xl sm:text-5xl lg:text-7xl font-playfair font-bold text-white mb-6 sm:mb-8 leading-tight max-w-4xl">
        {pageTitle}
      </h1>
    </div>
  </section>

  <!-- Metadata Bar -->
  <section class="w-full bg-gray-50 py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <div class="flex flex-wrap items-center gap-3 text-sm font-inter text-gray-600">
        {date && (
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <time datetime={blogData.creationDate}>{date}</time>
          </span>
        )}
        {author && (
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>{author}</span>
          </span>
        )}
        {categoryName && (
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            <span>{categoryName}</span>
          </span>
        )}
      </div>
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="w-full bg-white py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <nav class="flex items-center space-x-2 text-sm font-inter overflow-x-auto">
        <a href="/" class="text-gray-600 hover:text-[#ad986c] transition-colors whitespace-nowrap">Home</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/blog" class="text-gray-600 hover:text-[#ad986c] transition-colors whitespace-nowrap">Blog</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        {categoryName && (
          <>
            <a href={`/blog/${categorySlug}`} class="text-gray-600 hover:text-[#ad986c] transition-colors whitespace-nowrap">{categoryName}</a>
            <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </>
        )}
        <span class="text-gray-900 font-medium truncate">{pageTitle}</span>
      </nav>
    </div>
  </section>

  <!-- Main Content -->
  <main class="w-full bg-white py-12 sm:py-16 lg:py-20">
    <div class="container mx-auto max-w-[900px] px-4 sm:px-10">
      
      <!-- Table of Contents -->
      {tocHeaders.length > 0 && (
        <div class="mb-12 bg-white border-2 border-gray-200 rounded-xl p-6 sm:p-8 shadow-sm">
          <h2 class="text-2xl font-playfair font-bold text-gray-900 mb-6">Contents</h2>
          <nav class="grid grid-cols-1 sm:grid-cols-2 gap-3" data-blog-toc>
            {tocHeaders.map((header) => (
              <a 
                href={`#${header.slug}`} 
                class="flex items-center gap-2 text-base font-inter text-gray-700 hover:text-[#ad986c] transition-colors py-2 px-3 rounded-lg hover:bg-gray-50"
              >
                <svg class="w-4 h-4 flex-shrink-0 text-[#ad986c]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                {header.text}
              </a>
            ))}
          </nav>
        </div>
      )}
      
      {content && (
        <article class="blog-content prose prose-lg max-w-none">
          <Fragment set:html={addHeaderIds(parseYouTubeLinks(marked.parse(content)))} />
        </article>
      )}

      {!content && (
        <div class="text-center py-12">
          <p class="text-gray-500 font-inter">No content available for this blog post.</p>
        </div>
      )}
      
    </div>
  </main>
</BaseLayout>

<style>
  .prose {
    color: #1f2937;
  }

  .blog-content :global(h1),
  .blog-content :global(h2),
  .blog-content :global(h3),
  .blog-content :global(h4),
  .blog-content :global(h5),
  .blog-content :global(h6) {
    font-family: 'Playfair Display', serif;
    color: #111827;
    font-weight: 700;
    line-height: 1.2;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .blog-content :global(h1) {
    font-size: clamp(2.25rem, 5vw, 3rem);
    border-bottom: 3px solid #ad986c;
    padding-bottom: 0.75rem;
  }

  .blog-content :global(h2) {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.5rem;
    scroll-margin-top: 2rem;
  }

  .blog-content :global(h3) {
    font-size: clamp(1.5rem, 3vw, 2rem);
  }

  .blog-content :global(h4) {
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
  }

  .blog-content :global(h5) {
    font-size: 1.125rem;
    color: #111827;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .blog-content :global(h6) {
    font-size: 1rem;
    color: #111827;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .blog-content :global(p) {
    margin-bottom: 1.25rem;
    line-height: 1.75;
    color: #1f2937;
    font-family: 'Inter', sans-serif;
  }

  .blog-content :global(ul),
  .blog-content :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1.25rem;
    font-family: 'Inter', sans-serif;
  }

  .blog-content :global(li) {
    margin-bottom: 0.5rem;
    line-height: 1.7;
  }

  .blog-content :global(strong) {
    color: #111827;
    font-weight: 600;
  }

  .blog-content :global(a) {
    color: #ad986c;
    text-decoration: underline;
    transition: color 0.2s ease;
  }

  .blog-content :global(a:hover) {
    color: #8d7a56;
  }

  .blog-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 2rem 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .blog-content :global(blockquote) {
    border-left: 4px solid #ad986c;
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #4b5563;
  }

  .blog-content :global(code) {
    background-color: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
  }

  .blog-content :global(pre) {
    background-color: #1f2937;
    color: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .blog-content :global(pre code) {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  .blog-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
  }

  .blog-content :global(th),
  .blog-content :global(td) {
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    text-align: left;
  }

  .blog-content :global(th) {
    background-color: #f9fafb;
    font-weight: 600;
  }

  .blog-content :global(hr) {
    border: none;
    border-top: 2px solid #e5e7eb;
    margin: 3rem 0;
  }

  /* YouTube embed responsive wrapper */
  .blog-content :global(.youtube-embed-wrapper) {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
    margin: 2rem 0;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .blog-content :global(.youtube-embed-wrapper iframe) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
  }

  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
  }
</style>

<script is:inline>
  if (typeof window !== 'undefined') {
    // Smooth scroll to section when clicking TOC links
    document.addEventListener('DOMContentLoaded', () => {
      const tocLinks = document.querySelectorAll('[data-blog-toc] a[href^="#"]');
      
      tocLinks.forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href')?.replace('#', '');
          if (!targetId) return;
          
          const targetElement = document.getElementById(targetId);
          if (!targetElement) return;
          
          targetElement.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
          
          // Update URL without scrolling
          if (history.pushState) {
            history.pushState(null, null, `#${targetId}`);
          }
        });
      });
    });
  }
</script>

