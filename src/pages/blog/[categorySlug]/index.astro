---
// Blog Category Archive Page
export const prerender = true;

import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getAllBlogPosts, getBlogsByCategory, formatCategorySlug, getBlogCategoryData, getBlogCategorySEO } from '../../../utils/strapi.js';
import { getStrapiImageAttrs } from '../../../utils/cloudflareImages.js';
import { marked } from 'marked';

// Configure marked
marked.setOptions({
  breaks: true,
  gfm: true
});

// Generate static paths for all blog categories
export async function getStaticPaths() {
  const allBlogPosts = await getAllBlogPosts();
  
  // Get unique category slugs
  const uniqueCategories = [...new Set(allBlogPosts.map(post => post.categorySlug))];
  
  return uniqueCategories.map((categorySlug) => ({
    params: { categorySlug },
    props: { categorySlug }
  }));
}

const { categorySlug } = Astro.params;
console.log(`üìù [blog/${categorySlug}] Fetching category archive...`);

// Fetch category-specific data from blog-page
let categoryData = null;
try {
  categoryData = await getBlogCategoryData(categorySlug);
  if (categoryData) {
    console.log(`üìù [blog/${categorySlug}] Category data fetched from blog-page`);
    console.log(`üìù [blog/${categorySlug}] Category image:`, categoryData.image);
  } else {
    console.log(`‚ö†Ô∏è [blog/${categorySlug}] No category data found in blog-page`);
  }
} catch (error) {
  console.error(`[blog/${categorySlug}] Error fetching category data:`, error.message);
}

// SEPARATE API CALL: Fetch category SEO data
try {
  const categorySEO = await getBlogCategorySEO(categorySlug);
  if (categorySEO && categoryData) {
    categoryData.seo = categorySEO;
    console.log(`üìÑ [blog/${categorySlug}] Category SEO data merged`);
  }
} catch (error) {
  console.error(`[blog/${categorySlug}] Error fetching category SEO:`, error.message);
}

// Fetch all blog posts for this category
let blogs = [];
try {
  blogs = await getBlogsByCategory(categorySlug, 0); // 0 = no limit, get all posts
  if (blogs) {
    console.log(`üìù [blog/${categorySlug}] Fetched ${blogs.length} blog posts`);
  }
} catch (error) {
  console.error(`[blog/${categorySlug}] Error fetching blogs:`, error.message);
}

// Use category data from Strapi or fall back to formatted slug
const categoryName = categoryData?.categoryName || formatCategorySlug(categorySlug);
const categoryTitle = categoryData?.title || `${categoryName} Blog`;

// SEO fields - use category SEO or fallbacks
const pageTitle = categoryData?.seo?.metaTitle || `${categoryTitle} | Active Away`;
const metaDescription = categoryData?.seo?.metaDescription || `Read the latest ${categoryName} articles and insights from Active Away.`;
const metaImage = categoryData?.seo?.metaImage || categoryData?.image?.url || null;
const metaImageAlt = categoryData?.seo?.metaImageAlt || categoryData?.image?.alt || categoryName;
const metaImageWidth = categoryData?.seo?.metaImageWidth || null;
const metaImageHeight = categoryData?.seo?.metaImageHeight || null;
const keywords = categoryData?.seo?.keywords || null;
const canonicalURL = categoryData?.seo?.canonicalURL || `https://activeaway.com/blog/${categorySlug}`;

// Hero image - use category image or fallback
const heroBackgroundImage = categoryData?.image?.url || 'https://activeaway.com/cdn-cgi/imagedelivery/-aT8Z2F9gGvZ9fdofZcCaQ/45b69090-1c22-46cd-7f98-086ba71efc00/public';
const heroBackgroundImageAlt = categoryData?.image?.alt || categoryName;

console.log(`üìù [blog/${categorySlug}] Using hero image:`, heroBackgroundImage);

// Blog card image configuration
const BLOG_IMAGE_SIZES = '(max-width: 640px) calc(100vw - 2.5rem), (max-width: 1024px) calc((100vw - 5rem) / 2), calc((100vw - 10rem) / 3)';
const BLOG_IMAGE_QUALITY = 60;
---

<BaseLayout 
  title={pageTitle}
  description={metaDescription}
  metaImage={metaImage}
  metaImageAlt={metaImageAlt}
  metaImageWidth={metaImageWidth}
  metaImageHeight={metaImageHeight}
  keywords={keywords}
  canonicalURL={canonicalURL}
>
  <!-- Hero Header Section -->
  <section class="relative w-full h-[300px] sm:h-[400px] lg:h-[450px] overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-[#0D1C4E]/75 to-[#0D1C4E]/60 z-10"></div>
    <img 
      src={heroBackgroundImage}
      alt={heroBackgroundImageAlt}
      class="absolute inset-0 w-full h-full object-cover"
      loading="eager"
    />
    
    <div class="relative z-20 container mx-auto max-w-[1400px] px-4 sm:px-10 h-full flex flex-col justify-center items-center text-center">
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-playfair font-bold text-white leading-tight max-w-4xl">
        {categoryTitle}
      </h1>
    </div>
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="w-full bg-gray-50 py-4 border-b border-gray-200">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      <nav class="flex items-center space-x-2 text-sm font-inter overflow-x-auto">
        <a href="/" class="text-gray-600 hover:text-[#ad986c] transition-colors whitespace-nowrap">Home</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/blog" class="text-gray-600 hover:text-[#ad986c] transition-colors whitespace-nowrap">Blog</a>
        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium whitespace-nowrap">{categoryName}</span>
      </nav>
    </div>
  </section>

  <!-- Blog Posts Grid -->
  <main class="w-full bg-white py-12 sm:py-16 lg:py-20">
    <div class="container mx-auto max-w-[1400px] px-4 sm:px-10">
      
      {blogs.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
          {blogs.map((blog) => {
            const imageUrl = blog.image;
            const imageAlt = blog.imageAlt || blog.title;
            
            // Get optimized image attributes
            const config = {
              displayWidth: 704,
              displayHeight: 256,
              fit: 'cover',
              sizes: BLOG_IMAGE_SIZES,
              alt: imageAlt,
              quality: BLOG_IMAGE_QUALITY
            };

            const imgAttrs = getStrapiImageAttrs({ url: imageUrl, alt: imageAlt }, config) || {
              src: imageUrl,
              url: imageUrl,
              alt: imageAlt,
              width: 704,
              height: 256,
              loading: 'lazy',
              sizes: BLOG_IMAGE_SIZES
            };
            
            return (
              <a 
                href={`/blog/${blog.categorySlug}/${blog.slug}`} 
                class="group bg-white border-2 border-gray-200 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl hover:border-[#ad986c] transition-all duration-300 hover:-translate-y-1 flex flex-col"
              >
                <!-- Card Image -->
                <div class="aspect-video overflow-hidden bg-gray-100 relative">
                  <img 
                    src={imgAttrs.src}
                    {...(imgAttrs.srcset && { srcset: imgAttrs.srcset })}
                    sizes={imgAttrs.sizes || BLOG_IMAGE_SIZES}
                    width={imgAttrs.width || 704}
                    height={imgAttrs.height || 256}
                    alt={imgAttrs.alt || imageAlt}
                    loading={imgAttrs.loading || 'lazy'}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>
                
                <!-- Card Content -->
                <div class="p-6 flex flex-col flex-grow">
                  <!-- Tags -->
                  <div class="flex flex-wrap gap-2 mb-3">
                    <span class="px-3 py-1 bg-[#ad986c]/10 text-[#ad986c] text-xs font-inter font-semibold rounded-full">{blog.author}</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-inter font-medium rounded-full">{blog.date}</span>
                  </div>

                  <!-- Title -->
                  <h2 class="text-xl font-playfair font-semibold text-gray-900 mb-3 group-hover:text-[#ad986c] transition-colors leading-tight line-clamp-2">
                    {blog.title}
                  </h2>
                  
                  <!-- Description -->
                  <p class="text-base font-inter text-gray-800 leading-relaxed mb-4 line-clamp-3 flex-grow">
                    {blog.description}
                  </p>

                  <!-- Read More Arrow -->
                  <div class="flex items-center gap-2 text-[#ad986c] font-inter font-semibold text-sm group-hover:gap-3 transition-all mt-auto">
                    <span>Read More</span>
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-gray-500 font-inter text-lg mb-4">No blog posts found in this category yet.</p>
          <a href="/blog" class="inline-flex items-center gap-2 text-[#ad986c] font-inter font-medium hover:underline">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span>Back to all categories</span>
          </a>
        </div>
      )}
      
    </div>
  </main>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

